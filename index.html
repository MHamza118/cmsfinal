<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FSPro</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="firebase.js"></script>
    <style>
        .missed-checkins-section {
            margin-top: 30px;
            border-top: 1px solid #ccc;
            padding-top: 20px;
        }

        .notification-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }

        .notification-btn:hover {
            background-color: #45a049;
        }

        .status-sent {
            color: #666;
            font-style: italic;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th,
        td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .status-pending {
            color: #f39c12;
            font-weight: bold;
        }
        .status-approved {
            color: #27ae60;
            font-weight: bold;
        }
        .status-rejected {
            color: #c0392b;
            font-weight: bold;
        }
        .status-uninformed {
            color: #e74c3c;
            font-weight: bold;
            text-decoration: underline;
        }
        .filter-section {
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .filter-section span {
            font-weight: bold;
            color: #333;
        }
        .filter-section select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
            min-width: 120px;
            cursor: pointer;
        }
        .filter-section select:hover {
            border-color: #aaa;
        }
        .filter-section select:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        .approve-btn,
        .reject-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        .approve-btn {
            background-color: #27ae60;
            color: white;
        }
        .reject-btn {
            background-color: #e74c3c;
            color: white;
        }
        .approve-btn:hover {
            background-color: #219a52;
        }
        .reject-btn:hover {
            background-color: #c0392b;
        }
        #adminHolidays h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 24px;
        }
        .no-requests {
            text-align: center;
            color: #666;
            padding: 20px;
            font-style: italic;
        }
        .notification-icon {
            font-size: 24px;
            cursor: pointer;
            position: relative;
            margin-left: 20px;
        }
        .notification-icon .badge {
            position: absolute;
            top: -5px;
            right: -10px;
            background-color: red;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 12px;
        }
        #notificationPopup {
            display: none;
            position: absolute;
            background-color: white;
            border: 1px solid #ddd;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 10px;
            z-index: 1000;
            width: 200px;
        }
        .summary-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .summary-row {
            display: flex;
            justify-content: space-between;
            gap: 20px;
        }
        .summary-item {
            flex: 1;
            text-align: center;
        }
        .summary-item h4 {
            margin: 0;
            color: #495057;
            font-size: 14px;
        }
        .summary-item p {
            margin: 0;
            font-size: 24px;
            font-weight: bold;
            color: #0d6efd;
        }
        .summary-row.values .summary-item {
            padding: 10px;
            background-color: white;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .download-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .download-btn:hover {
            background-color: #45a049;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
        }
        .modal-content {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            width: 90%;
            max-width: 600px;
        }
        .modal-content .close {
            position: absolute;
            right: 20px;
            font-size: 33px;
            font-weight: bold;
            color: white;
            cursor: pointer;
            line-height: 1;
            background-color: #e74c3c;
            border-radius: 20%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding-top: 2px;
        }
        .modal-content .close:hover {
            background-color: #c0392b;
        }
        .modal-content h2 {
            margin-top: 0;
            color: #2c3e50;
            margin-bottom: 20px;
        }
        .modal-content table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        .modal-content th {
            background: linear-gradient(135deg, #2596be 0%, #1c7593 100%);
            color: white !important;
            font-weight: 600 !important;
            padding: 16px !important;
            text-align: left;
        }
        .modal-content td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }
        .modal-content tr:last-child td {
            border-bottom: none;
        }
        .modal-content input[type="time"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
        }
        .modal-content button {
            background: linear-gradient(135deg, #2596be 0%, #1c7593 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            margin-top: 10px;
        }
        .holiday-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            z-index: 1001;
            width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .holiday-modal .section-header {
            padding-bottom: 15px;
            margin-bottom: 20px;
            background: linear-gradient(135deg, #2596be 0%, #1c7593 100%);
            margin: -20px -20px 20px -20px;
            padding: 20px;
            border-radius: 8px 8px 0 0;
            color: white;
            position: relative;
        }
        .holiday-modal .section-header h2 {
            color: white;
            font-size: 1.5em;
            margin: 0;
            font-weight: 600;
        }
        .holiday-modal .close-btn {
            position: absolute;
            right: 20px;
            top: 20px;
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            opacity: 0.8;
        }
        .holiday-modal .close-btn:hover {
            opacity: 1;
        }
        .main-content {
            overflow-y: auto;
            height: calc(100vh - 100px);
        }
        #timeTableContent {
            overflow-y: auto;
            max-height: 600px;
        }
        .edit-btn {
            background: #2596be;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
        }
        .edit-btn:hover {
            background: #1c7593;
        }
        .weekly-summary-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .weekly-summary-table th,
        .weekly-summary-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        .weekly-summary-table th {
            background-color: #1c7593;
            color: white;
        }
        .weekly-summary-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .weekly-summary-table tr:hover {
            background-color: #f5f5f5;
        }
        .weekly-summary-table select.time-select {
            width: 100px;
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
        }
        .weekly-summary-table select.time-select:hover {
            border-color: #1c7593;
        }
        .weekly-summary-table select.time-select:focus {
            outline: none;
            border-color: #1c7593;
            box-shadow: 0 0 3px rgba(28, 117, 147, 0.3);
        }
        @media screen and (max-width: 768px) {
            .weekly-summary-table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
            .weekly-summary-table select.time-select {
                width: 80px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage">
        <div class="login-container">
            <h1>FSPro Login</h1>
            <input type="text" id="userName" placeholder="Username" />
            <div class="password-field">
            <input type="password" id="userPassword" placeholder="Password" />
                <span class="password-toggle" onclick="togglePasswordVisibility()">
                    <i class="fas fa-eye"></i>
                </span>
            </div>
            <button id="loginBtn">Login</button>
        </div>
    </div>
    <!-- Employee Page -->
    <div id="employeePage" style="display: none">
        <div class="header">
            <div class="logo">FSPro</div>
            <div class="select-employee">
                <span id="currentDate"></span>
                <span id="currentTime"></span>
                <div class="notification-icon" onclick="toggleNotificationPopup()">
                    <i class="fas fa-bell"></i>
                    <span class="badge" id="notificationCount">0</span>
                </div>
                <div id="notificationPopup">
                    <h4>Notifications</h4>
                    <div id="notificationList"></div>
                </div>
            </div>
        </div>
        <div class="summary-section">
            <div class="summary-row headings">
                <div class="summary-item">
                    <h4>Total Check-Ins</h4>
                </div>
                <div class="summary-item">
                    <h4>Total Check-Outs</h4>
                </div>
                <div class="summary-item">
                    <h4>Late Check-Ins</h4>
                </div>
                <div class="summary-item">
                    <h4>Total Absences</h4>
                </div>
                <div class="summary-item">
                    <h4>Unapproved Leaves</h4>
                </div>
            </div>
            <div class="summary-row values">
                <div class="summary-item">
                    <p id="totalCheckIns">0</p>
                </div>
                <div class="summary-item">
                    <p id="totalCheckOuts">0</p>
                </div>
                <div class="summary-item">
                    <p id="lateCheckIns">0</p>
                </div>
                <div class="summary-item">
                    <p id="totalAbsences">0</p>
                </div>
                <div class="summary-item">
                    <p id="unapprovedLeaves">0</p>
                </div>
            </div>
        </div>
        <!-- Employee Page Hamburgur menu icon MOBILE RESPONSIVENESS -->
        <div class="container">
            <div class="hamburger-menu" onclick="toggleMobileMenu()">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <div class="sidebar-overlay" onclick="closeMobileMenu()"></div>
            <div class="left-sidebar">
                <button onclick="showSection('attendance'); closeMobileMenu()">Check In/Out</button>
                <button onclick="showSection('progress'); closeMobileMenu()">Daily Progress Report</button>
                <button onclick="openHolidayRequest(); closeMobileMenu()">Request for Holiday</button>
                <button onclick="openTimeTableModal(); closeMobileMenu()">Time Table</button>
                <button onclick="showSection('employeeTasks'); closeMobileMenu()">View Tasks</button>
                <button onclick="openCompensateHoursModal(); closeMobileMenu();">Compensate Hours</button>
                <button onclick="logout()">Logout</button>
            </div>
            <div id="modalOverlay" onclick="closeTimeTableModal()"></div>
            <div class="modal-content" id="timeTableContent">
                <span class="close" onclick="closeTimeTableModal()"><i class="fa-solid fa-xmark"></i></span>
                <h2>Set Your Time Table</h2>
                <div class="timetable-day-container">
                    <div class="day-heading">Monday</div>
                    <div id="mondaySlots" class="time-slots">
                        <div class="time-slot-row">
                            <input type="time" class="time-input" />
                            <input type="time" class="time-input" />
                            <button class="remove-slot" onclick="removeTimeSlot(this)">×</button>
                        </div>
                    </div>
                    <button class="add-slot-btn" onclick="addTimeSlot('monday')">+ Add Time Slot</button>
                    <div class="day-heading">Tuesday</div>
                    <div id="tuesdaySlots" class="time-slots">
                        <div class="time-slot-row">
                            <input type="time" class="time-input" />
                            <input type="time" class="time-input" />
                            <button class="remove-slot" onclick="removeTimeSlot(this)">×</button>
                        </div>
                    </div>
                    <button class="add-slot-btn" onclick="addTimeSlot('tuesday')">+ Add Time Slot</button>
                    <div class="day-heading">Wednesday</div>
                    <div id="wednesdaySlots" class="time-slots">
                        <div class="time-slot-row">
                            <input type="time" class="time-input" />
                            <input type="time" class="time-input" />
                            <button class="remove-slot" onclick="removeTimeSlot(this)">×</button>
                        </div>
                    </div>
                    <button class="add-slot-btn" onclick="addTimeSlot('wednesday')">+ Add Time Slot</button>
                    <div class="day-heading">Thursday</div>
                    <div id="thursdaySlots" class="time-slots">
                        <div class="time-slot-row">
                            <input type="time" class="time-input" />
                            <input type="time" class="time-input" />
                            <button class="remove-slot" onclick="removeTimeSlot(this)">×</button>
                        </div>
                    </div>
                    <button class="add-slot-btn" onclick="addTimeSlot('thursday')">+ Add Time Slot</button>
                    <div class="day-heading">Friday</div>
                    <div id="fridaySlots" class="time-slots">
                        <div class="time-slot-row">
                            <input type="time" class="time-input" />
                            <input type="time" class="time-input" />
                            <button class="remove-slot" onclick="removeTimeSlot(this)">×</button>
                        </div>
                    </div>
                    <button class="add-slot-btn" onclick="addTimeSlot('friday')">+ Add Time Slot</button>
                    <div class="day-heading">Saturday</div>
                    <div id="saturdaySlots" class="time-slots">
                        <div class="time-slot-row">
                            <input type="time" class="time-input" />
                            <input type="time" class="time-input" />
                            <button class="remove-slot" onclick="removeTimeSlot(this)">×</button>
                        </div>
                    </div>
                    <button class="add-slot-btn" onclick="addTimeSlot('saturday')">+ Add Time Slot</button>
                </div>
                <button class="save-timetable-btn" onclick="saveTimeTable()">Save Changes</button>
            </div>
            <div class="main-content">
                <div class="employee-header" id="employeeHeader">
                    <p id="employeeDetails">Hamza | ID: 118</p>
                    <div class="action-buttons">
                        <button onclick="handleCheckIn()">Check In</button>
                        <button onclick="handleCheckOut()">Check Out</button>
                        <button id="lateCheckInBtn" onclick="handleLateCheckIn()">Add Late Check-In</button>
                    </div>
                </div>
                <!-- Compensate Hours Modal -->
                <div id="compensateHoursModal" class="modal-content compensation-popup"
                    style="display: none; max-width: 600px">
                    <span class="close" onclick="closeCompensateHoursModal()"><i class="fa-solid fa-xmark"></i></span>
                    <h2>Compensate Working Hours</h2>
                    <!-- Missed working hours section -->
                    <div class="section-header-small">
                        <h3>Missed Working Hours</h3>
                    </div>
                    <div class="time-table-row">
                        <div id="missedWorkingHoursInfo" class="missed-hours-container">
                            <table class="compensate-table">
                                <tr>
                                    <th>Day</th>
                                    <th>Date</th>
                                    <th>Scheduled Hours</th>
                                </tr>
                                <tr>
                                    <td id="missedDay">-</td>
                                    <td id="missedDate">-</td>
                                    <td>
                                        <select id="missedHoursSelect" style="width: 100%; padding: 8px">
                                            <option value="">No scheduled slots found</option>
                                        </select>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="compensateMissedDay">Select missed working day</label>
                        <select id="compensateMissedDay" required onchange="updateMissedWorkingInfo()">
                            <option value="" disabled selected>
                                Select missed working day
                            </option>
                            <option value="monday">Monday</option>
                            <option value="tuesday">Tuesday</option>
                            <option value="wednesday">Wednesday</option>
                            <option value="thursday">Thursday</option>
                            <option value="friday">Friday</option>
                            <option value="saturday">Saturday</option>
                        </select>
                    </div>
                    <div class="section-header-small">
                        <h3>Select Compensation Date</h3>
                    </div>
                    <div class="form-group">
                        <label for="compensateDate">Date for Compensation</label>
                        <input type="date" id="compensateDate" required placeholder="Compensation Date" onchange="updateCompensateDay()" />
                    </div>
                    <div class="form-group">
                        <label for="compensateDay">Day</label>
                        <input type="text" id="compensateDay" readonly placeholder="Day" />
                    </div>
                    <div class="section-header-small">
                        <h3>Compensation Hours</h3>
                    </div>
                    <div class="time-table-row">
                        <div class="form-group">
                            <label for="compensateCheckIn">Check-in Time</label>
                            <input type="time" id="compensateCheckIn" required placeholder="Check-in Time" />
                        </div>
                        <div class="form-group">
                            <label for="compensateCheckOut">Check-out Time</label>
                            <input type="time" id="compensateCheckOut" required placeholder="Check-out Time" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="compensateReason">Reason for Compensation</label>
                        <textarea id="compensateReason" rows="3" required
                            placeholder="Please provide a reason for compensation"></textarea>
                    </div>
                    <button class="save-timetable" onclick="submitCompensation()">Submit Compensation</button>
                </div>
                <!-- Attendance Section -->
                <div id="attendance-section" class="section" style="display: block">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Day</th>
                                <th>Check-In Time</th>
                                <th>Check-Out Time</th>
                                <th>Late Check-Ins</th>
                            </tr>
                        </thead>
                        <tbody id="attendanceTable"></tbody>
                    </table>
                </div>
                <!-- Progress Section -->
                <div id="progress-section" class="section" style="display: none">
                    <h2>Submit Daily Progress</h2>
                    <div class="form-group">
                        <textarea id="progressMessage" rows="4" required placeholder="Enter your progress details here..."></textarea>
                    </div>
                    <div class="file-upload-container">
                        <label for="progressFile" class="file-upload-label">
                            <span class="file-icon">📎</span>
                            <span>Attach File</span>
                            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24' height='24'%3E%3Cpath fill='%234CAF50' d='M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z'/%3E%3C/svg%3E"id="fileUploadedIcon" style="display: none; margin-left: 5px; vertical-align: middle;" alt="File uploaded" />
                        </label>
                        <input type="file" id="progressFile" hidden onchange="handleFileSelect(this)" />
                        <span id="fileName"></span>
                    </div>
                    <div class="submit-container">
                        <button onclick="submitProgress()" class="submit-progress">Submit Progress</button>
                    </div>
                    <div id="progressList">
                        <h3>Your Previous Reports</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Time</th>
                                    <th>Details</th>
                                    <th>File</th>
                                    <th>Status</th>
                                    <th>Admin Remarks</th>
                                </tr>
                            </thead>
                            <tbody id="employeeProgressTable"></tbody>
                        </table>
                    </div>
                </div>
                <!-- Holiday Requests Section -->
                <div id="holidayRequests" class="section" style="display: none">
                    <h2>Your Holiday Requests</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Start Date</th>
                                <th>End Date</th>
                                <th>Days</th>
                                <th>Reason</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="employeeHolidayRequestsTable"></tbody>
                    </table>
                </div>
                <!-- Employee Tasks Section -->
                <div id="employeeTasks-section" class="section" style="display: none">
                    <h2>My Tasks:</h2>
                    <h4>Complete the Assigned Tasks for the Day.</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Day</th>
                                <th>Description</th>
                                <th>File</th>
                                <th>Status</th>
                                <th>Reason</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="employeeTasksTable"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <!-- Admin Page -->
    <div id="adminPage" style="display: none">
        <div class="header">
            <div class="logo">FSPro Admin</div>
            <div class="admin-controls">
                <select id="adminUserSelect" onchange="handleUserSelect()">
                    <option value="">Select Employee</option>
                    <option value="hamza">Hamza</option>
                    <option value="zain">Zain</option>
                    <option value="hanzallah">Hanzallah</option>
                </select>
                <button id="addEmployeeBtn" onclick="openAddEmployeeModal()" style="background: white">Add Employee</button>
                <button id="uninformedLeaveBtn" onclick="addUninformedLeave()" style="background: white">Uninformed Leave</button>
            </div>
            <!-- Add Employee Modal -->
            <div id="addEmployeeModal" class="modal">
                <div class="modal-content" id="addEmployeeContent" style="display: block; max-width: 500px">
                    <span class="close" onclick="closeAddEmployeeModal()"><i class="fa-solid fa-xmark"></i></span>
                    <h2>Add New Employee</h2>
                    <div class="form-group">
                        <label for="newUsername"></label>
                        <input type="text" id="newUsername" placeholder="Enter username" />
                    </div>
                    <div class="form-group">
                        <label for="newPassword"></label>
                        <input type="password" id="newPassword" placeholder="Enter password" />
                    </div>
                    <div class="form-group">
                        <label for="newEmployeeId"></label>
                        <input type="text" id="newEmployeeId" placeholder="Enter employee ID" />
                    </div>
                    <div class="form-group">
                        <label for="newEmployeePhone"></label>
                        <input type="text" id="newEmployeePhone" placeholder="Phone Number (with country code)" />
                    </div>
                    <div class="form-group">
                        <label for="newEmployeeEmail"></label>
                        <input type="email" id="newEmployeeEmail" placeholder="Enter employee email" />
                    </div>
                    <div style="display: flex; gap: 10px">
                        <button onclick="addNewEmployee()">Add Employee</button>
                        <button onclick="deleteEmployee()">Delete Employee</button>
                    </div>
                    <div class="form-group" style="margin-top: 20px">
                        <label for="deleteEmployeeSelect"></label>
                        <select id="deleteEmployeeSelect" style=" width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="">Select an employee</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        <!--  Admin Page Hamburger Menu FOR MOBILE RESPONSIVENESS-->
        <div class="container">
            <div class="hamburger-menu" onclick="toggleAdminMobileMenu()">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <div class="sidebar-overlay" onclick="closeAdminMobileMenu()"></div>
            <div class="left-sidebar">
                <div class="main-buttons">
                    <button onclick="showAdminSection('adminAttendance'); closeAdminMobileMenu();" class="active">Attendance</button>
                    <button onclick="showAdminSection('weeklyAttendance'); closeAdminMobileMenu();">Weekly Attendance Summary</button>
                    <button onclick="showAdminSection('adminProgress'); closeAdminMobileMenu();">Progress Reports</button>
                    <button onclick="showAdminSection('adminHolidays'); closeAdminMobileMenu();">Holiday Requests</button>
                    <button onclick="showAdminSection('adminTimeTable'); closeAdminMobileMenu();">View Time Table</button>
                    <button onclick="showAdminSection('adminTargets'); closeAdminMobileMenu();">Assign Tasks</button>
                    <button onclick="showAdminSection('adminCompensations'); closeAdminMobileMenu();">Compensation Records</button>
                    <button onclick="logout()">Logout</button>
                </div>
                <div class="bottom-buttons"></div>
            </div>
            <!--Admin Page main content Data-->
            <div class="main-content">
                <div id="adminCompensations" style="display: none">
                    <h2>Employee Compensation Records</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Employee</th>
                                <th>Missed Date</th>
                                <th>Missed Day</th>
                                <th>Compensation Date</th>
                                <th>Reason</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="adminCompensationsTable"></tbody>
                    </table>
                </div>
                <div class="main-content">
                    <div id="adminAttendance" style="display: block">
                        <h2>Employee Attendance</h2>
                        <select id="reportType" style=" padding: 8px; border-radius: 5px; background-color: #2596be; color: white;">
                            <option value="daily">Daily Report</option>
                            <option value="weekly">Weekly Report</option>
                            <option value="monthly">Monthly Report</option>
                        </select>
                        <button onclick="generateReport()" style="color: white; padding: 8px; border: 1px solid black"><i class="fa-solid fa-download"></i></button>
                        <table>
                            <thead>
                                <tr>
                                    <th>Employee</th>
                                    <th>Date</th>
                                    <th>Day</th>
                                    <th>Check-In Time</th>
                                    <th>Check-Out Time</th>
                                    <th>Late Check-Ins</th>
                                    <th>Working Hours</th>
                                </tr>
                            </thead>
                            <tbody id="adminAttendanceTable"></tbody>
                        </table>
                        <div class="missed-checkins-section">
                            <h2>Missed Check Ins</h2>
                            <table id="MissedCheckInsTable">
                                <thead>
                                    <tr>
                                        <th>Employee Name</th>
                                        <th>Notification Sent</th>
                                        <th>Date</th>
                                        <th>Day</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <!-- Summary of Missed Check-Ins -->
                        <div class="summary-section">
                            <h3>Summary of Missed Check-Ins</h3>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Total Missed Check-Ins</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td id="totalMissedCheckIns">0</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <!-- Time Table Section -->
                    <div id="adminTimeTable" style="display: none" class="admin-timetable-section">
                        <div class="section-header">
                            <h2>Employee Time Table</h2>
                            <p class="selected-employee">Viewing schedule for:<span id="selectedEmployeeName">No employee selected</span></p>
                        </div>
                        <button onclick="openEditTimeTableModal()" class="edit-timetable-btn">Edit Time Table</button>
                        <div class="timetable-container">
                            <table class="admin-timetable">
                                <thead>
                                    <tr>
                                        <th>Day</th>
                                        <th>Check In Time</th>
                                        <th>Check Out Time</th>
                                        <th>Working Hours</th>
                                    </tr>
                                </thead>
                                <tbody id="adminTimeTableBody">
                                    <tr>
                                        <td>Monday</td>
                                        <td id="adminMondayCheckIn">-</td>
                                        <td id="adminMondayCheckOut">-</td>
                                        <td id="adminMondayHours">-</td>
                                    </tr>
                                    <tr>
                                        <td>Tuesday</td>
                                        <td id="adminTuesdayCheckIn">-</td>
                                        <td id="adminTuesdayCheckOut">-</td>
                                        <td id="adminTuesdayHours">-</td>
                                    </tr>
                                    <tr>
                                        <td>Wednesday</td>
                                        <td id="adminWednesdayCheckIn">-</td>
                                        <td id="adminWednesdayCheckOut">-</td>
                                        <td id="adminWednesdayHours">-</td>
                                    </tr>
                                    <tr>
                                        <td>Thursday</td>
                                        <td id="adminThursdayCheckIn">-</td>
                                        <td id="adminThursdayCheckOut">-</td>
                                        <td id="adminThursdayHours">-</td>
                                    </tr>
                                    <tr>
                                        <td>Friday</td>
                                        <td id="adminFridayCheckIn">-</td>
                                        <td id="adminFridayCheckOut">-</td>
                                        <td id="adminFridayHours">-</td>
                                    </tr>
                                    <tr>
                                        <td>Saturday</td>
                                        <td id="adminSaturdayCheckIn">-</td>
                                        <td id="adminSaturdayCheckOut">-</td>
                                        <td id="adminSaturdayHours">-</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <!-- Edit Time Table Modal -->
                        <div id="editTimeTableModal" class="modal">
                            <div class="modal-content" id="editTimeTableContent">
                                <span class="close" onclick="closeEditTimeTableModal()"><i class="fa-solid fa-xmark"></i></span>
                                <h2>Edit Time Table</h2>
                                <div class="timetable-day-container">
                                    <div class="day-heading">Monday</div>
                                    <div id="editMondaySlots" class="time-slots">
                                        <div class="time-slot-row">
                                            <input type="time" class="time-input" />
                                            <input type="time" class="time-input" />
                                            <button class="remove-slot" onclick="removeTimeSlot(this)">×</button>
                                        </div>
                                    </div>
                                    <button class="add-slot-btn" onclick="addTimeSlot('editMonday')">+ Add Time Slot</button>
                                    <div class="day-heading">Tuesday</div>
                                    <div id="editTuesdaySlots" class="time-slots">
                                        <div class="time-slot-row">
                                            <input type="time" class="time-input" />
                                            <input type="time" class="time-input" />
                                            <button class="remove-slot" onclick="removeTimeSlot(this)">×</button>
                                        </div>
                                    </div>
                                    <button class="add-slot-btn" onclick="addTimeSlot('editTuesday')">+ Add Time Slot</button>
                                    <div class="day-heading">Wednesday</div>
                                    <div id="editWednesdaySlots" class="time-slots">
                                        <div class="time-slot-row">
                                            <input type="time" class="time-input" />
                                            <input type="time" class="time-input" />
                                            <button class="remove-slot" onclick="removeTimeSlot(this)"×</button>
                                </div>
                                    </div>
                                    <button class="add-slot-btn" onclick="addTimeSlot('editWednesday')">+ Add Time Slot</button>
                                    <div class="day-heading">Thursday</div>
                                    <div id="editThursdaySlots" class="time-slots">
                                        <div class="time-slot-row">
                                            <input type="time" class="time-input" />
                                            <input type="time" class="time-input" />
                                            <button class="remove-slot" onclick="removeTimeSlot(this)">×</button>
                                        </div>
                                    </div>
                                    <button class="add-slot-btn" onclick="addTimeSlot('editThursday')">+ Add Time Slot</button>
                                    <div class="day-heading">Friday</div>
                                    <div id="editFridaySlots" class="time-slots">
                                        <div class="time-slot-row">
                                            <input type="time" class="time-input" />
                                            <input type="time" class="time-input" />
                                            <button class="remove-slot" onclick="removeTimeSlot(this)">×</button>
                                        </div>
                                    </div>
                                    <button class="add-slot-btn" onclick="addTimeSlot('editFriday')">+ Add Time Slot</button>
                                    <div class="day-heading">Saturday</div>
                                    <div id="editSaturdaySlots" class="time-slots">
                                        <div class="time-slot-row">
                                            <input type="time" class="time-input" />
                                            <input type="time" class="time-input" />
                                            <button class="remove-slot" onclick="removeTimeSlot(this)">×</button>
                                        </div>
                                    </div>
                                    <button class="add-slot-btn" onclick="addTimeSlot('editSaturday')">+ Add Time Slot</button>
                                </div>
                                <button class="save-timetable-btn" onclick="saveEditedTimeTable()">Save Changes</button>
                            </div>
                        </div>
                    </div>
                    <!--Admin Progress Report Section-->
                    <div id="adminProgress" style="display: none">
                        <h2>Employee Progress Reports</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th>Employee</th>
                                    <th>Date</th>
                                    <th>Time</th>
                                    <th>Details</th>
                                    <th>File</th>
                                    <th>Download</th>
                                    <th>Status</th>
                                    <th>Remarks</th>
                                </tr>
                            </thead>
                            <tbody id="adminProgressTable"></tbody>
                        </table>
                    </div>
                    <!--Admin Holiday Request Section-->
                    <div id="adminHolidays" style="display: none">
                        <h2>Holiday Requests</h2>
                        <div class="filter-section">
                            <span>Filter by status: </span>
                            <select id="holidayStatusFilter" onchange="loadAdminHolidayRequests()">
                                <option value="all">All</option>
                                <option value="pending">Pending</option>
                                <option value="approved">Approved</option>
                                <option value="rejected">Rejected</option>
                                <option value="uninformed">Uninformed</option>
                            </select>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Employee</th>
                                    <th>Start Date</th>
                                    <th>End Date</th>
                                    <th>Days</th>
                                    <th>Reason</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="adminHolidayRequestsTable"></tbody>
                        </table>
                    </div>
                    <div id="weeklyAttendance" style="display: none">
                        <h1 style=" color: white; background-color: #1c7593; padding: 15px; text-align: center; ">Weekly Attendance Summary</h1>
                        <div style="margin: 15px 0">
                            <button onclick="downloadWeeklySummary()" class="download-btn" style="padding: 8px 15px"><i class="fas fa-download"></i> Download Summary</button>
                        </div>
                        <table id="weeklyAttendanceTable" class="weekly-summary-table">
                            <thead>
                                <tr>
                                    <th rowspan="2">Employee</th>
                                    <th colspan="3">Sunday</th>
                                    <th colspan="3">Monday</th>
                                    <th colspan="3">Tuesday</th>
                                    <th colspan="3">Wednesday</th>
                                    <th colspan="3">Thursday</th>
                                    <th colspan="3">Friday</th>
                                    <th colspan="3">Saturday</th>
                                </tr>
                                <tr>
                                    <th>IN</th>
                                    <th>OUT</th>
                                    <th>Late</th>
                                    <th>IN</th>
                                    <th>OUT</th>
                                    <th>Late</th>
                                    <th>IN</th>
                                    <th>OUT</th>
                                    <th>Late</th>
                                    <th>IN</th>
                                    <th>OUT</th>
                                    <th>Late</th>
                                    <th>IN</th>
                                    <th>OUT</th>
                                    <th>Late</th>
                                    <th>IN</th>
                                    <th>OUT</th>
                                    <th>Late</th>
                                    <th>IN</th>
                                    <th>OUT</th>
                                    <th>Late</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <!-- Admin Tasks/Targets Section -->
                    <div id="adminTargets" style="display: none">
                        <h1 style=" color: white; background-color: #1c7593; padding: 15px; text-align: center;">Tasks Management</h1>
                        <h4 style="padding: 10px">Assign Tasks To the selected Employee</h4>
                        <div class="task-form">
                            <label for="taskDate">Date:</label>
                            <input type="date" id="taskDate" style="padding: 5px" />
                            <label for="taskDay">Day:</label>
                            <select id="taskDay" style="padding: 5px">
                                <option value="">Select Day</option>
                                <option value="Monday">Monday</option>
                                <option value="Tuesday">Tuesday</option>
                                <option value="Wednesday">Wednesday</option>
                                <option value="Thursday">Thursday</option>
                                <option value="Friday">Friday</option>
                                <option value="Saturday">Saturday</option>
                                <option value="Sunday">Sunday</option>
                            </select>
                            <label for="taskDescription">Description:</label>
                            <input type="text" id="taskDescription" style="padding: 5px" />
                            <label for="taskFile"> Upload File:</label>
                            <input type="file" id="taskFile" />
                            <button onclick="addNewTask()">Add Task</button>
                        </div>
                        <h2 style="padding: 10px; margin: 10px">Assigned Tasks History</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Day</th>
                                    <th>Description</th>
                                    <th>File</th>
                                    <th>Status</th>
                                    <th>Reason</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="adminTasksTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <script>
                //Responsiveness/Hamburgur Menu Functionalities for MOBILE PHONES.
                //Employee Page.
                function toggleMobileMenu() {
                    const sidebar = document.querySelector("#employeePage .left-sidebar");
                    const hamburger = document.querySelector("#employeePage .hamburger-menu");
                    const overlay = document.querySelector("#employeePage .sidebar-overlay");
                    sidebar.classList.toggle("active");
                    hamburger.classList.toggle("active");
                    if (sidebar.classList.contains("active")) {
                        overlay.style.display = "block";
                    } else {
                        overlay.style.display = "none";
                    }
                }
                function closeMobileMenu() {
                    const sidebar = document.querySelector("#employeePage .left-sidebar");
                    const hamburger = document.querySelector("#employeePage .hamburger-menu");
                    const overlay = document.querySelector("#employeePage .sidebar-overlay");
                    sidebar.classList.remove("active");
                    hamburger.classList.remove("active");
                    overlay.style.display = "none";
                }
                //Responsiveness/Hamburgur Menu Functionalities for MOBILE PHONES.
                //Admin Page.
                function toggleAdminMobileMenu() {
                    const sidebar = document.querySelector("#adminPage .left-sidebar");
                    const hamburger = document.querySelector("#adminPage .hamburger-menu");
                    const overlay = document.querySelector("#adminPage .sidebar-overlay");
                    sidebar.classList.toggle("active");
                    hamburger.classList.toggle("active");
                    if (sidebar.classList.contains("active")) {
                        overlay.style.display = "block";
                    } else {
                        overlay.style.display = "none";
                    }
                }
                function closeAdminMobileMenu() {
                    const sidebar = document.querySelector("#adminPage .left-sidebar");
                    const hamburger = document.querySelector("#adminPage .hamburger-menu");
                    const overlay = document.querySelector("#adminPage .sidebar-overlay");
                    sidebar.classList.remove("active");
                    hamburger.classList.remove("active");
                    overlay.style.display = "none";
                }
                function checkMobileView() {
                    if (window.innerWidth <= 480) {
                        const dateElement = document.getElementById("currentDate");
                        const timeElement = document.getElementById("currentTime");
                        if (dateElement) dateElement.style.display = "none";
                        if (timeElement) timeElement.style.display = "none";
                        if (!document.querySelector("#employeePage .sidebar-overlay")) {
                            const overlay = document.createElement("div");
                            overlay.className = "sidebar-overlay";
                            overlay.onclick = closeMobileMenu;
                            document.querySelector("#employeePage .container").appendChild(overlay);
                        }
                        if (!document.querySelector("#adminPage .sidebar-overlay")) {
                            const overlay = document.createElement("div");
                            overlay.className = "sidebar-overlay";
                            overlay.onclick = closeAdminMobileMenu;
                            document.querySelector("#adminPage .container").appendChild(overlay);
                        }
                    } else {
                        //Display date and time on desktop.
                        const dateElement = document.getElementById("currentDate");
                        const timeElement = document.getElementById("currentTime");
                        if (dateElement) dateElement.style.display = "inline-block";
                        if (timeElement) timeElement.style.display = "inline-block";
                    }
                }
                window.addEventListener("load", checkMobileView);
                window.addEventListener("resize", checkMobileView);
                function openAddEmployeeModal() {
                    document.getElementById("addEmployeeModal").style.display = "block";
                    document.getElementById("modalOverlay").style.display = "block";
                    const deleteEmployeeSelect = document.getElementById("deleteEmployeeSelect");
                    deleteEmployeeSelect.innerHTML ='<option value="">Select an employee</option>';
                    // Add all employees except admin to the dropdown
                    Object.keys(users).forEach((username) => {
                        if (username !== "admin") {
                            const option = document.createElement("option");
                            option.value = username;
                            option.textContent = username;
                            deleteEmployeeSelect.appendChild(option);
                        }
                    });
                }
                function closeAddEmployeeModal() {
                    document.getElementById("addEmployeeModal").style.display = "none";
                    document.getElementById("modalOverlay").style.display = "none";
                    document.getElementById("newUsername").value = "";
                    document.getElementById("newPassword").value = "";
                    document.getElementById("newEmployeeId").value = "";
                    document.getElementById("newEmployeePhone").value = "";
                    document.getElementById("newEmployeeEmail").value = "";
                    //Remove send credentials button if it exists
                    const sendCredentialsContainer = document.querySelector('.form-group button[onclick^="sendCredentialsEmail"]');
                    if (sendCredentialsContainer) {
                        sendCredentialsContainer.parentElement.remove();
                    }
                }
                function sendCredentialsEmail(username) {
                    const user = users[username];
                    if (!user || !user.email) {
                        alert("User email not found.");
                        return;
                    }
                    //email subject and body
                    const subject = "Your FSPro System Credentials";
                    const body = `Hello,\n\nYour account has been created in the FSPro system.\n\nUsername: ${username}\nPassword: ${user.password}\nEmployee ID: ${user.id}\n\nPlease login at your earliest convenience and inform your Team Lead if you have any Queries or Login issues.\n\nRegards,\nFSPro Admin Team`;
                    //create a mailto link to open the user's email.
                    const mailtoLink = `mailto:${user.email
                        }?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                    window.open(mailtoLink, "_blank");
                }
                function deleteEmployee() {
                    const username = document.getElementById("deleteEmployeeSelect").value;
                    if (!username) {
                        alert("Please select an employee to delete");
                        return;
                    }
                    if (username === "admin") {
                        alert("Cannot delete the admin account");
                        return;
                    }
                    if (confirm(`Are you sure you want to delete the employee "${username}"? This cannot be undone.`)) {
                        // Delete from local object
                        delete users[username];
                        localStorage.setItem("users", JSON.stringify(users));
                        // Delete from Firebase
                        database.ref(`users/${username}`).remove().then(() => {
                                console.log("Employee removed from Firebase successfully");
                                // Delete all associated data from Firebase
                                const promises = [
                                    // Delete attendance records
                                    database.ref('attendanceRecords').once('value').then(snapshot => {
                                            const records = snapshot.val() || {};
                                            const updatedRecords = Object.values(records).filter(record => record.employee !== username);
                                            return database.ref('attendanceRecords').set(updatedRecords);
                                        }),
                                    // Delete late check-ins
                                    database.ref('lateCheckIns').once('value').then(snapshot => {
                                            const records = snapshot.val() || {};
                                            const updatedRecords = Object.values(records).filter(record => record.employee !== username);
                                            return database.ref('lateCheckIns').set(updatedRecords);
                                        }),
                                    // Delete holiday requests
                                    database.ref('holidayRequests').once('value').then(snapshot => {
                                            const records = snapshot.val() || {};
                                            const updatedRecords = Object.values(records).filter(record => record.employee !== username && record.employeeName !== username);
                                            return database.ref('holidayRequests').set(updatedRecords);
                                        }),
                                    // Delete progress reports
                                    database.ref('progressReports').once('value').then(snapshot => {
                                            const records = snapshot.val() || {};
                                            const updatedRecords = Object.values(records).filter(record => record.employee !== username);
                                            return database.ref('progressReports').set(updatedRecords);
                                        }),
                                    // Delete employee tasks
                                    database.ref('employeeTasks').once('value').then(snapshot => {
                                            const records = snapshot.val() || {};
                                            const updatedRecords = Object.values(records).filter(record => record.assignedTo !== username);
                                            return database.ref('employeeTasks').set(updatedRecords);
                                        })
                                ];
                                // Wait for all deletions to complete
                                Promise.all(promises).then(() => {
                                        localStorage.setItem("attendanceRecords", JSON.stringify([]));
                                        localStorage.setItem("lateCheckIns", JSON.stringify([]));
                                        localStorage.setItem("holidayRequests", JSON.stringify([]));
                                        localStorage.setItem("progressReports", JSON.stringify([]));
                                        localStorage.setItem("employeeTasks", JSON.stringify([]));
                                        // Remove the employee from admin select dropdown
                                        const adminUserSelect = document.getElementById("adminUserSelect");
                        const optionToRemove = Array.from(adminUserSelect.options).find( (option) => option.value === username);
                        if (optionToRemove) {
                            adminUserSelect.removeChild(optionToRemove);
                        }
                        // Remove the employee from delete select dropdown
                        const deleteEmployeeSelect = document.getElementById("deleteEmployeeSelect");
                        const deleteOptionToRemove = Array.from(deleteEmployeeSelect.options).find( (option) => option.value === username);
                        if (deleteOptionToRemove) {
                            deleteEmployeeSelect.removeChild(deleteOptionToRemove);}
                        deleteEmployeeSelect.value = "";
                                        alert(`Employee "${username}" and all associated data have been deleted successfully.`);
                                    })
                                    .catch(error => {
                                        console.error("Error deleting employee data:", error);
                                        alert("Employee was deleted but there was an error removing some associated data.");
                                    });
                            })
                            .catch((error) => {
                                console.error("Error removing employee from Firebase:", error);
                                alert("Error deleting employee. Please try again.");
                            });
                    }
                }
                function addNewEmployee() {
                    const username = document.getElementById("newUsername").value.toLowerCase();
                    const password = document.getElementById("newPassword").value;
                    const employeeId = document.getElementById("newEmployeeId").value;
                    const phone = document.getElementById("newEmployeePhone").value;
                    const email = document.getElementById("newEmployeeEmail").value;
                    if (!username || !password || !employeeId || !phone) {
                        alert("Please fill in all required fields");
                        return;
                    }
                    if (users[username]) {
                        alert("Username already exists. Please choose a different username.");
                        return;
                    }
                    //Add new employee to users object
                    users[username] = {
                        password: password,
                        id: employeeId,
                        role: "employee",
                        phone: phone,
                        email: email,
                    };
                    saveToFirebase(`users/${username}`, {
                        password: password,
                        id: employeeId,
                        role: "employee",
                        phone: phone,
                        email: email,
                    })
                        .then(() => {
                            console.log("Employee added to Firebase successfully");
                        })
                        .catch((error) => {
                            console.error("Error adding employee to Firebase:", error);
                        });
                    //Update the select dropdown in the Admin Page.
                    const selectElement = document.getElementById("adminUserSelect");
                    const option = document.createElement("option");
                    option.value = username;
                    option.textContent = username;
                    selectElement.appendChild(option);
                    selectElement.value = username;
                    handleUserSelect();
                    localStorage.setItem("users", JSON.stringify(users));
                    //email settings for newly added employees.
                    if (email) {
                        const sendCredentialsContainer = document.createElement("div");
                        sendCredentialsContainer.className = "form-group";
                        sendCredentialsContainer.style.marginTop = "20px";
                        sendCredentialsContainer.innerHTML = `
                    <button onclick="sendCredentialsEmail('${username}')" style="background-color: #3498db;">Send Credentials to ${email}</button>`;
                        document.getElementById("addEmployeeContent").appendChild(sendCredentialsContainer);}
                    alert("Employee added successfully!");
                }
                window.addEventListener("load", () => {
                    // Always load from Firebase first for most up-to-date data
                    getFirebaseData("users", (firebaseUsers) => {
                        if (firebaseUsers) {
                            // Update the users object with Firebase data
                            Object.keys(firebaseUsers).forEach((username) => {
                                users[username] = firebaseUsers[username];
                            });
                            // Update localStorage with the latest data
                            localStorage.setItem("users", JSON.stringify(users));
                            // Update the admin dropdown
                            const selectElement =
                                document.getElementById("adminUserSelect");
                            if (selectElement) {
                                // Clear existing options except the first one
                                while (selectElement.options.length > 1) {
                                    selectElement.remove(1);
                                }

                                // Add all employees to the dropdown
                                Object.keys(users).forEach((username) => {
                                    if (username !== "admin") {
                                        const option = document.createElement("option");
                                        option.value = username;
                                        option.textContent = username;
                                        selectElement.appendChild(option);
                                    }
                                });
                            }
                        } else {
                            // If Firebase has no data, use localStorage as backup
                            const savedUsers = localStorage.getItem("users");
                            if (savedUsers) {
                                const parsedUsers = JSON.parse(savedUsers);

                                // Update local users object
                                Object.keys(parsedUsers).forEach((username) => {
                                    if (!users[username]) {
                                        users[username] = parsedUsers[username];
                                    }
                                });

                                // Upload to Firebase
                                saveToFirebase("users", users);

                                // Update the admin dropdown
                                const selectElement =
                                    document.getElementById("adminUserSelect");
                                if (selectElement) {
                                    // Clear existing options except the first one
                                    while (selectElement.options.length > 1) {
                                        selectElement.remove(1);
                                    }

                                    // Add all employees
                                    Object.keys(users).forEach((username) => {
                                        if (username !== "admin") {
                                            const option = document.createElement("option");
                                            option.value = username;
                                            option.textContent = username;
                                            selectElement.appendChild(option);
                                        }
                                    });
                                }
                            }
                        }
                    });
                });
                const users = {
                    admin: { password: "admin123", role: "admin" },
                    hamza: {
                        password: "hamza123",
                        id: "118",
                        role: "employee",
                        phone: "923480970884",
                    },
                    zain: {
                        password: "zain123",
                        id: "119",
                        role: "employee",
                        phone: "9230251866577",
                    },
                    hanzallah: {
                        password: "hanzallah123",
                        id: "120",
                        role: "employee",
                        phone: "923474224118",
                    },
                };
                // Check login state when page loads
                window.addEventListener("load", () => {
                    const loggedInUser = JSON.parse(
                        localStorage.getItem("loggedInUser")
                    );
                    if (loggedInUser) {
                        if (loggedInUser.role === "admin") {
                            showPage("adminPage");
                            loadAdminData();
                        } else {
                            document.getElementById(
                                "employeeDetails"
                            ).textContent = `${loggedInUser.username} | ID: ${loggedInUser.id}`;
                            showPage("employeePage");
                            loadAttendanceTable();
                            updateSummaryValues();
                            loadEmployeeHolidayRequests();
                        }
                    }
                });
                document.getElementById("loginBtn").addEventListener("click", () => {
                    const username = document
                        .getElementById("userName")
                        .value.toLowerCase();
                    const password = document.getElementById("userPassword").value;

                    // First check Firebase for the most up-to-date user data
                    database.ref(`users/${username}`).once(
                        "value",
                        (snapshot) => {
                            const firebaseUser = snapshot.val();

                            // Use Firebase data if available, otherwise fallback to local data
                            const user = firebaseUser || users[username];

                            if (user && user.password === password) {
                                // Store login info in localStorage
                                localStorage.setItem(
                                    "loggedInUser",
                                    JSON.stringify({
                                        username,
                                        id: user.id,
                                        role: user.role,
                                    })
                                );

                                // If Firebase didn't have this user, save it there
                                if (!firebaseUser && users[username]) {
                                    saveToFirebase(`users/${username}`, users[username]);
                                }

                                if (user.role === "admin") {
                                    showPage("adminPage");
                                    loadAdminData();
                                } else {
                                    document.getElementById(
                                        "employeeDetails"
                                    ).textContent = `${username} | ID: ${user.id}`;
                                    showPage("employeePage");
                                    loadAttendanceTable();
                                    updateSummaryValues();
                                    loadEmployeeHolidayRequests();
                                    showSection("attendance");
                                }
                            } else {
                                alert("Invalid username or password");
                            }
                        },
                        (error) => {
                            console.error("Error checking Firebase for user:", error);

                            // Fallback to local check if Firebase fails
                            const user = users[username];
                            if (user && user.password === password) {
                                localStorage.setItem(
                                    "loggedInUser",
                                    JSON.stringify({
                                        username,
                                        id: user.id,
                                        role: user.role,
                                    })
                                );
                                if (user.role === "admin") {
                                    showPage("adminPage");
                                    loadAdminData();
                                } else {
                                    document.getElementById(
                                        "employeeDetails"
                                    ).textContent = `${username} | ID: ${user.id}`;
                                    showPage("employeePage");
                                    loadAttendanceTable();
                                    updateSummaryValues();
                                    loadEmployeeHolidayRequests();
                                    showSection("attendance");
                                }
                            } else {
                                alert("Invalid username or password");
                            }
                        }
                    );
                });
                function showPage(pageId) {
                    ["loginPage", "employeePage", "adminPage"].forEach((id) => {
                        document.getElementById(id).style.display =
                            id === pageId ? "block" : "none";
                    });
                    if (pageId === "employeePage") {
                        updateSummaryValues();
                        loadEmployeeHolidayRequests();
                    }
                }
                //Date & Time Display Section/Functionality.
                function updateTime() {
                    const now = new Date();
                    const timeString = now.toLocaleTimeString();
                    const dateString = now.toLocaleDateString("en-US", {
                        weekday: "long",
                        year: "numeric",
                        month: "long",
                        day: "numeric",
                    });
                    document.getElementById("currentTime").textContent = timeString;
                    document.getElementById(
                        "currentDate"
                    ).textContent = `${dateString} | ${timeString}`;
                    //Checking missed check-in after 10:30 AM.
                    const currentHour = now.getHours();
                    const currentMinutes = now.getMinutes();
                    const currentTime = currentHour * 60 + currentMinutes;
                    const checkInDeadline = 10 * 60 + 30;
                    if (currentTime === checkInDeadline) {
                        const currentUser = document
                            .getElementById("employeeDetails")
                            ?.textContent.split("|")[0]
                            .trim();
                        if (currentUser) {
                            const attendanceRecords =
                                JSON.parse(localStorage.getItem("attendanceRecords")) || [];
                            const todayRecord = attendanceRecords.find(
                                (record) =>
                                    record.employee === currentUser &&
                                    record.date === dateString
                            );
                            if (!todayRecord || !todayRecord.checkIn) {
                                const notifications =
                                    JSON.parse(localStorage.getItem("notifications")) || [];
                                const existingNotification = notifications.find(
                                    (n) =>
                                        n.employee === currentUser &&
                                        n.date === dateString &&
                                        n.type === "missed_checkin"
                                );
                                if (!existingNotification) {
                                    notifications.push({
                                        employee: currentUser,
                                        date: dateString,
                                        time: timeString,
                                        type: "missed_checkin",
                                        message: "You forgot to check in for today.",
                                    });
                                    localStorage.setItem(
                                        "notifications",
                                        JSON.stringify(notifications)
                                    );
                                    //Updating the bell/notification icon
                                    const notificationIcon =
                                        document.querySelector(".notification-icon");
                                    if (notificationIcon) {
                                        notificationIcon.style.display = "block";
                                    }
                                }
                            }
                        }
                    }
                }
                //Update the clock/Time for every second.
                setInterval(updateTime, 1000);
                updateTime();
                function handleCheckIn() {
                    const now = new Date();
                    const employee = document.getElementById("employeeDetails").textContent.split("|")[0].trim();
                    const date = now.toLocaleDateString();
                    const day = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"][now.getDay()];
                    const time = now.toLocaleTimeString();

                    // Get employee's schedule for today
                    getFirebaseData("timeTables", (firebaseTimeTables) => {
                        const timeTables = firebaseTimeTables || JSON.parse(localStorage.getItem("timeTables")) || [];
                        const employeeSchedule = timeTables.find((t) => t.employee === employee);

                        if (!employeeSchedule || !employeeSchedule[day.toLowerCase()]?.slots) {
                            alert("Please set up your schedule for today first.");
                            return;
                        }

                        const todaySlots = employeeSchedule[day.toLowerCase()].slots;
                        const currentTime = new Date(`1970-01-01T${time}`);

                        // Sort slots by check-in time to ensure we check them in order
                        const sortedSlots = [...todaySlots].sort((a, b) => {
                            const timeA = new Date(`1970-01-01T${a.checkIn}`);
                            const timeB = new Date(`1970-01-01T${b.checkIn}`);
                            return timeA - timeB;
                        });

                        // Find the appropriate slot for current time
                        let canCheckIn = false;
                        for (const slot of sortedSlots) {
                            const slotStart = new Date(`1970-01-01T${slot.checkIn}`);
                            const slotEnd = new Date(`1970-01-01T${slot.checkOut}`);
                            
                            // Allow check-in 30 minutes before slot start
                            const earlyCheckIn = new Date(slotStart.getTime() - 30 * 60 * 1000);
                            // Late check-in window is up to 2 hours after slot start (not slot end)
                            const lateCheckIn = new Date(slotStart.getTime() + 2 * 60 * 60 * 1000);

                            // Check if current time falls within this slot's window
                        if (currentTime >= earlyCheckIn && currentTime <= lateCheckIn) {
                                canCheckIn = true;
                                // Check if it's a late check-in (more than 0 minutes after slot start)
                                if (currentTime > slotStart) {
                                    if (confirm("You are checking in late. This will be recorded as a late check-in. Continue?")) {
                                recordCheckIn(employee, date, day, time, true);
                            }
                        } else {
                                    recordCheckIn(employee, date, day, time, false);
                                }
                                return;
                            }
                        }

                        if (!canCheckIn) {
                            alert("You are outside the allowed check-in window for any slot today.");
                        }
                    });
                }

                function recordCheckIn(employee, date, day, time, isLate) {
                    // Get current records from Firebase first
                    getFirebaseData("attendanceRecords", (firebaseRecords) => {
                        let attendanceRecords =
                            firebaseRecords ||
                            JSON.parse(localStorage.getItem("attendanceRecords")) ||
                            [];

                        // Find if there's an existing record for today
                        const recordIndex = attendanceRecords.findIndex(
                            (record) => record.employee === employee && record.date === date
                        );

                        if (recordIndex === -1) {
                            // If no record exists for today, create one
                            const newRecord = {
                                employee: employee,
                                date: date,
                                day: day,
                                checkIn: time,
                                isLate: isLate,
                            };
                            attendanceRecords.push(newRecord);
                        } else {
                            // Update existing record with multiple check-ins
                            if (Array.isArray(attendanceRecords[recordIndex].checkIn)) {
                                attendanceRecords[recordIndex].checkIn.push(time);
                            } else if (attendanceRecords[recordIndex].checkIn) {
                                attendanceRecords[recordIndex].checkIn = [
                                    attendanceRecords[recordIndex].checkIn,
                                    time,
                                ];
                            } else {
                            attendanceRecords[recordIndex].checkIn = time;
                            }
                            // Update late status if this check-in is late
                            if (isLate) {
                                attendanceRecords[recordIndex].isLate = true;
                            }
                        }

                        // Save to Firebase first
                        saveToFirebase("attendanceRecords", attendanceRecords)
                            .then(() => {
                                // Save to localStorage as backup
                                localStorage.setItem(
                                    "attendanceRecords",
                                    JSON.stringify(attendanceRecords)
                                );
                                alert(
                                    isLate
                                        ? "Late check-in recorded successfully!"
                                        : "Check-in recorded successfully!"
                                );
                                loadAttendanceTable();
                                updateSummaryValues();
                            })
                            .catch((error) => {
                                console.error(
                                    "Error saving attendance record to Firebase:",
                                    error
                                );
                                // Still save to localStorage as backup
                                localStorage.setItem(
                                    "attendanceRecords",
                                    JSON.stringify(attendanceRecords)
                                );
                                alert(
                                    isLate
                                        ? "Late check-in recorded successfully!"
                                        : "Check-in recorded successfully!"
                                );
                                loadAttendanceTable();
                                updateSummaryValues();
                            });
                    });
                }

                function handleCheckOut() {
                    const now = new Date();
                    const employee = document
                        .getElementById("employeeDetails")
                        .textContent.split("|")[0]
                        .trim();
                    const date = now.toLocaleDateString();
                    const day = [
                        "Sunday",
                        "Monday",
                        "Tuesday",
                        "Wednesday",
                        "Thursday",
                        "Friday",
                        "Saturday",
                    ][now.getDay()];
                    const time = now.toLocaleTimeString();

                    // Get employee's schedule for today
                    getFirebaseData("timeTables", (firebaseTimeTables) => {
                        const timeTables =
                            firebaseTimeTables ||
                            JSON.parse(localStorage.getItem("timeTables")) ||
                            [];
                        const employeeSchedule = timeTables.find(
                            (t) => t.employee === employee
                        );

                        if (
                            !employeeSchedule ||
                            !employeeSchedule[day.toLowerCase()]?.slots
                        ) {
                            alert("Please set up your schedule for today first.");
                            return;
                        }

                        const todaySlots = employeeSchedule[day.toLowerCase()].slots;
                        const currentTime = new Date(`1970-01-01T${time}`);

                        // Find the current slot based on time
                        const currentSlot = todaySlots.find((slot) => {
                            const slotStart = new Date(`1970-01-01T${slot.checkIn}`);
                            const slotEnd = new Date(`1970-01-01T${slot.checkOut}`);
                            return currentTime >= slotStart && currentTime <= slotEnd;
                        });

                        if (!currentSlot) {
                            alert("You are not scheduled to work at this time.");
                            return;
                        }

                        // Check if within slot's time range
                        const slotEnd = new Date(`1970-01-01T${currentSlot.checkOut}`);
                        if (currentTime > slotEnd) {
                            alert("You are checking out after your scheduled end time.");
                        }

                        // Record check-out
                        recordCheckOut(employee, date, day, time);
                    });
                }

                function recordCheckOut(employee, date, day, time) {
                    // Get current records from Firebase first
                    getFirebaseData("attendanceRecords", (firebaseRecords) => {
                        let attendanceRecords =
                            firebaseRecords ||
                            JSON.parse(localStorage.getItem("attendanceRecords")) ||
                            [];

                        // Find if there's an existing record for today
                        const recordIndex = attendanceRecords.findIndex(
                            (record) => record.employee === employee && record.date === date
                        );

                        if (recordIndex === -1) {
                            // If no record exists for today, create one
                            const newRecord = {
                                employee: employee,
                                date: date,
                                day: day,
                                checkOut: time,
                            };
                            attendanceRecords.push(newRecord);
                        } else {
                            // Update existing record
                            if (Array.isArray(attendanceRecords[recordIndex].checkOut)) {
                                attendanceRecords[recordIndex].checkOut.push(time);
                            } else if (attendanceRecords[recordIndex].checkOut) {
                                attendanceRecords[recordIndex].checkOut = [
                                    attendanceRecords[recordIndex].checkOut,
                                    time,
                                ];
                            } else {
                                attendanceRecords[recordIndex].checkOut = time;
                            }
                        }

                        // Save to Firebase first
                        saveToFirebase("attendanceRecords", attendanceRecords)
                            .then(() => {
                                // Save to localStorage as backup
                                localStorage.setItem(
                                    "attendanceRecords",
                                    JSON.stringify(attendanceRecords)
                                );
                                alert("Check-out recorded successfully!");
                                loadAttendanceTable();
                                updateSummaryValues();
                            })
                            .catch((error) => {
                                console.error(
                                    "Error saving attendance record to Firebase:",
                                    error
                                );
                                // Still save to localStorage as backup
                                localStorage.setItem(
                                    "attendanceRecords",
                                    JSON.stringify(attendanceRecords)
                                );
                                alert("Check-out recorded successfully!");
                                loadAttendanceTable();
                                updateSummaryValues();
                            });
                    });
                }
                //Function to send notification to the employee for missed checkins and update the notification count.
                function sendNotification(employee) {
                    const notificationCount =
                        document.getElementById("notificationCount");
                    let count = parseInt(notificationCount.textContent) || 0;
                    count++;
                    notificationCount.textContent = count;
                    const notificationList =
                        document.getElementById("notificationList");
                    const notificationItem = document.createElement("div");
                    notificationItem.textContent = `Missed check-in notification sent to ${employee}.`;
                    notificationList.appendChild(notificationItem);
                }
                //Function to clear the notifications list and update the count.
                function clearNotifications() {
                    const notificationCount =
                        document.getElementById("notificationCount");
                    notificationCount.textContent = "0";
                    document.getElementById("notificationList").innerHTML = "";
                }
                function toggleNotificationPopup() {
                    const popup = document.getElementById("notificationPopup");
                    popup.style.display =
                        popup.style.display === "block" ? "none" : "block";
                }
                function showSection(sectionName) {
                    document.querySelectorAll(".section").forEach((section) => {
                        section.style.display = "none";
                    });
                    const selectedSection = document.getElementById(
                        sectionName + "-section"
                    );
                    if (selectedSection) {
                        selectedSection.style.display = "block";
                    }
                    //Show the employee header only when on attendance section
                    const employeeHeader = document.getElementById("employeeHeader");
                    if (employeeHeader) {
                        employeeHeader.style.display =
                            sectionName === "attendance" ? "flex" : "none";
                    }
                    if (sectionName === "progress") {
                        loadEmployeeProgress();
                    } else if (sectionName === "employeeTasks") {
                        loadEmployeeTasks();
                    }
                }
                // Admin Page functions
                function handleUserSelect() {
                    const selectedUser =
                        document.getElementById("adminUserSelect").value;
                    document.getElementById("selectedEmployeeName").textContent =
                        selectedUser || "No employee selected";
                    loadAdminData(selectedUser);
                    loadMissedCheckIns(selectedUser);
                    loadAdminProgressReports(selectedUser);
                    loadAdminTimeTable(selectedUser);
                    loadAdminHolidayRequests(selectedUser);
                    loadAdminTasks(selectedUser);
                }
                function updateWorkingHours(selectElement, date, employee) {
                    const row = selectElement.closest("tr");
                    const checkInSelect = row.querySelector("td:nth-child(4) select");
                    const checkOutSelect = row.querySelector("td:nth-child(5) select");
                    const isLate =
                        row.querySelector("td:nth-child(6)").textContent === "Yes";

                    // Get all selected times
                    const checkInTime = checkInSelect.value;
                    const checkOutTime = checkOutSelect.value;

                    // Convert times to 24-hour format
                    const checkIn24 = convertTo24Hour(checkInTime);
                    const checkOut24 = convertTo24Hour(checkOutTime);

                    // Calculate working hours
                    const workingHours = calculateWorkingHours(
                        [checkIn24],
                        [checkOut24],
                        isLate ? [checkIn24] : []
                    );

                    // Update the working hours cell
                    row.querySelector("td:last-child").textContent = workingHours;

                    // Update the record in localStorage and Firebase
                    getFirebaseData(
                        "attendanceRecords",
                        (firebaseAttendanceRecords) => {
                            let attendanceRecords =
                                firebaseAttendanceRecords ||
                                JSON.parse(localStorage.getItem("attendanceRecords")) ||
                                [];
                            const recordIndex = attendanceRecords.findIndex(
                                (r) => r.employee === employee && r.date === date
                            );

                            if (recordIndex !== -1) {
                                const record = attendanceRecords[recordIndex];
                                const checkInIndex = Array.from(
                                    checkInSelect.options
                                ).indexOf(checkInSelect.selectedOptions[0]);
                                const checkOutIndex = Array.from(
                                    checkOutSelect.options
                                ).indexOf(checkOutSelect.selectedOptions[0]);

                                if (checkInIndex !== -1 && record.checkIn) {
                                    if (Array.isArray(record.checkIn)) {
                                        record.checkIn[checkInIndex] = checkInTime;
                                    } else {
                                        record.checkIn = [checkInTime];
                                    }
                                }

                                if (checkOutIndex !== -1 && record.checkOut) {
                                    if (Array.isArray(record.checkOut)) {
                                        record.checkOut[checkOutIndex] = checkOutTime;
                                    } else {
                                        record.checkOut = [checkOutTime];
                                    }
                                }

                                // Save updates
                                saveToFirebase("attendanceRecords", attendanceRecords)
                                    .then(() => {
                                        localStorage.setItem(
                                            "attendanceRecords",
                                            JSON.stringify(attendanceRecords)
                                        );
                                    })
                                    .catch((error) => {
                                        console.error(
                                            "Error saving attendance record to Firebase:",
                                            error
                                        );
                                        localStorage.setItem(
                                            "attendanceRecords",
                                            JSON.stringify(attendanceRecords)
                                        );
                                    });
                            }
                        }
                    );
                }

                function loadAdminData(selectedUser = "") {
                    // Get records from Firebase first, then fallback to localStorage
                    getFirebaseData("attendanceRecords", (firebaseAttendanceRecords) => {
                        const attendanceRecords = firebaseAttendanceRecords || JSON.parse(localStorage.getItem("attendanceRecords")) || [];
                        const tableBody = document.getElementById("adminAttendanceTable");
                        if (!tableBody) return;
                        tableBody.innerHTML = "";

                        // Filter records based on selected user
                        const filteredRecords = attendanceRecords.filter(
                            (record) => !selectedUser || record.employee === selectedUser
                        );

                        if (selectedUser && filteredRecords.length === 0) {
                            const row = document.createElement("tr");
                            row.innerHTML = '<td colspan="7" style="text-align: center;">No attendance records found for this employee</td>';
                            tableBody.appendChild(row);
                            return;
                        }

                        // Helper function to parse date in both formats
                        function parseDate(dateStr) {
                            // Try dd/mm/yyyy format first
                            let parts = dateStr.split('/');
                            if (parts.length === 3) {
                                // Check if it's dd/mm/yyyy
                                if (parseInt(parts[0]) <= 31) {
                                    return new Date(parts[2], parts[1] - 1, parts[0]);
                                }
                                // If not, assume mm/dd/yyyy
                                return new Date(parts[2], parts[0] - 1, parts[1]);
                            }
                            // If not in expected format, try direct parsing
                            return new Date(dateStr);
                        }

                        // Sort records by date in descending order (newest first)
                        filteredRecords.sort((a, b) => {
                            const dateA = parseDate(a.date);
                            const dateB = parseDate(b.date);
                            return dateB - dateA;
                        });

                        // Display sorted records
                        filteredRecords.forEach((record) => {
                            const checkOutTimes = Array.isArray(record.checkOut)
                                ? record.checkOut
                                : record.checkOut
                                    ? [record.checkOut]
                                    : [];

                            const lateCheckIns = JSON.parse(localStorage.getItem("lateCheckIns")) || [];
                            const lateCheckInTimes = lateCheckIns
                                .filter(
                                    (late) =>
                                        late.employee === record.employee &&
                                        late.date === record.date
                                )
                                .map((late) => late.time)
                                .sort((a, b) => {
                                    const timeA = new Date(`1970-01-01T${a}`);
                                    const timeB = new Date(`1970-01-01T${b}`);
                                    return timeB - timeA;
                                });

                            const workingHours = calculateWorkingHours(
                                record.checkIn,
                                checkOutTimes,
                                lateCheckInTimes
                            );

                            const row = document.createElement("tr");
                            row.innerHTML = `
            <td>${record.employee}</td>
            <td>${record.date}</td>
            <td>${record.day}</td>
            <td>${record.checkIn || "-"}</td>
            <td>
                                    <select onchange="updateWorkingHours(this, '${record.date}', '${record.employee}')">
                                        ${checkOutTimes.length > 0
                                    ? checkOutTimes.map(time =>
                                        `<option ${checkOutTimes[0] === time ? "selected" : ""}>${time}</option>`
                                    ).join("")
                                    : '<option value="-">-</option>'
                                }
                </select>
            </td>
            <td>
                                    <select onchange="updateWorkingHours(this, '${record.date}', '${record.employee}')">
                                        ${lateCheckInTimes.length > 0
                                    ? lateCheckInTimes.map(time =>
                                        `<option ${lateCheckInTimes[0] === time ? "selected" : ""}>${time}</option>`
                                    ).join("")
                                    : '<option value="-">-</option>'
                                }
                </select>
            </td>
                                <td id="workingHours_${record.date}_${record.employee}">${workingHours}</td>
        `;
                            tableBody.appendChild(row);
                        });

                        loadMissedCheckIns(selectedUser);
                        updateMissedCheckInsSummary();
                    });
                }
                function loadMissedCheckIns(selectedUser = "") {
                    const missedCheckIns =
                        JSON.parse(localStorage.getItem("missedCheckIns")) || [];
                    const tableBody = document
                        .getElementById("MissedCheckInsTable")
                        .getElementsByTagName("tbody")[0];
                    if (!tableBody) return; //come out of the function if table doesn't exist.
                    tableBody.innerHTML = "";
                    //Show the missed check ins data of the selected user and admin can send a whatsapp notification.
                    //Also filtering by date and show the most recent missed check ins first.
                    missedCheckIns
                        .filter(
                            (record) => !selectedUser || record.employee === selectedUser
                        )
                        .sort((a, b) => new Date(b.date) - new Date(a.date))
                        .forEach((record) => {
                            const employee = users[record.employee];
                            const row = document.createElement("tr");
                            row.innerHTML = `
                        <td>${record.employee}</td>
                        <td>${record.notificationSent ? "Yes" : "No"}</td>
                        <td>${record.date}</td>
                        <td>${record.day}</td>
                        <td>
                            ${!record.notificationSent
                                    ? `<button onclick="sendWhatsAppMessage('${employee.phone}')">Send WhatsApp Notification</button>`
                                    : '<span class="status-sent">Notification Sent</span>'
                                }
                        </td>
                    `;
                            tableBody.appendChild(row);
                        });
                }
                //Updating the missed summary check ins section in the admin panel.
                function updateMissedCheckInsSummary() {
                    const missedCheckIns =
                        JSON.parse(localStorage.getItem("missedCheckIns")) || [];
                    const totalMissedCheckIns = missedCheckIns.length;
                    document.getElementById("totalMissedCheckIns").textContent =
                        totalMissedCheckIns;
                }
                //Whatsapp API.
                //Function to send a whatsapp message to the specific employee for their missed check in of the day.
                function sendWhatsAppMessage(phone) {
                    const message =
                        "Hello! This is a reminder that you missed your check-in today.";
                    const encodedMessage = encodeURIComponent(message);
                    const url = `https://api.whatsapp.com/send?phone=${phone}&text=${encodedMessage}`;
                    console.log("WhatsApp URL:", url);
                    window.open(url, "_blank");
                }
                //Function for opening the Employee Holiday Request Section in a popup modal
                function openHolidayRequest() {
                    const employeeName = document
                        .getElementById("employeeDetails")
                        .textContent.split("|")[0]
                        .trim();
                    // Create modal if it doesn't exist
                    let modal = document.getElementById("holidayModal");
                    if (!modal) {
                        modal = document.createElement("div");
                        modal.id = "holidayModal";
                        modal.className = "holiday-modal";
                        modal.innerHTML = `
                            <div class="section-header">
                                <h2>Holiday Request</h2>
                                <button onclick="closeHolidayModal()" class="close-btn"><i class="fa-solid fa-xmark" style="background-color: red;"></i></button>
                            </div>
                            <iframe id="holidayFrame" style="width:100%; height:700px; border:none; scroll-behavior: smooth;" src=""></iframe>
                        `;
                        document.body.appendChild(modal);
                        let overlay = document.getElementById("modalOverlay");
                        if (!overlay) {
                            overlay = document.createElement("div");
                            overlay.id = "modalOverlay";
                            overlay.className = "modal-overlay";
                            document.body.appendChild(overlay);
                        }
                    }
                    const frame = document.getElementById("holidayFrame");
                    frame.src = `holiday_request.html?employee=${encodeURIComponent(
                        employeeName
                    )}`;
                    modal.style.display = "block";
                    document.getElementById("modalOverlay").style.display = "block";
                }
                //Function for Submitting the Progress Report in the Employee Page.
                function submitProgress() {
                    const progressMessage = document
                        .getElementById("progressMessage")
                        .value.trim();
                    const fileInput = document.getElementById("progressFile");
                    const employee = document
                        .getElementById("employeeDetails")
                        .textContent.split("|")[0]
                        .trim();
                    const now = new Date();
                    if (!progressMessage) {
                        alert("Please enter progress details");
                        return;
                    }
                    //Employee Page Progress Report Section File Handling
                    const file = fileInput.files[0];
                    let fileData = null;
                    let fileName = "";
                    //Condition: Read the file
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            fileData = e.target.result;
                            fileName = file.name;
                            saveProgressWithFile(progressMessage, fileData, fileName);
                        };
                        reader.readAsDataURL(file);
                    }
                    //Otherwise save the progress report without the file.
                    else {
                        saveProgressWithFile(progressMessage, null, "");
                    }
                }
                function saveProgressWithFile(progressMessage, fileData, fileName) {
                    const employee = document.getElementById("employeeDetails").textContent.split("|")[0].trim();
                    const now = new Date();
                    const progressReport = {
                        employee: employee,
                        date: now.toLocaleDateString(),
                        time: now.toLocaleTimeString(),
                        details: progressMessage,
                        fileName: fileName,
                        fileData: fileData,
                        status: "Pending",
                        timestamp: now.getTime() // Add timestamp for better sorting
                    };

                    // Get current progress reports from Firebase first
                    getFirebaseData("progressReports", (firebaseProgressReports) => {
                        // Use Firebase data or fallback to localStorage
                        let progressReports = firebaseProgressReports || JSON.parse(localStorage.getItem("progressReports")) || [];

                        // Add new progress report
                        progressReports.push(progressReport);

                        // Save to Firebase first
                        saveToFirebase("progressReports", progressReports)
                            .then(() => {
                                // Then update localStorage as backup
                                localStorage.setItem("progressReports", JSON.stringify(progressReports));

                                // Reset form
                                document.getElementById("progressMessage").value = "";
                                document.getElementById("progressFile").value = "";
                                document.getElementById("fileName").textContent = "";
                                document.getElementById("fileUploadedIcon").style.display = "none";

                                alert("Progress report submitted successfully!");
                                loadEmployeeProgress();
                            })
                            .catch((error) => {
                                console.error("Error saving progress report to Firebase:", error);

                                // Still save to localStorage as backup
                                localStorage.setItem("progressReports", JSON.stringify(progressReports));

                                // Reset form
                                document.getElementById("progressMessage").value = "";
                                document.getElementById("progressFile").value = "";
                                document.getElementById("fileName").textContent = "";
                                document.getElementById("fileUploadedIcon").style.display = "none";

                                alert("Progress report submitted successfully (saved locally)!");
                                loadEmployeeProgress();
                            });
                    });
                }
                function loadEmployeeProgress() {
                    const employee = document
                        .getElementById("employeeDetails")
                        .textContent.split("|")[0]
                        .trim();
                    const tableBody = document.getElementById("employeeProgressTable");
                    if (!tableBody) return;
                    tableBody.innerHTML = "";

                    // Get data from Firebase
                    const progressRef = firebase.database().ref('progressReports');
                    progressRef.once('value')
                        .then((snapshot) => {
                            const progressReports = snapshot.val() || {};
                            
                            // Convert object to array and filter for current employee
                            const reports = Object.values(progressReports)
                                .filter(report => report.employee === employee)
                                .sort((a, b) => {
                                    const dateA = new Date(a.date + " " + a.time);
                                    const dateB = new Date(b.date + " " + b.time);
                                    return dateB - dateA;
                                });

                            if (reports.length === 0) {
                                const row = document.createElement("tr");
                                row.innerHTML = '<td colspan="6" style="text-align: center;">No progress reports found</td>';
                                tableBody.appendChild(row);
                                return;
                            }

                            reports.forEach((report) => {
                                const statusClass = report.status.toLowerCase();
                                const row = document.createElement("tr");
                                row.innerHTML = `
                                <td>${report.date}</td>
                                <td>${report.time}</td>
                                <td>${report.details}</td>
                                <td>${report.fileName || "No file"}</td>
                                    <td class="status-${statusClass}">${report.status}</td>
                                    <td class="remarks-cell">${report.remarks || 'No remarks yet'}</td>
                            `;
                                tableBody.appendChild(row);
                            });

                            // Update localStorage for offline access
                            localStorage.setItem("progressReports", JSON.stringify(reports));
                        })
                        .catch((error) => {
                            console.error("Error fetching progress reports:", error);
                            // Fallback to localStorage if Firebase fetch fails
                            const progressReports = JSON.parse(localStorage.getItem("progressReports")) || [];
                            const reports = progressReports
                                .filter(report => report.employee === employee)
                                .sort((a, b) => {
                                    const dateA = new Date(a.date + " " + a.time);
                                    const dateB = new Date(b.date + " " + b.time);
                                    return dateB - dateA;
                                });

                            if (reports.length === 0) {
                                const row = document.createElement("tr");
                                row.innerHTML = '<td colspan="6" style="text-align: center;">No progress reports found</td>';
                                tableBody.appendChild(row);
                                return;
                            }

                            reports.forEach((report) => {
                                const statusClass = report.status.toLowerCase();
                                const row = document.createElement("tr");
                                row.innerHTML = `
                                    <td>${report.date}</td>
                                    <td>${report.time}</td>
                                    <td>${report.details}</td>
                                    <td>${report.fileName || "No file"}</td>
                                    <td class="status-${statusClass}">${report.status}</td>
                                    <td class="remarks-cell">${report.remarks || 'No remarks yet'}</td>
                                `;
                                tableBody.appendChild(row);
                            });
                    });
                }
                function loadAdminProgressReports(selectedUser = "") {
                    const tableBody = document.getElementById("adminProgressTable");
                    if (!tableBody) return;
                    tableBody.innerHTML = "";

                    // Get data from Firebase
                    const progressRef = firebase.database().ref('progressReports');
                    progressRef.once('value')
                        .then((snapshot) => {
                            const progressReports = snapshot.val() || {};
                            
                            // Convert object to array and filter if user is selected
                            const reports = Object.values(progressReports)
                                .filter(report => !selectedUser || report.employee === selectedUser)
                                .sort((a, b) => {
                                    const dateA = new Date(a.date + " " + a.time);
                                    const dateB = new Date(b.date + " " + b.time);
                                    return dateB - dateA;
                                });

                            if (selectedUser && reports.length === 0) {
                                const row = document.createElement("tr");
                                row.innerHTML = '<td colspan="8" style="text-align: center;">No progress reports found for this employee</td>';
                                tableBody.appendChild(row);
                                return;
                            }

                            reports.forEach((report) => {
                                const statusClass = report.status.toLowerCase();
                                const row = document.createElement("tr");
                                row.innerHTML = `
                                    <td>${report.employee}</td>
                                    <td>${report.date}</td>
                                    <td>${report.time}</td>
                                    <td>${report.details}</td>
                                    <td>${report.fileName || "No file"}</td>
                                    <td>
                                        ${
                                            report.fileData
                                                ? `<a href="${report.fileData}" download="${report.fileName}" class="download-link">
                                                    <i class="fas fa-download"></i> Download
                                                </a>`
                                                : "No file"
                                        }
                                    </td>
                                    <td>
                                        <select onchange="updateProgressStatus(this.value, '${report.date}', '${report.time}', '${report.employee}')" class="status-${statusClass}">
                                            <option value="Pending" ${report.status === "Pending" ? "selected" : ""}>Pending Review</option>
                                            <option value="Approved" ${report.status === "Approved" ? "selected" : ""}>Approved</option>
                                            <option value="Needs Revision" ${report.status === "Needs Revision" ? "selected" : ""}>Needs Revision</option>
                                </select>
                            </td>
                                    <td>
                                        <div class="remarks-container">
                                            <textarea class="admin-remarks" placeholder="Add remarks..."
                                                onchange="updateProgressRemarks(this.value, '${report.date}', '${report.time}', '${report.employee}')"
                                            >${report.remarks || ''}</textarea>
                                        </div>
                            </td>
                        `;
                                tableBody.appendChild(row);
                            });

                            // Update localStorage for offline access
                            localStorage.setItem("progressReports", JSON.stringify(reports));
                        })
                        .catch((error) => {
                            console.error("Error fetching progress reports:", error);
                            // Fallback to localStorage if Firebase fetch fails
                            const progressReports = JSON.parse(localStorage.getItem("progressReports")) || [];
                            const reports = progressReports
                                .filter(report => !selectedUser || report.employee === selectedUser)
                                .sort((a, b) => {
                                    const dateA = new Date(a.date + " " + a.time);
                                    const dateB = new Date(b.date + " " + b.time);
                                    return dateB - dateA;
                                });

                            if (selectedUser && reports.length === 0) {
                            const row = document.createElement("tr");
                                row.innerHTML = '<td colspan="8" style="text-align: center;">No progress reports found for this employee</td>';
                            tableBody.appendChild(row);
                            return;
                        }

                            reports.forEach((report) => {
                                const statusClass = report.status.toLowerCase();
                                const row = document.createElement("tr");
                                row.innerHTML = `
                            <td>${report.employee}</td>
                            <td>${report.date}</td>
                            <td>${report.time}</td>
                            <td>${report.details}</td>
                                    <td>${report.fileName || "No file"}</td>
                                    <td>
                                        ${
                                            report.fileData
                                                ? `<a href="${report.fileData}" download="${report.fileName}" class="download-link">
                                                    <i class="fas fa-download"></i> Download
                                                </a>`
                                                : "No file"
                                        }
                                    </td>
                                    <td>
                                        <select onchange="updateProgressStatus(this.value, '${report.date}', '${report.time}', '${report.employee}')" class="status-${statusClass}">
                                            <option value="Pending" ${report.status === "Pending" ? "selected" : ""}>Pending Review</option>
                                            <option value="Approved" ${report.status === "Approved" ? "selected" : ""}>Approved</option>
                                            <option value="Needs Revision" ${report.status === "Needs Revision" ? "selected" : ""}>Needs Revision</option>
                                </select>
                            </td>
                                    <td>
                                        <div class="remarks-container">
                                            <textarea class="admin-remarks" placeholder="Add remarks..."
                                                onchange="updateProgressRemarks(this.value, '${report.date}', '${report.time}', '${report.employee}')"
                                            >${report.remarks || ''}</textarea>
                                        </div>
                            </td>
                        `;
                                tableBody.appendChild(row);
                            });
                    });
                }

                function updateProgressStatus(status, date, time, employee) {
                    // Get data from Firebase first
                    getFirebaseData("progressReports", (firebaseProgressReports) => {
                        // Use Firebase data or fallback to localStorage
                        let progressReports =
                            firebaseProgressReports ||
                            JSON.parse(localStorage.getItem("progressReports")) ||
                            [];

                        // Find and update the specific report
                        const reportIndex = progressReports.findIndex(
                            (report) =>
                                report.date === date &&
                                report.time === time &&
                                report.employee === employee
                        );

                        if (reportIndex !== -1) {
                            progressReports[reportIndex].status = status;

                            // Save to Firebase
                            saveToFirebase("progressReports", progressReports)
                                .then(() => {
                                    // Then update localStorage
                                    localStorage.setItem(
                                        "progressReports",
                                        JSON.stringify(progressReports)
                                    );

                                    // Refresh both admin and employee views
                                    loadAdminProgressReports(
                                        document.getElementById("adminUserSelect").value
                                    );
                                    loadEmployeeProgress();
                                })
                                .catch((error) => {
                                    console.error(
                                        "Error updating progress status in Firebase:",
                                        error
                                    );

                                    // Still save to localStorage as backup
                                    localStorage.setItem(
                                        "progressReports",
                                        JSON.stringify(progressReports)
                                    );

                                    // Refresh both admin and employee views
                                    loadAdminProgressReports(
                                        document.getElementById("adminUserSelect").value
                                    );
                                    loadEmployeeProgress();
                                });
                        }
                    });
                }

                function updateProgressRemarks(remarks, date, time, employee) {
                    // Get data from Firebase first
                    getFirebaseData("progressReports", (firebaseProgressReports) => {
                        // Use Firebase data or fallback to localStorage
                        let progressReports =
                            firebaseProgressReports ||
                            JSON.parse(localStorage.getItem("progressReports")) ||
                            [];

                        // Find and update the specific report
                        const reportIndex = progressReports.findIndex(
                            (report) =>
                                report.date === date &&
                                report.time === time &&
                                report.employee === employee
                        );

                        if (reportIndex !== -1) {
                            progressReports[reportIndex].remarks = remarks;

                            // Save to Firebase
                            saveToFirebase("progressReports", progressReports)
                                .then(() => {
                                    // Then update localStorage
                                    localStorage.setItem(
                                        "progressReports",
                                        JSON.stringify(progressReports)
                                    );

                                    // Refresh both admin and employee views
                                    loadAdminProgressReports(
                                        document.getElementById("adminUserSelect").value
                                    );
                                    loadEmployeeProgress();
                                })
                                .catch((error) => {
                                    console.error(
                                        "Error updating progress remarks in Firebase:",
                                        error
                                    );

                                    // Still save to localStorage as backup
                                    localStorage.setItem(
                                        "progressReports",
                                        JSON.stringify(progressReports)
                                    );

                                    // Refresh both admin and employee views
                                    loadAdminProgressReports(
                                        document.getElementById("adminUserSelect").value
                                    );
                                    loadEmployeeProgress();
                                });
                        }
                    });
                }

                function showAdminSection(sectionName) {
                    const sections = [
                        "adminAttendance",
                        "adminProgress",
                        "adminHolidays",
                        "adminTimeTable",
                        "adminTargets",
                        "weeklyAttendance",
                        "adminCompensations"
                    ];
                    sections.forEach((section) => {
                        const element = document.getElementById(section);
                        if (element) element.style.display = "none";
                    });
                    const selectedSection = document.getElementById(sectionName);
                    if (selectedSection) {
                        selectedSection.style.display = "block";
                        const selectedUser =
                            document.getElementById("adminUserSelect")?.value || "";
                        switch (sectionName) {
                            case "adminAttendance":
                                loadAdminData(selectedUser);
                                break;
                            case "adminProgress":
                                loadAdminProgressReports(selectedUser);
                                break;
                            case "adminHolidays":
                                loadAdminHolidayRequests(selectedUser);
                                break;
                            case "adminTimeTable":
                                loadAdminTimeTable(selectedUser);
                                break;
                            case "adminTargets":
                                loadAdminTasks(selectedUser);
                                break;
                            case "weeklyAttendance":
                                loadWeeklyAttendanceSummary();
                                break;
                            case "adminCompensations":
                                loadAdminCompensations(selectedUser);
                                break;
                        }
                    }
                }
                function addUninformedLeave() {
                    const selectedUser =
                        document.getElementById("adminUserSelect").value;
                    if (!selectedUser) {
                        alert("Please select an employee first");
                        return;
                    }
                    const today = new Date();
                    const dateString = today.toLocaleDateString();
                    const dayNames = [
                        "Sunday",
                        "Monday",
                        "Tuesday",
                        "Wednesday",
                        "Thursday",
                        "Friday",
                        "Saturday",
                    ];
                    const dayName = dayNames[today.getDay()];
                    //UNREPOPRTED/UNINFORMED LEAVE FUNCTIONALITY.
                    let holidayRequests =
                        JSON.parse(localStorage.getItem("holidayRequests")) || [];
                    const uninformedLeave = {
                        id: Date.now(),
                        employee: selectedUser,
                        employeeName: selectedUser,
                        startDate: dateString,
                        endDate: dateString,
                        days: 1,
                        reason: "Uninformed Leave",
                        status: "uninformed",
                        requestDate: new Date().toISOString(),
                    };
                    holidayRequests.push(uninformedLeave);
                    localStorage.setItem(
                        "holidayRequests",
                        JSON.stringify(holidayRequests)
                    );
                    alert(
                        `Uninformed leave has been recorded for ${selectedUser} on ${dateString}`
                    );
                    loadAdminHolidayRequests(selectedUser);
                }
                //Admin Holiday Requests Section.
                function loadAdminHolidayRequests(selectedUser = "") {
                    const requests =
                        JSON.parse(localStorage.getItem("holidayRequests")) || [];
                    const tableBody = document.getElementById(
                        "adminHolidayRequestsTable"
                    );
                    const statusFilter = document.getElementById(
                        "holidayStatusFilter"
                    ).value;
                    if (!tableBody) {
                        console.error("Admin holiday requests table not found");
                        return;
                    }
                    tableBody.innerHTML = "";
                    let filteredRequests = requests;
                    if (selectedUser) {
                        filteredRequests = filteredRequests.filter(
                            (request) =>
                                request.employeeName === selectedUser ||
                                request.employee === selectedUser
                        );
                    }
                    if (statusFilter !== "all") {
                        filteredRequests = filteredRequests.filter(
                            (request) => request.status === statusFilter
                        );
                    }
                    if (filteredRequests.length === 0) {
                        const row = document.createElement("tr");
                        row.innerHTML =
                            '<td colspan="7" style="text-align: center;">No holiday requests found</td>';
                        tableBody.appendChild(row);
                        return;
                    }
                    filteredRequests.forEach((request, index) => {
                        const row = document.createElement("tr");
                        row.innerHTML = `
            <td>${request.employeeName || request.employee}</td>
            <td>${request.startDate}</td>
            <td>${request.endDate}</td>
            <td>${request.days}</td>
            <td>${request.reason}</td>
            <td><span class="status-${request.status.toLowerCase()}">${(request.status || "Pending").charAt(0).toUpperCase() +
                            (request.status || "pending").slice(1)
                            }</span></td>
            <td class="action-buttons">
                ${request.status === "pending"
                                ? `
                    <button class="approve-btn" data-id="${request.id}">Approve</button>
                    <button class="reject-btn" data-id="${request.id}">Reject</button>
                `
                                : ""
                            }
            </td>
        `;
                        tableBody.appendChild(row);
                    });
                    function updateHolidayStatus(requestId, newStatus) {
                        let requests =
                            JSON.parse(localStorage.getItem("holidayRequests")) || [];

                        let requestIndex = requests.findIndex(
                            (req) => req.id == requestId
                        );
                        if (requestIndex === -1) {
                            alert("Request not found!");
                            return;
                        }
                        //Update the status
                        requests[requestIndex].status = newStatus;
                        localStorage.setItem("holidayRequests", JSON.stringify(requests));
                        loadAdminHolidayRequests();
                        alert(`Holiday request has been ${newStatus}`);
                    }
                    //Adding event listeners to approve and reject buttons for ADMIN Holiday Requests Section.
                    document.querySelectorAll(".approve-btn").forEach((button) => {
                        button.addEventListener("click", () => {
                            updateHolidayStatus(button.dataset.id, "approved");
                        });
                    });
                    document.querySelectorAll(".reject-btn").forEach((button) => {
                        button.addEventListener("click", () => {
                            updateHolidayStatus(button.dataset.id, "rejected");
                        });
                    });
                }
                function saveHolidayRequest() {
                    const employee = document
                        .getElementById("employeeDetails")
                        .textContent.split("|")[0]
                        .trim();
                    const startDate = document.getElementById("startDate").value;
                    const endDate = document.getElementById("endDate").value;
                    const reason = document.getElementById("reason").value;
                    if (!startDate || !endDate || !reason) {
                        alert("Please fill all fields");
                        return;
                    }
                    let holidayRequests =
                        JSON.parse(localStorage.getItem("holidayRequests")) || [];
                    const requestId = new Date().getTime();
                    holidayRequests.push({
                        id: requestId,
                        employee,
                        startDate,
                        endDate,
                        reason,
                        status: "pending",
                        requestDate: new Date().toISOString(),
                    });
                    localStorage.setItem(
                        "holidayRequests",
                        JSON.stringify(holidayRequests)
                    );
                    alert("Holiday request submitted successfully!");
                }
                //Employee Time Table Section.
                function openTimeTableModal() {
                    const employee = document.getElementById("employeeDetails").textContent.split("|")[0].trim();
                    const currentDate = new Date();
                    const weekStart = getWeekStart(currentDate);
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekStart.getDate() + 6);

                    document.getElementById("modalOverlay").style.display = "block";
                    document.getElementById("timeTableContent").style.display = "block";

                    // Get time table data from Firebase
                    getFirebaseData("timeTables", (firebaseTimeTables) => {
                        const timeTables = firebaseTimeTables || [];
                        const timeTable = timeTables.find(t => t.employee === employee) || {};

                        // Check if timetable was saved this week
                        const isLocked = timeTable.lastSaved && new Date(timeTable.lastSaved) >= weekStart;
                        const isAdminEdited = timeTable.adminEdited && new Date(timeTable.adminEdited) >= weekStart;

                        // Add notice
                        const noticeDiv = document.createElement("div");
                        noticeDiv.className = "notice-div";
                        noticeDiv.style.backgroundColor = "#fff3cd";
                        noticeDiv.style.padding = "15px";
                        noticeDiv.style.marginBottom = "20px";
                        noticeDiv.style.borderRadius = "4px";
                        noticeDiv.style.border = "1px solid #ffeeba";

                        if (isLocked) {
                            if (isAdminEdited) {
                                noticeDiv.innerHTML = `<strong>Notice:</strong> Your timetable for the current week (${weekStart.toLocaleDateString()} - ${weekEnd.toLocaleDateString()}) has been modified by an administrator. You cannot modify it further.`;
                            } else {
                            noticeDiv.innerHTML = `<strong>Notice:</strong> Time table for the current week (${weekStart.toLocaleDateString()} - ${weekEnd.toLocaleDateString()}) has already been set. You cannot modify it. Please contact your administrator for any changes.`;
                            }
                            // Disable all inputs and buttons
                            document.querySelectorAll('#timeTableContent input, #timeTableContent button.add-slot-btn, #timeTableContent button.remove-slot').forEach(el => {
                                el.disabled = true;
                            });
                            document.querySelector('#timeTableContent button.save-timetable-btn').style.display = 'none';
                        } else {
                            noticeDiv.innerHTML = `<strong>Notice:</strong> Please set your time table for the current week (${weekStart.toLocaleDateString()} - ${weekEnd.toLocaleDateString()}). Once saved, it cannot be modified until next week.`;
                            // Enable all inputs and buttons
                            document.querySelectorAll('#timeTableContent input, #timeTableContent button').forEach(el => {
                                el.disabled = false;
                            });
                            document.querySelector('#timeTableContent button.save-timetable-btn').style.display = 'block';
                        }

                        const contentDiv = document.getElementById("timeTableContent");
                        const existingNotice = contentDiv.querySelector(".notice-div");
                        if (existingNotice) {
                            existingNotice.remove();
                        }
                        contentDiv.insertBefore(noticeDiv, contentDiv.firstChild);

                        // Populate the timetable slots
                        populateTimeTableSlots(timeTable);
                    });
                }

                function saveTimeTable() {
                    const employee = document.getElementById("employeeDetails").textContent.split("|")[0].trim();
                        const days = ["monday", "tuesday", "wednesday", "thursday", "friday", "saturday"];
                    
                    // Get current week's start
                    const currentDate = new Date();
                    const weekStart = getWeekStart(currentDate);

                    // Get time table data from Firebase
                    getFirebaseData("timeTables", (firebaseTimeTables) => {
                        const timeTables = firebaseTimeTables || [];
                        const existingTimeTable = timeTables.find(t => t.employee === employee);

                        // Check if timetable was already saved for this week
                        if (existingTimeTable && existingTimeTable.lastSaved) {
                            const lastSavedDate = new Date(existingTimeTable.lastSaved);
                            if (lastSavedDate >= weekStart) {
                                alert("Time table for this week has already been set and cannot be modified.");
                                closeTimeTableModal();
                                return;
                            }
                        }

                        const timeTable = { 
                            employee, 
                            lastSaved: new Date().toISOString(),
                            weekStart: weekStart.toISOString()
                        };

                        // Collect and validate slots for each day
                        let hasValidSlots = false;
                        for (const day of days) {
                            const daySlots = document.getElementById(`${day}Slots`);
                            const slots = [];
                            
                            daySlots.querySelectorAll('.time-slot-row').forEach(row => {
                                const inputs = row.querySelectorAll('input[type="time"]');
                                const checkIn = inputs[0].value;
                                const checkOut = inputs[1].value;

                                if (checkIn && checkOut) {
                                    // Convert times to comparable format
                                    const checkInTime = new Date(`1970-01-01T${checkIn}`);
                                    const checkOutTime = new Date(`1970-01-01T${checkOut}`);

                                    if (checkInTime >= checkOutTime) {
                                        alert(`Check-out time must be after check-in time for ${day}`);
                                        return;
                                    }

                                    slots.push({ checkIn, checkOut });
                                    hasValidSlots = true;
                                }
                            });

                            if (slots.length > 0) {
                                timeTable[day] = { slots };
                            }
                        }

                        if (!hasValidSlots) {
                            alert("Please add at least one valid time slot");
                            return;
                        }

                        handleTimeTableSave(timeTables, timeTable, 
                            () => {
                                alert("Schedule saved successfully!");
                                closeTimeTableModal();
                            },
                            (error) => {
                                console.error("Error saving timetable:", error);
                                alert("Error saving schedule. Please try again.");
                            }
                        );
                    });
                }

                // Admin Timetable Functions
                function openEditTimeTableModal() {
                    const selectedUser = document.getElementById("adminUserSelect").value;
                    if (!selectedUser) {
                        alert("Please select an employee first");
                        return;
                    }

                    document.getElementById("modalOverlay").style.display = "block";
                    document.getElementById("editTimeTableModal").style.display = "block";
                    document.getElementById("editTimeTableContent").style.display = "block";

                    // Get time table data from Firebase
                    getFirebaseData("timeTables", (firebaseTimeTables) => {
                        const timeTables = firebaseTimeTables || [];
                        const timeTable = timeTables.find(t => t.employee === selectedUser) || {};
                        
                        // Populate existing time slots
                        populateEditTimeTableSlots(timeTable);
                    });
                }

                function saveEditedTimeTable() {
                    const selectedUser = document.getElementById("adminUserSelect").value;
                    const days = ["monday", "tuesday", "wednesday", "thursday", "friday", "saturday"];
                    
                    // Get current week's start
                    const currentDate = new Date();
                    const weekStart = getWeekStart(currentDate);

                    const timeTable = {
                        employee: selectedUser,
                        lastSaved: new Date().toISOString(),
                        weekStart: weekStart.toISOString(),
                        adminEdited: new Date().toISOString()
                    };

                    // Collect and validate slots for each day
                    let hasValidSlots = false;
                    for (const day of days) {
                        const daySlots = document.getElementById(`edit${day.charAt(0).toUpperCase() + day.slice(1)}Slots`);
                        const slots = [];

                        daySlots.querySelectorAll('.time-slot-row').forEach(row => {
                            const inputs = row.querySelectorAll('input[type="time"]');
                            const checkIn = inputs[0].value;
                            const checkOut = inputs[1].value;

                            if (checkIn && checkOut) {
                            // Convert times to comparable format
                            const checkInTime = new Date(`1970-01-01T${checkIn}`);
                            const checkOutTime = new Date(`1970-01-01T${checkOut}`);

                            if (checkInTime >= checkOutTime) {
                                alert(`Check-out time must be after check-in time for ${day}`);
                                return;
                            }

                            slots.push({ checkIn, checkOut });
                                hasValidSlots = true;
                            }
                        });

                        if (slots.length > 0) {
                            timeTable[day] = { slots };
                        }
                    }

                    if (!hasValidSlots) {
                        alert("Please add at least one valid time slot");
                        return;
                    }

                    getFirebaseData("timeTables", (firebaseTimeTables) => {
                        handleTimeTableSave(firebaseTimeTables, timeTable,
                            () => {
                                closeEditTimeTableModal();
                                loadAdminTimeTable(selectedUser);
                                alert("Time table updated successfully!");
                            },
                            (error) => {
                                console.error("Error saving time table:", error);
                                alert("Error saving time table. Please try again.");
                            }
                        );
                    });
                }

                // Helper Functions
                function getWeekStart(date) {
                    const weekStart = new Date(date);
                    weekStart.setDate(date.getDate() - (date.getDay() === 0 ? 6 : date.getDay() - 1));
                    weekStart.setHours(0, 0, 0, 0);
                    return weekStart;
                }

                function populateTimeTableSlots(timeTable) {
                        const days = ["monday", "tuesday", "wednesday", "thursday", "friday", "saturday"];

                        days.forEach(day => {
                        const daySlots = document.getElementById(`${day}Slots`);
                        daySlots.innerHTML = ''; // Clear existing slots
                        
                            const slots = timeTable[day]?.slots || [];
                        if (slots.length === 0) {
                            // Add default empty slot
                            addTimeSlot(day);
                        } else {
                            // Add existing slots
                            slots.forEach(slot => {
                                addTimeSlot(day, slot.checkIn, slot.checkOut);
                            });
                        }
                    });
                }

                function populateEditTimeTableSlots(timeTable) {
                        const days = ["monday", "tuesday", "wednesday", "thursday", "friday", "saturday"];

                        days.forEach(day => {
                        const daySlots = document.getElementById(`edit${day.charAt(0).toUpperCase() + day.slice(1)}Slots`);
                        daySlots.innerHTML = ''; // Clear existing slots

                        const slots = timeTable[day]?.slots || [];
                            if (slots.length === 0) {
                            // Add default empty slot
                            addTimeSlot(`edit${day.charAt(0).toUpperCase() + day.slice(1)}`);
                            } else {
                            // Add existing slots
                            slots.forEach(slot => {
                                addTimeSlot(`edit${day.charAt(0).toUpperCase() + day.slice(1)}`, slot.checkIn, slot.checkOut);
                                });
                            }
                        });
                }

                // Weekly Timetable Reset Function
                function resetWeeklyTimetables() {
                    const currentDate = new Date();
                    const weekStart = getWeekStart(currentDate);
                    
                    getFirebaseData("timeTables", (firebaseTimeTables) => {
                        if (!firebaseTimeTables) return;
                        
                        const updatedTimeTables = firebaseTimeTables.map(timeTable => {
                            const tableWeekStart = timeTable.weekStart ? new Date(timeTable.weekStart) : null;
                            
                            // If the timetable is from a previous week, remove the lastSaved and adminEdited flags
                            if (!tableWeekStart || tableWeekStart < weekStart) {
                                const { lastSaved, adminEdited, ...rest } = timeTable;
                                return rest;
                            }
                            return timeTable;
                        });
                        
                        // Save updated timetables to Firebase
                        saveToFirebase("timeTables", updatedTimeTables)
                            .catch(error => console.error("Error resetting weekly timetables:", error));
                    });
                }

                // Set up weekly reset
                setInterval(() => {
                    const now = new Date();
                    if (now.getDay() === 1 && now.getHours() === 0 && now.getMinutes() === 0) {
                        resetWeeklyTimetables();
                    }
                }, 60000); // Check every minute

                function addTimeSlot(day, checkIn, checkOut) {
                    const slotsContainer = document.getElementById(`${day}Slots`);
                    const slotCount = slotsContainer.children.length;

                    const newSlot = document.createElement("div");
                    newSlot.className = "time-slot-row";
                    newSlot.innerHTML = `
                        <input type="time" class="time-input" value="${checkIn}" />
                        <input type="time" class="time-input" value="${checkOut}" />
                        <button class="remove-slot" onclick="removeTimeSlot(this)">×</button>
                `;

                    slotsContainer.appendChild(newSlot);
                }

                function removeTimeSlot(button) {
                    const slotRow = button.parentElement;
                    slotRow.remove();
                }

                function closeTimeTableModal() {
                    document.getElementById("timeTableContent").style.display = "none";
                    document.getElementById("modalOverlay").style.display = "none";
                }
                function showAdminSection(sectionName) {
                    const sections = [
                        "adminAttendance",
                        "adminProgress",
                        "adminHolidays",
                        "adminTimeTable",
                        "adminTargets",
                        "weeklyAttendance",
                        "adminCompensations"
                    ];
                    sections.forEach((section) => {
                        const element = document.getElementById(section);
                        if (element) element.style.display = "none";
                    });
                    const selectedSection = document.getElementById(sectionName);
                    if (selectedSection) {
                        selectedSection.style.display = "block";
                        const selectedUser =
                            document.getElementById("adminUserSelect")?.value || "";
                        switch (sectionName) {
                            case "adminAttendance":
                                loadAdminData(selectedUser);
                                break;
                            case "adminProgress":
                                loadAdminProgressReports(selectedUser);
                                break;
                            case "adminHolidays":
                                loadAdminHolidayRequests(selectedUser);
                                break;
                            case "adminTimeTable":
                                loadAdminTimeTable(selectedUser);
                                break;
                            case "adminTargets":
                                loadAdminTasks(selectedUser);
                                break;
                            case "weeklyAttendance":
                                loadWeeklyAttendanceSummary();
                                break;
                            case "adminCompensations":
                                loadAdminCompensations(selectedUser);
                                break;
                        }
                    }
                }
                function logout() {
                    localStorage.removeItem("loggedInUser");
                    showPage("loginPage");
                    document.getElementById("userName").value = "";
                    document.getElementById("userPassword").value = "";
                }
                function loadAttendanceTable() {
                    const employee = document.getElementById("employeeDetails").textContent.split("|")[0].trim();

                    // Get attendance data from Firebase first
                    getFirebaseData("attendanceRecords", (firebaseAttendanceRecords) => {
                            // Use Firebase data or fallback to localStorage
                        let attendanceRecords = firebaseAttendanceRecords || JSON.parse(localStorage.getItem("attendanceRecords")) || [];

                        // Ensure checkIn and checkOut are always arrays and remove duplicates
                            attendanceRecords = attendanceRecords.map((record) => ({
                                ...record,
                                checkIn: record.checkIn
                                    ? Array.isArray(record.checkIn)
                                    ? [...new Set(record.checkIn)] // Remove duplicates
                                        : [record.checkIn]
                                    : [],
                                checkOut: record.checkOut
                                    ? Array.isArray(record.checkOut)
                                    ? [...new Set(record.checkOut)] // Remove duplicates
                                        : [record.checkOut]
                                    : [],
                            }));

                            // Update localStorage with the latest data
                        localStorage.setItem("attendanceRecords", JSON.stringify(attendanceRecords));

                            const tableBody = document.getElementById("attendanceTable");
                        const adminTableBody = document.getElementById("adminAttendanceTable");

                            // Update employee table
                            if (tableBody) {
                                tableBody.innerHTML = "";
                                const employeeRecords = attendanceRecords
                                    .filter((record) => record.employee === employee)
                                .sort((a, b) => new Date(b.date) - new Date(a.date)); // Sort by date newest first

                                employeeRecords.forEach((record) => {
                                    const mainRow = document.createElement("tr");
                                
                                // Create check-in dropdown HTML with sorted times
                                const checkInOptions = record.checkIn.length > 0
                                    ? record.checkIn
                                        .sort((a, b) => timeToMinutes(a) - timeToMinutes(b)) // Sort times chronologically
                                        .map(time => 
                                            `<option value="${time}" ${record.checkIn[0] === time ? 'selected' : ''}>${time}</option>`
                                        ).join('')
                                    : '<option value="">-</option>';

                                // Create check-out dropdown HTML with sorted times
                                const checkOutOptions = record.checkOut.length > 0
                                    ? record.checkOut
                                        .sort((a, b) => timeToMinutes(a) - timeToMinutes(b)) // Sort times chronologically
                                        .map(time => 
                                            `<option value="${time}" ${record.checkOut[0] === time ? 'selected' : ''}>${time}</option>`
                                        ).join('')
                                    : '<option value="">-</option>';

                                // Get late check-ins
                                const lateCheckIns = JSON.parse(localStorage.getItem('lateCheckIns')) || [];
                                const lateCheckInTimes = lateCheckIns
                                    .filter(late => late.employee === record.employee && late.date === record.date)
                                    .sort((a, b) => timeToMinutes(a.time) - timeToMinutes(b.time)); // Sort times chronologically
                                
                                // Create late check-ins dropdown HTML
                                const lateCheckInOptions = recordLateCheckIns.length > 0
                                    ? recordLateCheckIns.map(late => 
                                        `<option value="${late.time}" ${recordLateCheckIns[0].time === late.time ? 'selected' : ''}>${late.time}</option>`
                                    ).join('')
                                    : '<option value="">-</option>';

                                    mainRow.innerHTML = `
                        <td>${record.date}</td>
                        <td>${record.day}</td>
                                    <td>
                                        <select class="time-select" onchange="updateWorkingHours(this, '${record.date}', '${record.employee}')">
                                            ${checkInOptions}
                                        </select>
                                        ${record.isLate ? '<span class="late-badge">Late</span>' : ''}
                                    </td>
                                    <td>
                                        <select class="time-select" onchange="updateWorkingHours(this, '${record.date}', '${record.employee}')">
                                            ${checkOutOptions}
                                        </select>
                                    </td>
                                    <td>
                                        <select class="time-select" onchange="updateWorkingHours(this, '${record.date}', '${record.employee}')">
                                            ${lateCheckInOptions}
                                        </select>
                                    </td>
                            `;
                                    tableBody.appendChild(mainRow);
                                });
                            }

                            // Update admin table if it exists
                            if (adminTableBody) {
                                adminTableBody.innerHTML = "";
                            const selectedEmployee = document.getElementById("adminUserSelect")?.value;
                                const recordsToShow = selectedEmployee
                                ? attendanceRecords.filter((record) => record.employee === selectedEmployee)
                                    : attendanceRecords;

                                recordsToShow
                                .sort((a, b) => new Date(b.date) - new Date(a.date)) // Sort by date newest first
                                    .forEach((record) => {
                                        const mainRow = document.createElement("tr");

                                        // Ensure arrays and convert times to 24-hour format
                                    const checkIns = (Array.isArray(record.checkIn) ? record.checkIn : [record.checkIn])
                                            .filter((time) => time)
                                        .map((time) => convertTo24Hour(time))
                                        .sort((a, b) => timeToMinutes(a) - timeToMinutes(b)); // Sort times chronologically

                                    const checkOuts = (Array.isArray(record.checkOut) ? record.checkOut : [record.checkOut])
                                            .filter((time) => time)
                                        .map((time) => convertTo24Hour(time))
                                        .sort((a, b) => timeToMinutes(a) - timeToMinutes(b)); // Sort times chronologically

                                        // Create check-in dropdown HTML
                                    const checkInOptions = checkIns.length > 0
                                        ? checkIns.map((time) => `<option value="${time}">${time}</option>`).join("")
                                                : '<option value="">-</option>';

                                        // Create check-out dropdown HTML
                                    const checkOutOptions = checkOuts.length > 0
                                        ? checkOuts.map((time) => `<option value="${time}">${time}</option>`).join("")
                                                : '<option value="">-</option>';

                                        mainRow.innerHTML = `
                                    <td>${record.employee}</td>
                                    <td>${record.date}</td>
                                    <td>${record.day}</td>
                                    <td>
                                            <select class="time-select" onchange="updateWorkingHours(this, '${record.date}', '${record.employee}')">
                                            ${checkInOptions}
                                        </select>
                                            ${record.isLate ? '<span class="late-badge">Late</span>' : ''}
                                    </td>
                                    <td>
                                            <select class="time-select" onchange="updateWorkingHours(this, '${record.date}', '${record.employee}')">
                                            ${checkOutOptions}
                                        </select>
                                    </td>
                                    <td>${record.isLate ? "Yes" : "No"}</td>
                                        <td>${calculateWorkingHours(checkIns, checkOuts, record.isLate ? checkIns : [])}</td>
                                `;
                                        adminTableBody.appendChild(mainRow);
                                    });
                            }
                    });
                }

                function calculateWorkingHours(checkIn, checkOut, lateCheckIns = []) {
                    // Handle invalid inputs
                    if (!checkIn && !checkOut && !lateCheckIns.length) {
                        return "Incomplete";
                    }

                    // Convert inputs to arrays if they're not already
                    const checkIns = Array.isArray(checkIn) ? checkIn : checkIn ? [checkIn] : [];
                    const checkOuts = Array.isArray(checkOut) ? checkOut : checkOut ? [checkOut] : [];
                    const lateChecks = Array.isArray(lateCheckIns) ? lateCheckIns : lateCheckIns ? [lateCheckIns] : [];

                    // Initialize totals
                    let regularHours = 0;
                    let lateHours = 0;

                    // Sort all times chronologically
                    const allCheckIns = [...checkIns].sort((a, b) => timeToMinutes(a) - timeToMinutes(b));
                    const allCheckOuts = [...checkOuts].sort((a, b) => timeToMinutes(a) - timeToMinutes(b));
                    const allLateChecks = [...lateChecks].sort((a, b) => timeToMinutes(a) - timeToMinutes(b));

                    // Validate check-in/check-out pairs
                    for (let i = 0; i < allCheckOuts.length; i++) {
                        const checkOut = allCheckOuts[i];
                        let foundValidCheckIn = false;

                        // Try to find a valid check-in time (either regular or late) that's earlier than this check-out
                        const validCheckIn = [...allCheckIns, ...allLateChecks].find(checkIn => {
                            const checkInTime = timeToMinutes(checkIn);
                            const checkOutTime = timeToMinutes(checkOut);
                            return checkInTime < checkOutTime;
                        });

                        if (!validCheckIn) {
                            return "Invalid: Check-out time is earlier than check-in time";
                        }
                    }

                    // Process each check-out with its corresponding earliest valid check-in
                    let remainingCheckOuts = [...allCheckOuts];
                    let processedCheckIns = new Set();

                    // First try to match regular check-ins
                    for (let i = 0; i < allCheckIns.length; i++) {
                        const currentCheckIn = allCheckIns[i];
                        
                        // Skip if this check-in is marked as late
                        if (allLateChecks.some(late => Math.abs(timeToMinutes(late) - timeToMinutes(currentCheckIn)) < 5)) {
                            continue;
                        }

                        // Find the earliest unused check-out after this check-in
                        const matchingCheckOutIndex = remainingCheckOuts.findIndex(
                            out => timeToMinutes(out) > timeToMinutes(currentCheckIn)
                        );

                        if (matchingCheckOutIndex !== -1) {
                            const matchingCheckOut = remainingCheckOuts[matchingCheckOutIndex];
                            let minutesWorked = timeToMinutes(matchingCheckOut) - timeToMinutes(currentCheckIn);
                            regularHours += minutesWorked / 60;
                            processedCheckIns.add(currentCheckIn);
                            remainingCheckOuts.splice(matchingCheckOutIndex, 1);
                        }
                    }

                    // Then process late check-ins with remaining check-outs
                    for (let i = 0; i < allLateChecks.length; i++) {
                        const lateCheckIn = allLateChecks[i];
                        
                        // Skip if this late check-in was already processed
                        if (processedCheckIns.has(lateCheckIn)) continue;

                        // Find the earliest unused check-out after this late check-in
                        const matchingCheckOutIndex = remainingCheckOuts.findIndex(
                            out => timeToMinutes(out) > timeToMinutes(lateCheckIn)
                        );

                        if (matchingCheckOutIndex !== -1) {
                            const matchingCheckOut = remainingCheckOuts[matchingCheckOutIndex];
                            let minutesWorked = timeToMinutes(matchingCheckOut) - timeToMinutes(lateCheckIn);
                            lateHours += minutesWorked / 60;
                            remainingCheckOuts.splice(matchingCheckOutIndex, 1);
                        }
                    }

                    // Format the output
                    const totalHours = regularHours + lateHours;
                    if (totalHours === 0) {
                        return "0h 0m";
                    } else if (regularHours > 0 && lateHours > 0) {
                        return `${formatHours(regularHours)} + ${formatHours(lateHours)} (late) = ${formatHours(totalHours)}`;
                    } else if (regularHours > 0) {
                        return formatHours(regularHours);
                    } else {
                        return `${formatHours(lateHours)} (late)`;
                    }
                }

                // Helper function to convert time string to minutes
                function timeToMinutes(timeStr) {
                    if (!timeStr) return 0;
                    const [hours, minutes] = timeStr.split(":").map(Number);
                    return hours * 60 + minutes;
                }

                // Helper function to format hours and minutes
                function formatHours(hours) {
                    const wholeHours = Math.floor(hours);
                    const minutes = Math.round((hours - wholeHours) * 60);
                    return `${wholeHours}h ${minutes}m`;
                }

                function addAttendanceRecord(type) {
                    const now = new Date();
                    const employee = document
                        .getElementById("employeeDetails")
                        .textContent.split("|")[0]
                        .trim();
                    const date = now.toLocaleDateString();
                    const day = [
                        "Sunday",
                        "Monday",
                        "Tuesday",
                        "Wednesday",
                        "Thursday",
                        "Friday",
                        "Saturday",
                    ][now.getDay()];
                    const time = now.toLocaleTimeString();

                    // Get current records from Firebase first
                    getFirebaseData("attendanceRecords", (firebaseRecords) => {
                        //Get existing records
                        let attendanceRecords =
                            firebaseRecords ||
                            JSON.parse(localStorage.getItem("attendanceRecords")) ||
                            [];

                        //Find if there's an existing record for today
                        const recordIndex = attendanceRecords.findIndex(
                            (record) => record.employee === employee && record.date === date
                        );

                        if (recordIndex === -1) {
                            //If no record exists for today, create one
                            const newRecord = {
                                employee: employee,
                                date: date,
                                day: day,
                            };
                            if (type === "checkIn") {
                                newRecord.checkIn = time;
                            } else if (type === "checkOut") {
                                newRecord.checkOut = time;
                            }
                            attendanceRecords.push(newRecord);
                        } else {
                            //update existing record.
                            if (type === "checkIn") {
                                attendanceRecords[recordIndex].checkIn = time;
                            } else if (type === "checkOut") {
                                //handle multiple checkouts.
                                if (Array.isArray(attendanceRecords[recordIndex].checkOut)) {
                                    attendanceRecords[recordIndex].checkOut.push(time);
                                } else if (attendanceRecords[recordIndex].checkOut) {
                                    attendanceRecords[recordIndex].checkOut = [
                                        attendanceRecords[recordIndex].checkOut,
                                        time,
                                    ];
                                } else {
                                    attendanceRecords[recordIndex].checkOut = time;
                                }
                            }
                        }

                        // Save to Firebase
                        saveToFirebase("attendanceRecords", attendanceRecords)
                            .then(() => {
                                // Save to localStorage as backup
                                localStorage.setItem(
                                    "attendanceRecords",
                                    JSON.stringify(attendanceRecords)
                                );
                                updateSummaryValues();
                            })
                            .catch((error) => {
                                console.error(
                                    "Error saving attendance record to Firebase:",
                                    error
                                );
                                // Still save to localStorage as backup
                                localStorage.setItem(
                                    "attendanceRecords",
                                    JSON.stringify(attendanceRecords)
                                );
                                updateSummaryValues();
                            });
                    });
                }
                function formatTimeToAMPM(time) {
                    if (!time) return "-";
                    const [hours, minutes] = time.split(":");
                    const hour = parseInt(hours);
                    const ampm = hour >= 12 ? "PM" : "AM";
                    const formattedHour = hour % 12 || 12;
                    return `${formattedHour}:${minutes} ${ampm}`;
                }
                function updateAdminTimeTable(timeTable) {
                    if (!timeTable) return;
                    const days = [
                        "monday",
                        "tuesday",
                        "wednesday",
                        "thursday",
                        "friday",
                        "saturday",
                    ];
                    days.forEach((day) => {
                        if (timeTable[day]) {
                            const checkIn = timeTable[day].checkIn;
                            const checkOut = timeTable[day].checkOut;
                            document.getElementById(
                                `admin${day.charAt(0).toUpperCase() + day.slice(1)}CheckIn`
                            ).textContent = formatTimeToAMPM(checkIn);
                            document.getElementById(
                                `admin${day.charAt(0).toUpperCase() + day.slice(1)}CheckOut`
                            ).textContent = formatTimeToAMPM(checkOut);
                            document.getElementById(
                                `admin${day.charAt(0).toUpperCase() + day.slice(1)}Hours`
                            ).textContent = calculateWorkingHours(checkIn, checkOut);
                        }
                    });
                }
                //Employee Page Summary Section.
                function updateSummaryValues() {
                    const employee = document
                        .getElementById("employeeDetails")
                        .textContent.split("|")[0]
                        .trim();
                    const attendanceRecords =
                        JSON.parse(localStorage.getItem("attendanceRecords")) || [];
                    const lateCheckIns =
                        JSON.parse(localStorage.getItem("lateCheckIns")) || [];
                    const holidayRequests =
                        JSON.parse(localStorage.getItem("holidayRequests")) || [];
                    //Filter records for current/selected employee.
                    const employeeRecords = attendanceRecords.filter(
                        (record) => record.employee === employee
                    );
                    const employeeLateCheckins = lateCheckIns.filter(
                        (record) => record.employee === employee
                    );
                    const employeeHolidays = holidayRequests.filter(
                        (request) =>
                            request.employeeName === employee ||
                            request.employee === employee
                    );
                    //Calculate totals
                    const totalCheckIns = employeeRecords.filter(
                        (record) => record.checkIn
                    ).length;
                    const totalCheckOuts = employeeRecords.reduce((total, record) => {
                        // If checkOut is an array, add its length
                        if (Array.isArray(record.checkOut)) {
                            return total + record.checkOut.length;
                        }
                        //If checkOut is a string (old format), count it as 1
                        else if (record.checkOut) {
                            return total + 1;
                        }
                        return total;
                    }, 0);
                    const totalLateCheckIns = employeeLateCheckins.length;
                    //Total absences.
                    const today = new Date();
                    const startOfMonth = new Date(
                        today.getFullYear(),
                        today.getMonth(),
                        1
                    );
                    const daysInMonth = new Date(
                        today.getFullYear(),
                        today.getMonth() + 1,
                        0
                    ).getDate();
                    let totalAbsences = 0;
                    for (let day = 1; day <= daysInMonth; day++) {
                        const date = new Date(today.getFullYear(), today.getMonth(), day);
                        if (date > today) break;
                        if (date.getDay() === 0 || date.getDay() === 6) continue;
                        const dateString = date.toLocaleDateString();
                        const hasAttendance = employeeRecords.some(
                            (record) => record.date === dateString
                        );
                        const hasApprovedLeave = employeeHolidays.some((leave) => {
                            const startDate = new Date(leave.startDate);
                            const endDate = new Date(leave.endDate);
                            return (
                                startDate <= date &&
                                endDate >= date &&
                                leave.status === "approved"
                            );
                        });
                        if (!hasAttendance && !hasApprovedLeave) {
                            totalAbsences++;
                        }
                    }
                    const unapprovedLeaves = employeeHolidays.filter(
                        (request) =>
                            request.status && request.status.toLowerCase() === "rejected"
                    ).length;
                    document.getElementById("totalCheckIns").textContent =
                        totalCheckIns;
                    document.getElementById("totalCheckOuts").textContent =
                        totalCheckOuts;
                    document.getElementById("lateCheckIns").textContent =
                        totalLateCheckIns;
                    document.getElementById("totalAbsences").textContent =
                        totalAbsences;
                    document.getElementById("unapprovedLeaves").textContent =
                        unapprovedLeaves;
                }
                function handleFileSelect(input) {
                    const file = input.files[0];
                    const fileName = document.getElementById("fileName");
                    const fileUploadedIcon = document.getElementById("fileUploadedIcon");

                    if (file) {
                        fileName.textContent = file.name;
                        fileUploadedIcon.style.display = "inline-block";
                    } else {
                        fileName.textContent = "";
                        fileUploadedIcon.style.display = "none";
                    }
                }
                function closeHolidayModal() {
                    const modal = document.getElementById("holidayModal");
                    const overlay = document.getElementById("modalOverlay");
                    const frame = document.getElementById("holidayFrame");
                    if (modal) modal.style.display = "none";
                    if (overlay) overlay.style.display = "none";
                    if (frame) frame.src = "";
                }
                document
                    .getElementById("holidayRequestForm")
                    .addEventListener("submit", function (e) {
                        e.preventDefault();
                        const employee = document
                            .getElementById("employeeDetails")
                            .textContent.split("|")[0]
                            .trim();
                        const startDate = document.getElementById("startDate").value;
                        const endDate = document.getElementById("endDate").value;
                        const reason = document.getElementById("reason").value;

                        const requests =
                            JSON.parse(localStorage.getItem("holidayRequests")) || [];
                        requests.push({
                            employee,
                            startDate,
                            endDate,
                            reason,
                            status: "pending",
                            requestDate: new Date().toISOString(),
                        });
                        localStorage.setItem("holidayRequests", JSON.stringify(requests));
                        alert("Holiday request submitted successfully!");
                        closeHolidayModal();
                    });
                function generateReport() {
                    const employee = document.getElementById("adminUserSelect").value;
                    const reportType = document.getElementById("reportType").value;
                    if (!employee) {
                        alert("Please select an employee.");
                        return;
                    }
                    const attendanceRecords =
                        JSON.parse(localStorage.getItem("attendanceRecords")) || [];
                    const employeeRecords = attendanceRecords.filter(
                        (record) => record.employee === employee
                    );
                    let filteredRecords = [];
                    const today = new Date();
                    if (reportType === "daily") {
                        const todayStr = today.toLocaleDateString();
                        filteredRecords = employeeRecords.filter(
                            (record) => record.date === todayStr
                        );
                    } else if (reportType === "weekly") {
                        const weekStart = new Date(today);
                        weekStart.setDate(today.getDate() - today.getDay()); //Start of the week (Sunday)
                        filteredRecords = employeeRecords.filter((record) => {
                            const recordDate = new Date(record.date);
                            return recordDate >= weekStart && recordDate <= today;
                        });
                    } else if (reportType === "monthly") {
                        const monthStart = new Date(
                            today.getFullYear(),
                            today.getMonth(),
                            1
                        );
                        filteredRecords = employeeRecords.filter((record) => {
                            const recordDate = new Date(record.date);
                            return recordDate >= monthStart && recordDate <= today;
                        });
                    }
                    if (filteredRecords.length === 0) {
                        alert("No records found for the selected criteria.");
                        return;
                    }
                    downloadCSV(
                        filteredRecords,
                        `${employee}_${reportType}_report.csv`
                    );
                }
                function downloadCSV(data, filename) {
                    let csv = "Date,Day,Check-In Time,Check-Out Time,Late Check-Ins\n";
                    data.forEach((record) => {
                        csv += `${record.date},${record.day},${record.checkIn || "-"},${Array.isArray(record.checkOut)
                            ? record.checkOut.join(" | ")
                            : record.checkOut || "-"
                            },${record.lateCheckIns || "-"}\n`;
                    });
                    const blob = new Blob([csv], { type: "text/csv" });
                    const link = document.createElement("a");
                    link.href = URL.createObjectURL(blob);
                    link.download = filename;
                    link.click();
                }
                // Task Management Functions
                function loadAdminTasks(selectedUser = "") {
                    // Get tasks from Firebase first
                    getFirebaseData("employeeTasks", (firebaseTasks) => {
                        // Use Firebase data or fallback to localStorage
                        const tasks =
                            firebaseTasks ||
                            JSON.parse(localStorage.getItem("employeeTasks")) ||
                            [];

                        // Update localStorage with the latest data from Firebase
                        if (firebaseTasks) {
                            localStorage.setItem(
                                "employeeTasks",
                                JSON.stringify(firebaseTasks)
                            );
                        }

                        const tableBody = document.getElementById("adminTasksTable");
                        if (!tableBody) return;
                        tableBody.innerHTML = "";

                        if (!selectedUser) {
                            tableBody.innerHTML =
                                '<tr><td colspan="7" style="text-align: center;">Please select an employee first</td></tr>';
                            return;
                        }

                        const filteredTasks = tasks.filter(
                            (task) => task.employee === selectedUser
                        );
                        if (filteredTasks.length === 0) {
                            tableBody.innerHTML =
                                '<tr><td colspan="7" style="text-align: center;">No tasks assigned yet</td></tr>';
                            return;
                        }

                        filteredTasks.forEach((task) => {
                            const row = document.createElement("tr");
                            row.innerHTML = `
                <td>${task.date}</td>
                <td>${task.day}</td>
                <td>${task.description}</td>
                <td>${task.fileName
                                    ? `<span class="file-icon">📎</span> ${task.fileName}`
                                    : "No file"
                                }</td>
                <td>${task.status}</td>
                <td>${task.comment}</td>
                <td>
                    <button onclick="deleteTask(${task.id})">Delete</button>
                </td>
            `;
                            tableBody.appendChild(row);
                        });
                    });
                }
                function addNewTask() {
                    const selectedUser =
                        document.getElementById("adminUserSelect").value;
                    if (!selectedUser) {
                        alert("Please select an employee first");
                        return;
                    }
                    const taskDate = document.getElementById("taskDate").value;
                    const taskDay = document.getElementById("taskDay").value;
                    const taskDescription =
                        document.getElementById("taskDescription").value;
                    const taskFileInput = document.getElementById("taskFile");
                    const taskFile = taskFileInput.files[0];
                    if (!taskDate || !taskDescription) {
                        alert("Please fill in all fields");
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        // Get latest tasks from Firebase first
                        getFirebaseData("employeeTasks", (firebaseTasks) => {
                            let tasks =
                                firebaseTasks ||
                                JSON.parse(localStorage.getItem("employeeTasks")) ||
                                [];

                            const newTask = {
                                id: Date.now(),
                                employee: selectedUser,
                                date: taskDate,
                                day: taskDay,
                                description: taskDescription,
                                fileName: taskFile ? taskFile.name : "",
                                fileData: taskFile ? e.target.result : "",
                                status: "Pending",
                                comment: "",
                                saved: true,
                            };

                            tasks.push(newTask);

                            // Save to Firebase first
                            saveToFirebase("employeeTasks", tasks)
                                .then(() => {
                                    // Also save to localStorage
                                    localStorage.setItem(
                                        "employeeTasks",
                                        JSON.stringify(tasks)
                                    );
                                    loadAdminTasks(selectedUser);

                                    // Reset form
                                    document.getElementById("taskDate").value = "";
                                    document.getElementById("taskDay").value = "";
                                    document.getElementById("taskDescription").value = "";
                                    taskFileInput.value = "";
                                })
                                .catch((error) => {
                                    console.error("Error saving new task to Firebase:", error);
                                    // Still save to localStorage as backup
                                    localStorage.setItem(
                                        "employeeTasks",
                                        JSON.stringify(tasks)
                                    );
                                    loadAdminTasks(selectedUser);

                                    // Reset form
                                    document.getElementById("taskDate").value = "";
                                    document.getElementById("taskDay").value = "";
                                    document.getElementById("taskDescription").value = "";
                                    taskFileInput.value = "";

                                    alert(
                                        "Task added and saved locally. There was an issue syncing with the cloud."
                                    );
                                });
                        });
                    };
                    if (taskFile) {
                        reader.readAsDataURL(taskFile);
                    } else {
                        reader.onload();
                    }
                }
                function updateTaskField(taskId, field, value) {
                    // Get latest tasks from Firebase first
                    getFirebaseData("employeeTasks", (firebaseTasks) => {
                        let tasks =
                            firebaseTasks ||
                            JSON.parse(localStorage.getItem("employeeTasks")) ||
                            [];

                        const taskIndex = tasks.findIndex((t) => t.id === taskId);
                        if (taskIndex !== -1) {
                            tasks[taskIndex][field] = value;

                            // Save to Firebase
                            saveToFirebase("employeeTasks", tasks)
                                .then(() => {
                                    // Also update localStorage
                                    localStorage.setItem(
                                        "employeeTasks",
                                        JSON.stringify(tasks)
                                    );
                                })
                                .catch((error) => {
                                    console.error(
                                        "Error updating task field in Firebase:",
                                        error
                                    );
                                    // Still save to localStorage as backup
                                    localStorage.setItem(
                                        "employeeTasks",
                                        JSON.stringify(tasks)
                                    );
                                });
                        }
                    });
                }
                function handleTaskFile(taskId, input) {
                    if (input.files && input.files[0]) {
                        const file = input.files[0];
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            // Get latest tasks from Firebase first
                            getFirebaseData("employeeTasks", (firebaseTasks) => {
                                let tasks =
                                    firebaseTasks ||
                                    JSON.parse(localStorage.getItem("employeeTasks")) ||
                                    [];

                                const taskIndex = tasks.findIndex((t) => t.id === taskId);
                                if (taskIndex !== -1) {
                                    tasks[taskIndex].fileName = file.name;
                                    tasks[taskIndex].fileData = e.target.result;

                                    // Save to Firebase
                                    saveToFirebase("employeeTasks", tasks)
                                        .then(() => {
                                            // Also update localStorage
                                            localStorage.setItem(
                                                "employeeTasks",
                                                JSON.stringify(tasks)
                                            );

                                            const selectedUser =
                                                document.getElementById("adminUserSelect").value;
                                            loadAdminTasks(selectedUser);
                                        })
                                        .catch((error) => {
                                            console.error(
                                                "Error saving task file to Firebase:",
                                                error
                                            );
                                            // Still save to localStorage as backup
                                            localStorage.setItem(
                                                "employeeTasks",
                                                JSON.stringify(tasks)
                                            );

                                            const selectedUser =
                                                document.getElementById("adminUserSelect").value;
                                            loadAdminTasks(selectedUser);
                                        });
                                }
                            });
                        };
                        reader.readAsDataURL(file);
                    }
                }
                function deleteTask(taskId) {
                    if (confirm("Are you sure you want to delete this task?")) {
                        // Get latest tasks from Firebase first
                        getFirebaseData("employeeTasks", (firebaseTasks) => {
                            let tasks =
                                firebaseTasks ||
                                JSON.parse(localStorage.getItem("employeeTasks")) ||
                                [];

                            tasks = tasks.filter((t) => t.id !== taskId);

                            // Save to Firebase
                            saveToFirebase("employeeTasks", tasks)
                                .then(() => {
                                    // Also update localStorage
                                    localStorage.setItem(
                                        "employeeTasks",
                                        JSON.stringify(tasks)
                                    );

                                    const selectedUser =
                                        document.getElementById("adminUserSelect").value;
                                    loadAdminTasks(selectedUser);
                                })
                                .catch((error) => {
                                    console.error("Error deleting task from Firebase:", error);
                                    // Still save to localStorage as backup
                                    localStorage.setItem(
                                        "employeeTasks",
                                        JSON.stringify(tasks)
                                    );

                                    const selectedUser =
                                        document.getElementById("adminUserSelect").value;
                                    loadAdminTasks(selectedUser);

                                    alert(
                                        "Task deleted locally. There was an issue syncing with the cloud."
                                    );
                                });
                        });
                    }
                }
                function saveTask(taskId) {
                    let tasks = JSON.parse(localStorage.getItem("employeeTasks")) || [];
                    const taskIndex = tasks.findIndex((t) => t.id === taskId);
                    if (taskIndex !== -1) {
                        const row = document.querySelector(
                            `tr:has(button[onclick="saveTask(${taskId})"])`
                        );
                        const description = row.querySelector('input[type="text"]').value;
                        const status = row.querySelector("select").value;
                        const comment =
                            row.querySelectorAll('input[type="text"]')[1].value;
                        tasks[taskIndex].description = description;
                        tasks[taskIndex].status = status;
                        tasks[taskIndex].comment = comment;
                        tasks[taskIndex].saved = true;
                        tasks[taskIndex].lastModified = new Date().toISOString();
                        localStorage.setItem("employeeTasks", JSON.stringify(tasks));
                        alert("Task saved successfully!");
                        const selectedUser =
                            document.getElementById("adminUserSelect").value;
                        loadAdminTasks(selectedUser);
                    }
                }
                document
                    .getElementById("taskDate")
                    .addEventListener("change", function () {
                        const date = new Date(this.value);
                        const day = date.toLocaleString("en-US", { weekday: "long" });
                        document.getElementById("taskDay").value = day;
                    });
                document.addEventListener("DOMContentLoaded", function () {
                    const handleUserSelect = () => {
                        const selectedUser =
                            document.getElementById("adminUserSelect").value;
                        document.getElementById("selectedEmployeeName").textContent =
                            selectedUser || "No employee selected";
                        loadAdminData(selectedUser);
                        loadMissedCheckIns(selectedUser);
                        loadAdminProgressReports(selectedUser);
                        loadAdminTimeTable(selectedUser);
                        loadAdminHolidayRequests(selectedUser);
                        loadAdminTasks(selectedUser);
                    };
                    const adminUserSelect = document.getElementById("adminUserSelect");
                    if (adminUserSelect) {
                        adminUserSelect.addEventListener("change", handleUserSelect);
                    }
                });
                // Employee Task Management Functions
                function loadEmployeeTasks() {
                    const employee = document
                        .getElementById("employeeDetails")
                        .textContent.split("|")[0]
                        .trim();

                    // Get tasks from Firebase first
                    getFirebaseData("employeeTasks", (firebaseTasks) => {
                        // Use Firebase data or fallback to localStorage
                        const tasks =
                            firebaseTasks ||
                            JSON.parse(localStorage.getItem("employeeTasks")) ||
                            [];

                        // Update localStorage with the latest data from Firebase
                        if (firebaseTasks) {
                            localStorage.setItem(
                                "employeeTasks",
                                JSON.stringify(firebaseTasks)
                            );
                        }

                        const tableBody = document.getElementById("employeeTasksTable");
                        if (!tableBody) return;
                        tableBody.innerHTML = "";

                        const employeeTasks = tasks
                            .filter(
                                (task) =>
                                    task.employee.trim() === employee.trim() && task.saved
                            )
                            .sort((a, b) => new Date(b.date) - new Date(a.date));

                        if (employeeTasks.length === 0) {
                            tableBody.innerHTML =
                                '<tr><td colspan="6" style="text-align: center;">No tasks assigned</td></tr>';
                            return;
                        }

                        employeeTasks.forEach((task) => {
                            const row = document.createElement("tr");
                            row.innerHTML = `
                <td>${new Date(task.date).toLocaleDateString()}</td>
                <td>${new Date(task.date).toLocaleString("en-US", {
                                weekday: "long",
                            })}</td>
                <td>${task.description}</td>
                <td>${task.fileName
                                    ? `<button onclick="downloadTaskFile('${task.fileName}', '${task.fileData}')">Download</button>`
                                    : "No file"
                                }</td>
                <td>
                    <select onchange="updateEmployeeTaskStatus(${task.id
                                }, this.value)">
                        <option value="Pending" ${task.status === "Pending" ? "selected" : ""
                                }>Pending</option>
                        <option value="Completed" ${task.status === "Completed" ? "selected" : ""
                                }>Completed</option>
                        <option value="Not Achieved" ${task.status === "Not Achieved" ? "selected" : ""
                                }>Not Achieved</option>
                    </select>
                </td>
                <td>
                    <input type="text" value="${task.comment || ""}" 
                        onchange="updateEmployeeTaskComment(${task.id
                                }, this.value)" 
                        placeholder="Add comment here">
                </td>
                <td>
                    <button onclick="saveEmployeeTaskChanges(${task.id
                                })">Save Changes</button>
                </td>
            `;
                            tableBody.appendChild(row);
                        });
                    });
                }
                function updateEmployeeTaskStatus(taskId, status) {
                    // Get latest tasks from Firebase first
                    getFirebaseData("employeeTasks", (firebaseTasks) => {
                        let tasks =
                            firebaseTasks ||
                            JSON.parse(localStorage.getItem("employeeTasks")) ||
                            [];

                        const taskIndex = tasks.findIndex((t) => t.id === taskId);
                        if (taskIndex !== -1) {
                            tasks[taskIndex].status = status;
                            tasks[taskIndex].lastModified = new Date().toISOString();

                            if (status === "Not Achieved" && !tasks[taskIndex].comment) {
                                alert(
                                    "Please add Reason explaining why the task was not achieved."
                                );
                            }

                            // Save to Firebase
                            saveToFirebase("employeeTasks", tasks)
                                .then(() => {
                                    // Also update localStorage
                                    localStorage.setItem(
                                        "employeeTasks",
                                        JSON.stringify(tasks)
                                    );
                                })
                                .catch((error) => {
                                    console.error(
                                        "Error saving task status to Firebase:",
                                        error
                                    );
                                    // Still save to localStorage as backup
                                    localStorage.setItem(
                                        "employeeTasks",
                                        JSON.stringify(tasks)
                                    );
                                });
                        }
                    });
                }
                function updateEmployeeTaskComment(taskId, comment) {
                    // Get latest tasks from Firebase first
                    getFirebaseData("employeeTasks", (firebaseTasks) => {
                        let tasks =
                            firebaseTasks ||
                            JSON.parse(localStorage.getItem("employeeTasks")) ||
                            [];

                        const taskIndex = tasks.findIndex((t) => t.id === taskId);
                        if (taskIndex !== -1) {
                            tasks[taskIndex].comment = comment;
                            tasks[taskIndex].lastModified = new Date().toISOString();

                            // Save to Firebase
                            saveToFirebase("employeeTasks", tasks)
                                .then(() => {
                                    // Also update localStorage
                                    localStorage.setItem(
                                        "employeeTasks",
                                        JSON.stringify(tasks)
                                    );
                                })
                                .catch((error) => {
                                    console.error(
                                        "Error saving task comment to Firebase:",
                                        error
                                    );
                                    // Still save to localStorage as backup
                                    localStorage.setItem(
                                        "employeeTasks",
                                        JSON.stringify(tasks)
                                    );
                                });
                        }
                    });
                }
                function saveEmployeeTaskChanges(taskId) {
                    // Get latest tasks from Firebase first
                    getFirebaseData("employeeTasks", (firebaseTasks) => {
                        let tasks =
                            firebaseTasks ||
                            JSON.parse(localStorage.getItem("employeeTasks")) ||
                            [];

                        const taskIndex = tasks.findIndex((t) => t.id === taskId);
                        if (taskIndex !== -1) {
                            tasks[taskIndex].lastModified = new Date().toISOString();

                            // Save to Firebase
                            saveToFirebase("employeeTasks", tasks)
                                .then(() => {
                                    // Also update localStorage
                                    localStorage.setItem(
                                        "employeeTasks",
                                        JSON.stringify(tasks)
                                    );
                                    alert("Changes saved successfully!");
                                    loadEmployeeTasks();

                                    // Refresh admin panel if it's open
                                    if (
                                        document.getElementById("adminPage").style.display !==
                                        "none"
                                    ) {
                                        const selectedUser =
                                            document.getElementById("adminUserSelect").value;
                                        loadAdminTasks(selectedUser);
                                    }
                                })
                                .catch((error) => {
                                    console.error(
                                        "Error saving task changes to Firebase:",
                                        error
                                    );
                                    // Still save to localStorage as backup
                                    localStorage.setItem(
                                        "employeeTasks",
                                        JSON.stringify(tasks)
                                    );
                                    alert(
                                        "Changes saved locally. There was an issue syncing with the cloud."
                                    );
                                    loadEmployeeTasks();

                                    // Refresh admin panel if it's open
                                    if (
                                        document.getElementById("adminPage").style.display !==
                                        "none"
                                    ) {
                                        const selectedUser =
                                            document.getElementById("adminUserSelect").value;
                                        loadAdminTasks(selectedUser);
                                    }
                                });
                        }
                    });
                }
                function downloadTaskFile(fileName, fileData) {
                    const link = document.createElement("a");
                    link.href = fileData;
                    link.download = fileName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
                function handleCheckOut() {
                    const now = new Date();

                    // Get current records from Firebase first
                    getFirebaseData("attendanceRecords", (firebaseRecords) => {
                        let attendanceRecords =
                            firebaseRecords ||
                            JSON.parse(localStorage.getItem("attendanceRecords")) ||
                            [];

                        const employee = document
                            .getElementById("employeeDetails")
                            .textContent.split("|")[0]
                            .trim();
                        const date = now.toLocaleDateString();
                        const day = [
                            "Sunday",
                            "Monday",
                            "Tuesday",
                            "Wednesday",
                            "Thursday",
                            "Friday",
                            "Saturday",
                        ][now.getDay()];
                        const time = now.toLocaleTimeString();

                        // Find if there's an existing record for today
                        const recordIndex = attendanceRecords.findIndex(
                            (record) => record.employee === employee && record.date === date
                        );

                        if (recordIndex === -1) {
                            // If no record exists for today, create one
                            const newRecord = {
                                employee: employee,
                                date: date,
                                day: day,
                                checkOut: time,
                            };
                            attendanceRecords.push(newRecord);
                        } else {
                            // Update existing record
                            if (Array.isArray(attendanceRecords[recordIndex].checkOut)) {
                                attendanceRecords[recordIndex].checkOut.push(time);
                            } else if (attendanceRecords[recordIndex].checkOut) {
                                attendanceRecords[recordIndex].checkOut = [
                                    attendanceRecords[recordIndex].checkOut,
                                    time,
                                ];
                            } else {
                                attendanceRecords[recordIndex].checkOut = time;
                            }
                        }

                        // Save to Firebase
                        saveToFirebase("attendanceRecords", attendanceRecords)
                            .then(() => {
                                // Save to localStorage as backup
                                localStorage.setItem(
                                    "attendanceRecords",
                                    JSON.stringify(attendanceRecords)
                                );
                                alert("Check-out successful! Time recorded: " + time);
                                loadAttendanceTable();
                                updateSummaryValues();
                            })
                            .catch((error) => {
                                console.error(
                                    "Error saving attendance record to Firebase:",
                                    error
                                );
                                localStorage.setItem(
                                    "attendanceRecords",
                                    JSON.stringify(attendanceRecords)
                                );
                                alert("Check-out successful! Time recorded: " + time);
                                loadAttendanceTable();
                                updateSummaryValues();
                            });
                    });
                }
                function loadAttendanceTable() {
                    const employee = document
                        .getElementById("employeeDetails")
                        .textContent.split("|")[0]
                        .trim();

                    // Get attendance data from Firebase first
                    getFirebaseData("attendanceRecords", (firebaseAttendanceRecords) => {
                            // Use Firebase data or fallback to localStorage
                            let attendanceRecords =
                                firebaseAttendanceRecords ||
                                JSON.parse(localStorage.getItem("attendanceRecords")) ||
                                [];

                        // Ensure checkIn and checkOut are always arrays and remove duplicates
                            attendanceRecords = attendanceRecords.map((record) => ({
                                ...record,
                                checkIn: record.checkIn
                                    ? Array.isArray(record.checkIn)
                                    ? [...new Set(record.checkIn)] // Remove duplicates
                                        : [record.checkIn]
                                    : [],
                                checkOut: record.checkOut
                                    ? Array.isArray(record.checkOut)
                                    ? [...new Set(record.checkOut)] // Remove duplicates
                                        : [record.checkOut]
                                    : [],
                            }));

                            // Update localStorage with the latest data
                        localStorage.setItem("attendanceRecords", JSON.stringify(attendanceRecords));

                            const tableBody = document.getElementById("attendanceTable");
                        const adminTableBody = document.getElementById("adminAttendanceTable");

                            // Update employee table
                            if (tableBody) {
                                tableBody.innerHTML = "";
                                const employeeRecords = attendanceRecords
                                    .filter((record) => record.employee === employee)
                                .sort((a, b) => new Date(b.date) - new Date(a.date)); // Sort by date newest first

                                employeeRecords.forEach((record) => {
                                    const mainRow = document.createElement("tr");
                                    
                                // Create check-in dropdown HTML with sorted times
                                    const checkInOptions = record.checkIn.length > 0
                                    ? record.checkIn
                                        .sort((a, b) => timeToMinutes(a) - timeToMinutes(b)) // Sort times chronologically
                                        .map(time => 
                                            `<option value="${time}" ${record.checkIn[0] === time ? 'selected' : ''}>${time}</option>`
                                        ).join('')
                                        : '<option value="">-</option>';

                                // Create check-out dropdown HTML with sorted times
                                    const checkOutOptions = record.checkOut.length > 0
                                    ? record.checkOut
                                        .sort((a, b) => timeToMinutes(a) - timeToMinutes(b)) // Sort times chronologically
                                        .map(time => 
                                            `<option value="${time}" ${record.checkOut[0] === time ? 'selected' : ''}>${time}</option>`
                                        ).join('')
                                        : '<option value="">-</option>';

                                    // Get late check-ins
                                    const lateCheckIns = JSON.parse(localStorage.getItem('lateCheckIns')) || [];
                                const recordLateCheckIns = lateCheckIns
                                    .filter(late => late.employee === record.employee && late.date === record.date)
                                    .sort((a, b) => timeToMinutes(a.time) - timeToMinutes(b.time)); // Sort times chronologically
                                    
                                    // Create late check-ins dropdown HTML
                                    const lateCheckInOptions = recordLateCheckIns.length > 0
                                        ? recordLateCheckIns.map(late => 
                                            `<option value="${late.time}" ${recordLateCheckIns[0].time === late.time ? 'selected' : ''}>${late.time}</option>`
                                        ).join('')
                                        : '<option value="">-</option>';

                                    mainRow.innerHTML = `
                                        <td>${record.date}</td>
                                        <td>${record.day}</td>
                                        <td>
                                            <select class="time-select" onchange="updateWorkingHours(this, '${record.date}', '${record.employee}')">
                                                ${checkInOptions}
                                            </select>
                                            ${record.isLate ? '<span class="late-badge">Late</span>' : ''}
                                        </td>
                                        <td>
                                            <select class="time-select" onchange="updateWorkingHours(this, '${record.date}', '${record.employee}')">
                                                ${checkOutOptions}
                                            </select>
                                        </td>
                                        <td>
                                            <select class="time-select" onchange="updateWorkingHours(this, '${record.date}', '${record.employee}')">
                                                ${lateCheckInOptions}
                                            </select>
                                        </td>
                                    `;
                                    tableBody.appendChild(mainRow);
                                });
                            }

                            // Update admin table if it exists
                            if (adminTableBody) {
                                adminTableBody.innerHTML = "";
                            const selectedEmployee = document.getElementById("adminUserSelect")?.value;
                                const recordsToShow = selectedEmployee
                                ? attendanceRecords.filter((record) => record.employee === selectedEmployee)
                                    : attendanceRecords;

                                recordsToShow
                                .sort((a, b) => new Date(b.date) - new Date(a.date)) // Sort by date newest first
                                    .forEach((record) => {
                                        const mainRow = document.createElement("tr");

                                        // Ensure arrays and convert times to 24-hour format
                                    const checkIns = (Array.isArray(record.checkIn) ? record.checkIn : [record.checkIn])
                                            .filter((time) => time)
                                        .map((time) => convertTo24Hour(time))
                                        .sort((a, b) => timeToMinutes(a) - timeToMinutes(b)); // Sort times chronologically

                                    const checkOuts = (Array.isArray(record.checkOut) ? record.checkOut : [record.checkOut])
                                            .filter((time) => time)
                                        .map((time) => convertTo24Hour(time))
                                        .sort((a, b) => timeToMinutes(a) - timeToMinutes(b)); // Sort times chronologically

                                        // Create check-in dropdown HTML
                                    const checkInOptions = checkIns.length > 0
                                        ? checkIns.map((time) => `<option value="${time}">${time}</option>`).join("")
                                                : '<option value="">-</option>';

                                        // Create check-out dropdown HTML
                                    const checkOutOptions = checkOuts.length > 0
                                        ? checkOuts.map((time) => `<option value="${time}">${time}</option>`).join("")
                                                : '<option value="">-</option>';

                                        mainRow.innerHTML = `
                                    <td>${record.employee}</td>
                                    <td>${record.date}</td>
                                    <td>${record.day}</td>
                                    <td>
                                            <select class="time-select" onchange="updateWorkingHours(this, '${record.date}', '${record.employee}')">
                                            ${checkInOptions}
                                        </select>
                                            ${record.isLate ? '<span class="late-badge">Late</span>' : ''}
                                    </td>
                                    <td>
                                            <select class="time-select" onchange="updateWorkingHours(this, '${record.date}', '${record.employee}')">
                                            ${checkOutOptions}
                                        </select>
                                    </td>
                                    <td>${record.isLate ? "Yes" : "No"}</td>
                                        <td>${calculateWorkingHours(checkIns, checkOuts, record.isLate ? checkIns : [])}</td>
                                `;
                                        adminTableBody.appendChild(mainRow);
                                    });
                            }
                    });
                }

                function calculateWorkingHours(checkIn, checkOut, lateCheckIns = []) {
                    // Handle invalid inputs
                    if (!checkIn && !checkOut && !lateCheckIns.length) {
                        return "Incomplete";
                    }

                    // Convert inputs to arrays if they're not already
                    const checkIns = Array.isArray(checkIn) ? checkIn : checkIn ? [checkIn] : [];
                    const checkOuts = Array.isArray(checkOut) ? checkOut : checkOut ? [checkOut] : [];
                    const lateChecks = Array.isArray(lateCheckIns) ? lateCheckIns : lateCheckIns ? [lateCheckIns] : [];

                    // Initialize totals
                    let regularHours = 0;
                    let lateHours = 0;

                    // Sort all times chronologically
                    const allCheckIns = [...checkIns].sort((a, b) => timeToMinutes(a) - timeToMinutes(b));
                    const allCheckOuts = [...checkOuts].sort((a, b) => timeToMinutes(a) - timeToMinutes(b));
                    const allLateChecks = [...lateChecks].sort((a, b) => timeToMinutes(a) - timeToMinutes(b));

                    // Validate check-in/check-out pairs
                    for (let i = 0; i < allCheckOuts.length; i++) {
                        const checkOut = allCheckOuts[i];
                        let foundValidCheckIn = false;

                        // Try to find a valid check-in time (either regular or late) that's earlier than this check-out
                        const validCheckIn = [...allCheckIns, ...allLateChecks].find(checkIn => {
                            const checkInTime = timeToMinutes(checkIn);
                            const checkOutTime = timeToMinutes(checkOut);
                            return checkInTime < checkOutTime;
                        });

                        if (!validCheckIn) {
                            return "Invalid: Check-out time is earlier than check-in time";
                        }
                    }

                    // Process each check-out with its corresponding earliest valid check-in
                    let remainingCheckOuts = [...allCheckOuts];
                    let processedCheckIns = new Set();

                    // First try to match regular check-ins
                    for (let i = 0; i < allCheckIns.length; i++) {
                        const currentCheckIn = allCheckIns[i];
                        
                        // Skip if this check-in is marked as late
                        if (allLateChecks.some(late => Math.abs(timeToMinutes(late) - timeToMinutes(currentCheckIn)) < 5)) {
                            continue;
                        }

                        // Find the earliest unused check-out after this check-in
                        const matchingCheckOutIndex = remainingCheckOuts.findIndex(
                            out => timeToMinutes(out) > timeToMinutes(currentCheckIn)
                        );

                        if (matchingCheckOutIndex !== -1) {
                            const matchingCheckOut = remainingCheckOuts[matchingCheckOutIndex];
                            let minutesWorked = timeToMinutes(matchingCheckOut) - timeToMinutes(currentCheckIn);
                            regularHours += minutesWorked / 60;
                            processedCheckIns.add(currentCheckIn);
                            remainingCheckOuts.splice(matchingCheckOutIndex, 1);
                        }
                    }

                    // Then process late check-ins with remaining check-outs
                    for (let i = 0; i < allLateChecks.length; i++) {
                        const lateCheckIn = allLateChecks[i];
                        
                        // Skip if this late check-in was already processed
                        if (processedCheckIns.has(lateCheckIn)) continue;

                        // Find the earliest unused check-out after this late check-in
                        const matchingCheckOutIndex = remainingCheckOuts.findIndex(
                            out => timeToMinutes(out) > timeToMinutes(lateCheckIn)
                        );

                        if (matchingCheckOutIndex !== -1) {
                            const matchingCheckOut = remainingCheckOuts[matchingCheckOutIndex];
                            let minutesWorked = timeToMinutes(matchingCheckOut) - timeToMinutes(lateCheckIn);
                            lateHours += minutesWorked / 60;
                            remainingCheckOuts.splice(matchingCheckOutIndex, 1);
                        }
                    }

                    // Format the output
                    const totalHours = regularHours + lateHours;
                    if (totalHours === 0) {
                        return "0h 0m";
                    } else if (regularHours > 0 && lateHours > 0) {
                        return `${formatHours(regularHours)} + ${formatHours(lateHours)} (late) = ${formatHours(totalHours)}`;
                    } else if (regularHours > 0) {
                        return formatHours(regularHours);
                    } else {
                        return `${formatHours(lateHours)} (late)`;
                    }
                }

                // Helper function to convert time string to minutes
                function timeToMinutes(timeStr) {
                    if (!timeStr) return 0;
                    const [hours, minutes] = timeStr.split(":").map(Number);
                    return hours * 60 + minutes;
                }

                // Helper function to format hours and minutes
                function formatHours(hours) {
                    const wholeHours = Math.floor(hours);
                    const minutes = Math.round((hours - wholeHours) * 60);
                    return `${wholeHours}h ${minutes}m`;
                }

                function addAttendanceRecord(type) {
                    const now = new Date();
                    const employee = document
                        .getElementById("employeeDetails")
                        .textContent.split("|")[0]
                        .trim();
                    const date = now.toLocaleDateString();
                    const day = [
                        "Sunday",
                        "Monday",
                        "Tuesday",
                        "Wednesday",
                        "Thursday",
                        "Friday",
                        "Saturday",
                    ][now.getDay()];
                    const time = now.toLocaleTimeString();
                    // Get existing records
                    let attendanceRecords =
                        JSON.parse(localStorage.getItem("attendanceRecords")) || [];
                    // Find if there's an existing record for today
                    const recordIndex = attendanceRecords.findIndex(
                        (record) => record.employee === employee && record.date === date
                    );
                    if (recordIndex === -1) {
                        const newRecord = {
                            employee: employee,
                            date: date,
                            day: day,
                        };
                        if (type === "checkIn") {
                            newRecord.checkIn = time;
                        } else if (type === "checkOut") {
                            newRecord.checkOut = time;
                        }
                        attendanceRecords.push(newRecord);
                    } else {
                        if (type === "checkIn") {
                            attendanceRecords[recordIndex].checkIn = time;
                        } else if (type === "checkOut") {
                            if (Array.isArray(attendanceRecords[recordIndex].checkOut)) {
                                attendanceRecords[recordIndex].checkOut.push(time);
                            } else if (attendanceRecords[recordIndex].checkOut) {
                                attendanceRecords[recordIndex].checkOut = [
                                    attendanceRecords[recordIndex].checkOut,
                                    time,
                                ];
                            } else {
                                attendanceRecords[recordIndex].checkOut = time;
                            }
                        }
                    }
                    localStorage.setItem(
                        "attendanceRecords",
                        JSON.stringify(attendanceRecords)
                    );
                    updateSummaryValues();
                }
                function recordMissedCheckIn() {
                    const now = new Date();
                    const employee = document
                        .getElementById("employeeDetails")
                        .textContent.split("|")[0]
                        .trim();
                    const date = now.toLocaleDateString();
                    const day = [
                        "Sunday",
                        "Monday",
                        "Tuesday",
                        "Wednesday",
                        "Thursday",
                        "Friday",
                        "Saturday",
                    ][now.getDay()];
                    let missedCheckIns =
                        JSON.parse(localStorage.getItem("missedCheckIns")) || [];
                    const existingRecord = missedCheckIns.find(
                        (record) => record.employee === employee && record.date === date
                    );
                    if (!existingRecord) {
                        missedCheckIns.push({
                            employee: employee,
                            date: date,
                            day: day,
                            notificationSent: false,
                        });
                        localStorage.setItem(
                            "missedCheckIns",
                            JSON.stringify(missedCheckIns)
                        );
                    }
                }
                function loadEmployeeHolidayRequests() {
                    const employee = document
                        .getElementById("employeeDetails")
                        .textContent.split("|")[0]
                        .trim();
                    const holidayRequests =
                        JSON.parse(localStorage.getItem("holidayRequests")) || [];
                    const tableBody = document.getElementById(
                        "employeeHolidayRequestsTable"
                    );
                    if (!tableBody) return;
                    tableBody.innerHTML = "";
                    const employeeRequests = holidayRequests.filter(
                        (request) =>
                            request.employeeName === employee ||
                            request.employee === employee
                    );
                    if (employeeRequests.length === 0) {
                        const row = document.createElement("tr");
                        row.innerHTML =
                            '<td colspan="5" style="text-align: center;">No holiday requests found</td>';
                        tableBody.appendChild(row);
                        return;
                    }
                    //Sort by date, newest first
                    employeeRequests.sort(
                        (a, b) => new Date(b.startDate) - new Date(a.startDate)
                    );
                    employeeRequests.forEach((request) => {
                        const row = document.createElement("tr");
                        row.innerHTML = `
            <td>${request.startDate}</td>
            <td>${request.endDate}</td>
            <td>${request.days || calculateDays(request.startDate, request.endDate)
                            }</td>
            <td>${request.reason}</td>
            <td><span class="status-${request.status}">${(request.status || "Pending").charAt(0).toUpperCase() +
                            (request.status || "pending").slice(1)
                            }</span></td>
        `;
                        tableBody.appendChild(row);
                    });
                }
                function calculateDays(startDate, endDate) {
                    const start = new Date(startDate);
                    const end = new Date(endDate);
                    const diffTime = Math.abs(end - start);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; // +1 to include both start and end days
                    return diffDays;
                }
                // Setup initial data listeners and sync
                function setupDataListeners() {
                    // Get initial data from Firebase and update localStorage
                    const dataKeys = [
                        "users",
                        "attendanceRecords",
                        "lateCheckIns",
                        "missedCheckIns",
                        "holidayRequests",
                        "progressReports",
                        "timeTables",
                        "employeeTasks",
                        "notifications",
                    ];
                    dataKeys.forEach((key) => {
                        getFirebaseData(key, (data) => {
                            if (data) {
                                localStorage.setItem(key, JSON.stringify(data));
                            }
                        });
                    });
                    //Listen for changes in the Firebase Database in real time
                    listenForChanges("users", (users) => {
                        if (users) {
                            localStorage.setItem("users", JSON.stringify(users));
                            //Update the select dropdown in the Admin page
                            const selectElement =
                                document.getElementById("adminUserSelect");
                            if (selectElement) {
                                while (selectElement.options.length > 1) {
                                    selectElement.remove(1);
                                }
                                Object.keys(users).forEach((username) => {
                                    if (username !== "admin") {
                                        const option = document.createElement("option");
                                        option.value = username;
                                        option.textContent = username;
                                        selectElement.appendChild(option);
                                    }
                                });
                            }
                        }
                    });
                    listenForChanges("attendanceRecords", (attendanceRecords) => {
                        if (attendanceRecords) {
                            localStorage.setItem(
                                "attendanceRecords",
                                JSON.stringify(attendanceRecords)
                            );
                            loadAttendanceTable();
                            updateSummaryValues();
                        }
                    });
                    listenForChanges("lateCheckIns", (lateCheckIns) => {
                        if (lateCheckIns) {
                            localStorage.setItem(
                                "lateCheckIns",
                                JSON.stringify(lateCheckIns)
                            );
                            loadAttendanceTable();
                            updateSummaryValues();
                        }
                    });
                    listenForChanges("missedCheckIns", (missedCheckIns) => {
                        if (missedCheckIns)
                            localStorage.setItem(
                                "missedCheckIns",
                                JSON.stringify(missedCheckIns)
                            );
                    });
                    listenForChanges("holidayRequests", (holidayRequests) => {
                        if (holidayRequests) {
                            localStorage.setItem(
                                "holidayRequests",
                                JSON.stringify(holidayRequests)
                            );
                            loadEmployeeHolidayRequests();
                            loadAdminHolidayRequests();
                        }
                    });
                    listenForChanges("progressReports", (progressReports) => {
                        if (progressReports) {
                            localStorage.setItem(
                                "progressReports",
                                JSON.stringify(progressReports)
                            );
                            loadEmployeeProgress();
                            loadAdminProgressReports();
                        }
                    });
                    listenForChanges("timeTables", (timeTables) => {
                        if (timeTables)
                            localStorage.setItem("timeTables", JSON.stringify(timeTables));
                    });
                    listenForChanges("notifications", (notifications) => {
                        if (notifications)
                            localStorage.setItem(
                                "notifications",
                                JSON.stringify(notifications)
                            );
                    });

                    listenForChanges("employeeTasks", (tasks) => {
                        if (tasks) {
                            localStorage.setItem("employeeTasks", JSON.stringify(tasks));

                            // Refresh tasks view if currently visible
                            if (
                                document.getElementById("employeePage").style.display !==
                                "none" &&
                                document.getElementById("employeeTasks-section").style
                                    .display === "block"
                            ) {
                                loadEmployeeTasks();
                            }

                            // Refresh admin tasks view if currently visible
                            if (
                                document.getElementById("adminPage").style.display !==
                                "none" &&
                                document.getElementById("adminTargets").style.display ===
                                "block"
                            ) {
                                const selectedUser =
                                    document.getElementById("adminUserSelect").value;
                                if (selectedUser) loadAdminTasks(selectedUser);
                            }
                        }
                    });
                }
                window.addEventListener("load", setupDataListeners);
                function closeEditTimeTableModal() {
                    document.getElementById("editTimeTableModal").style.display = "none";
                    document.getElementById("editTimeTableContent").style.display = "none";
                    document.getElementById("modalOverlay").style.display = "none";
                }

                // Helper function to convert 12-hour format to 24-hour format
                function convertTo24Hour(timeStr) {
                    if (!timeStr) return null;

                    // If already in 24-hour format (no AM/PM), return as is
                    if (
                        !timeStr.toLowerCase().includes("am") &&
                        !timeStr.toLowerCase().includes("pm")
                    ) {
                        return timeStr;
                    }

                    let [time, modifier] = timeStr.split(" ");
                    let [hours, minutes, seconds] = time.split(":");

                    hours = parseInt(hours);
                    minutes = parseInt(minutes);
                    seconds = seconds ? parseInt(seconds) : 0;

                    if (modifier && modifier.toLowerCase() === "pm" && hours < 12) {
                        hours = hours + 12;
                    }
                    if (modifier && modifier.toLowerCase() === "am" && hours === 12) {
                        hours = 0;
                    }

                    return `${hours.toString().padStart(2, "0")}:${minutes
                        .toString()
                        .padStart(2, "0")}${seconds ? ":" + seconds.toString().padStart(2, "0") : ""
                        }`;
                }

                // Helper function to convert time string to minutes
                function timeToMinutes(timeStr) {
                    if (!timeStr) return 0;

                    // Convert to 24-hour format first
                    const time24 = convertTo24Hour(timeStr);
                    if (!time24) return 0;

                    const [hours, minutes] = time24.split(":").map(Number);
                    return hours * 60 + minutes;
                }
                // Functions for Compensate Hours Section

                function openCompensateHoursModal() {
                    document.getElementById('compensateHoursModal').style.display = 'block';
                }

                function closeCompensateHoursModal() {
                    document.getElementById('compensateHoursModal').style.display = 'none';
                }

                function updateMissedWorkingInfo() {
                    const missedDay = document.getElementById('compensateMissedDay').value;
                    document.getElementById('missedDay').textContent = missedDay.charAt(0).toUpperCase() + missedDay.slice(1);
                    // Update other missed working info dynamically if needed
                }

                function updateCompensateDay() {
                    const compensateDate = document.getElementById('compensateDate').value;
                    if (compensateDate) {
                        const date = new Date(compensateDate);
                        const day = date.toLocaleDateString('en-US', { weekday: 'long' });
                        document.getElementById('compensateDay').value = day;
                    }
                }

                function submitCompensation() {
                    const missedDay = document.getElementById('compensateMissedDay').value;
                    const compensateDate = document.getElementById('compensateDate').value;
                    const checkInTime = document.getElementById('compensateCheckIn').value;
                    const checkOutTime = document.getElementById('compensateCheckOut').value;
                    const reason = document.getElementById('compensateReason').value;

                    if (!missedDay || !compensateDate || !checkInTime || !checkOutTime || !reason) {
                        alert('Please fill in all required fields.');
                        return;
                    }

                    // Prepare the compensation data
                    const compensationData = {
                        missedDay,
                        compensateDate,
                        checkInTime,
                        checkOutTime,
                        reason,
                        status: 'Pending',
                        timestamp: new Date().toISOString(),
                    };

                    // Save the compensation data (e.g., to Firebase or localStorage)
                    const compensations = JSON.parse(localStorage.getItem('compensations')) || [];
                    compensations.push(compensationData);
                    localStorage.setItem('compensations', JSON.stringify(compensations));

                    alert('Compensation submitted successfully!');
                    closeCompensateHoursModal();
                }

                function loadWeeklyAttendanceSummary() {
                    // Get attendance records from Firebase first, then fallback to localStorage
                    getFirebaseData("attendanceRecords", (firebaseAttendanceRecords) => {
                        const attendanceRecords = firebaseAttendanceRecords || JSON.parse(localStorage.getItem("attendanceRecords")) || [];
                        const tableBody = document.getElementById("weeklyAttendanceTable");
                        if (!tableBody) return;

                        // Clear existing table content
                        while (tableBody.rows.length > 1) { // Keep the header row
                            tableBody.deleteRow(1);
                        }

                        // Get all unique employees
                        const employees = [...new Set(attendanceRecords.map(record => record.employee))];

                        // Get current week's start date (Sunday)
                        const today = new Date();
                        const weekStart = new Date(today);
                        weekStart.setDate(today.getDate() - today.getDay());

                        // Create a row for each employee
                        employees.forEach(employee => {
                            const row = document.createElement("tr");
                            row.innerHTML = `<td>${employee}</td>`;

                            // For each day of the week (Sunday to Saturday)
                            for (let i = 0; i < 7; i++) {
                                const currentDate = new Date(weekStart);
                                currentDate.setDate(weekStart.getDate() + i);
                                const dateStr = currentDate.toLocaleDateString();
                                const dayStr = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"][i];

                                // Find attendance record for this day
                                const record = attendanceRecords.find(r => 
                                    r.employee === employee && 
                                    r.date === dateStr
                                );

                                if (record) {
                                    // Format check-in time
                                    const checkIn = record.checkIn ? 
                                        (Array.isArray(record.checkIn) ? record.checkIn[0] : record.checkIn) : 
                                        "-";
                                    
                                    // Format check-out time
                                    const checkOut = record.checkOut ? 
                                        (Array.isArray(record.checkOut) ? record.checkOut[0] : record.checkOut) : 
                                        "-";
                                    
                                    // Calculate working hours
                                    let workingHours = "-";
                                    if (checkIn !== "-" && checkOut !== "-") {
                                        const checkInMinutes = timeToMinutes(checkIn);
                                        const checkOutMinutes = timeToMinutes(checkOut);
                                        const hours = (checkOutMinutes - checkInMinutes) / 60;
                                        workingHours = formatHours(hours);
                                    }

                                    row.innerHTML += `
                                        <td>${checkIn}</td>
                                        <td>${checkOut}</td>
                                        <td>${workingHours}</td>
                                    `;
                                } else {
                                    row.innerHTML += `
                                        <td>-</td>
                                        <td>-</td>
                                        <td>-</td>
                                    `;
                                }
                            }

                            tableBody.appendChild(row);
                        });
                    });
                }

                function downloadWeeklySummary() {
                    const table = document.getElementById("weeklyAttendanceTable");
                    let csv = [];
                    
                    // Get headers
                    const headers = [];
                    const headerRow = table.rows[0];
                    for (let i = 0; i < headerRow.cells.length; i++) {
                        headers.push(headerRow.cells[i].textContent);
                    }
                    csv.push(headers.join(","));

                    // Get data rows
                    for (let i = 1; i < table.rows.length; i++) {
                        const row = table.rows[i];
                        const rowData = [];
                        for (let j = 0; j < row.cells.length; j++) {
                            rowData.push(row.cells[j].textContent);
                        }
                        csv.push(rowData.join(","));
                    }

                    // Create and download CSV file
                    const csvContent = csv.join("\n");
                    const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
                    const link = document.createElement("a");
                    const url = URL.createObjectURL(blob);
                    link.setAttribute("href", url);
                    link.setAttribute("download", "weekly_attendance_summary.csv");
                    link.style.visibility = "hidden";
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }

                function checkAndClearOldTimeTables() {
                    const currentDate = new Date();
                    const weekStart = new Date(currentDate);
                    weekStart.setDate(currentDate.getDate() - (currentDate.getDay() === 0 ? 6 : currentDate.getDay() - 1));
                    weekStart.setHours(0, 0, 0, 0);

                    // Get time table data from Firebase first
                    getFirebaseData("timeTables", (firebaseTimeTables) => {
                        const timeTables = firebaseTimeTables || JSON.parse(localStorage.getItem("timeTables")) || [];
                        let needsUpdate = false;

                        // Check each time table
                        timeTables.forEach((timeTable, index) => {
                            if (timeTable.weekStart) {
                                const savedWeekStart = new Date(timeTable.weekStart);
                                if (savedWeekStart < weekStart) {
                                    // Remove old time table
                                    timeTables.splice(index, 1);
                                    needsUpdate = true;
                                }
                            }
                        });

                        // Update Firebase and localStorage if needed
                        if (needsUpdate) {
                            saveToFirebase("timeTables", timeTables)
                                .then(() => {
                                    localStorage.setItem("timeTables", JSON.stringify(timeTables));
                                })
                                .catch((error) => {
                                    console.error("Error clearing old time tables:", error);
                                });
                        }
                    });
                }

                // Modify the existing window load event listener
                window.addEventListener("load", () => {
                    setupDataListeners();
                    checkAndClearOldTimeTables();
                });

                function togglePasswordVisibility() {
                    const passwordInput = document.getElementById('userPassword');
                    const toggleIcon = document.querySelector('.password-toggle i');
                    
                    if (passwordInput.type === 'password') {
                        passwordInput.type = 'text';
                        toggleIcon.classList.remove('fa-eye');
                        toggleIcon.classList.add('fa-eye-slash');
                    } else {
                        passwordInput.type = 'password';
                        toggleIcon.classList.remove('fa-eye-slash');
                        toggleIcon.classList.add('fa-eye');
                    }
                }

                function handleLateCheckIn() {
                    const now = new Date();
                    const employee = document.getElementById("employeeDetails").textContent.split("|")[0].trim();
                    const date = now.toLocaleDateString();
                    const day = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"][now.getDay()];
                    const time = now.toLocaleTimeString();

                    // Get current late check-ins from Firebase first
                    getFirebaseData("lateCheckIns", (firebaseLateCheckIns) => {
                        let lateCheckIns = firebaseLateCheckIns || JSON.parse(localStorage.getItem("lateCheckIns")) || [];

                        // Add new late check-in record
                        const newLateCheckIn = {
                            employee: employee,
                            date: date,
                            day: day,
                            time: time
                        };
                        lateCheckIns.push(newLateCheckIn);

                        // Save to Firebase first
                        saveToFirebase("lateCheckIns", lateCheckIns)
                            .then(() => {
                                // Save to localStorage as backup
                                localStorage.setItem("lateCheckIns", JSON.stringify(lateCheckIns));
                                alert("Late check-in recorded successfully!");
                                loadAttendanceTable();
                                updateSummaryValues();
                            })
                            .catch((error) => {
                                console.error("Error saving late check-in to Firebase:", error);
                                // Still save to localStorage as backup
                                localStorage.setItem("lateCheckIns", JSON.stringify(lateCheckIns));
                                alert("Late check-in recorded successfully!");
                                loadAttendanceTable();
                                updateSummaryValues();
                            });
                    });
                }

                // Update the timetable check logic
                function checkTimetable(employee, date, day, time) {
                    const currentTime = time;
                    const timetable = JSON.parse(localStorage.getItem("timetable")) || {};
                    const employeeTimetable = timetable[employee] || {};

                    // Get all slots for the current day
                    const daySlots = employeeTimetable[day] || [];
                    
                    // Check if there's a slot that matches the current time
                    const matchingSlot = daySlots.find(slot => {
                        const slotStart = new Date(`1970-01-01T${slot.start}`);
                        const slotEnd = new Date(`1970-01-01T${slot.end}`);
                        const currentTimeDate = new Date(`1970-01-01T${currentTime}`);
                        
                        // Allow check-in 30 minutes before slot start and 2 hours after slot end
                        const earlyCheckIn = new Date(slotStart.getTime() - 30 * 60 * 1000);
                        const lateCheckIn = new Date(slotEnd.getTime() + 2 * 60 * 60 * 1000);
                        
                        return currentTimeDate >= earlyCheckIn && currentTimeDate <= lateCheckIn;
                    });

                    if (matchingSlot) {
                        const slotStart = new Date(`1970-01-01T${matchingSlot.start}`);
                        const slotEnd = new Date(`1970-01-01T${matchingSlot.end}`);
                        const currentTimeDate = new Date(`1970-01-01T${currentTime}`);
                        
                        // Allow check-in 30 minutes before slot start and 2 hours after slot end
                        const earlyCheckIn = new Date(slotStart.getTime() - 30 * 60 * 1000);
                        const lateCheckIn = new Date(slotEnd.getTime() + 2 * 60 * 60 * 1000);

                        if (currentTimeDate >= earlyCheckIn && currentTimeDate <= lateCheckIn) {
                            // Regular check-in
                            recordCheckIn(employee, date, day, time, false);
                        } else if (currentTimeDate > lateCheckIn && currentTimeDate <= new Date(slotEnd.getTime() + 2 * 60 * 60 * 1000)) {
                            // Late check-in window (1-2 hours after scheduled time)
                            if (confirm("You are checking in late. This will be recorded as a late check-in. Continue?")) {
                                recordCheckIn(employee, date, day, time, true);
                            }
                        }
                    } else {
                        alert("You are outside the allowed check-in window for any slot today.");
                    }
                }

                function loadAdminTimeTable(selectedUser = "") {
                    const tableBody = document.getElementById("adminTimeTableBody");
                    if (!tableBody) return;

                    // Clear existing table content
                    tableBody.innerHTML = "";

                    if (!selectedUser) {
                        const row = document.createElement("tr");
                        row.innerHTML = '<td colspan="4" style="text-align: center;">Please select a user to view their time table</td>';
                        tableBody.appendChild(row);
                        return;
                    }

                    // Show loading state
                    const loadingRow = document.createElement("tr");
                    loadingRow.innerHTML = '<td colspan="4" style="text-align: center;">Loading timetable data...</td>';
                    tableBody.appendChild(loadingRow);

                    // Get time table data from Firebase
                    getFirebaseData("timeTables", (firebaseTimeTables) => {
                        // Clear loading state
                        tableBody.innerHTML = "";

                        if (!firebaseTimeTables || !Array.isArray(firebaseTimeTables)) {
                            const errorRow = document.createElement("tr");
                            errorRow.innerHTML = '<td colspan="4" style="text-align: center;">Error loading timetable data. Please try again.</td>';
                            tableBody.appendChild(errorRow);
                            console.error("Invalid timetable data:", firebaseTimeTables);
                            return;
                        }

                        const timeTable = firebaseTimeTables.find(t => t.employee === selectedUser);

                        if (!timeTable) {
                            const row = document.createElement("tr");
                            row.innerHTML = '<td colspan="4" style="text-align: center;">No time table found for this employee</td>';
                            tableBody.appendChild(row);
                            return;
                        }

                        const days = ["monday", "tuesday", "wednesday", "thursday", "friday", "saturday"];
                        let hasData = false;

                        days.forEach(day => {
                            const slots = timeTable[day]?.slots || [];

                            if (slots.length === 0) {
                                // If no slots for this day
                                const row = document.createElement("tr");
                                row.innerHTML = `
                                    <td>${day.charAt(0).toUpperCase() + day.slice(1)}</td>
                                    <td>-</td>
                                    <td>-</td>
                                    <td>-</td>
                                `;
                                tableBody.appendChild(row);
                            } else {
                                hasData = true;
                                // Display each slot for this day
                                slots.forEach((slot, index) => {
                                    const row = document.createElement("tr");
                                    const workingHours = calculateWorkingHours([slot.checkIn], [slot.checkOut]);
                                    row.innerHTML = `
                                        <td>${index === 0 ? day.charAt(0).toUpperCase() + day.slice(1) : ""}</td>
                                        <td>${formatTimeToAMPM(slot.checkIn)}</td>
                                        <td>${formatTimeToAMPM(slot.checkOut)}</td>
                                        <td>${workingHours}</td>
                                    `;
                                    tableBody.appendChild(row);
                                });
                            }
                        });

                        // Update the selected employee name display
                        const selectedEmployeeName = document.getElementById("selectedEmployeeName");
                        if (selectedEmployeeName) {
                            selectedEmployeeName.textContent = selectedUser;
                        }

                        // Show edit button only if data exists
                        const editButton = document.querySelector('.edit-timetable-btn');
                        if (editButton) {
                            editButton.style.display = hasData ? 'block' : 'none';
                        }
                    });
                }

                // Update the setupDataListeners function to handle timetable data
                function setupDataListeners() {
                    // ... existing code ...
                    
                    // Add specific listener for timetables
                    listenForChanges("timeTables", (timeTables) => {
                        if (timeTables) {
                            localStorage.setItem("timeTables", JSON.stringify(timeTables));
                            
                            // Refresh the admin timetable if it's visible
                            const adminTimeTableBody = document.getElementById("adminTimeTableBody");
                            const adminUserSelect = document.getElementById("adminUserSelect");
                            if (adminTimeTableBody && adminUserSelect) {
                                const selectedUser = adminUserSelect.value;
                                if (selectedUser) {
                                    loadAdminTimeTable(selectedUser);
                                }
                            }

                            // Refresh the employee timetable if it's visible
                            const timeTableContent = document.getElementById("timeTableContent");
                            if (timeTableContent && timeTableContent.style.display !== "none") {
                                const employee = document.getElementById("employeeDetails").textContent.split("|")[0].trim();
                                if (employee) {
                                    openTimeTableModal();
                                }
                            }
                        }
                    });
                }

                // Helper function to ensure data consistency
                function validateTimeTableData(timeTable) {
                    if (!timeTable || typeof timeTable !== 'object') return false;
                    
                    const requiredFields = ['employee'];
                    for (const field of requiredFields) {
                        if (!(field in timeTable)) return false;
                    }
                    
                    const days = ["monday", "tuesday", "wednesday", "thursday", "friday", "saturday"];
                    let hasValidDay = false;
                    
                    for (const day of days) {
                        if (day in timeTable) {
                            if (!Array.isArray(timeTable[day]?.slots)) return false;
                            
                            for (const slot of timeTable[day].slots) {
                                if (!slot.checkIn || !slot.checkOut) return false;
                            }
                            if (timeTable[day].slots.length > 0) hasValidDay = true;
                        }
                    }
                    
                    return hasValidDay; // At least one day should have valid slots
                }

                // Add error handling to saveTimeTable and saveEditedTimeTable
                function handleTimeTableSave(timeTables, timeTable, onSuccess, onError) {
                    if (!Array.isArray(timeTables)) {
                        timeTables = [];
                    }

                    if (!validateTimeTableData(timeTable)) {
                        onError(new Error("Invalid timetable data format"));
                        return;
                    }

                    // Find existing timetable for this employee
                    const existingIndex = timeTables.findIndex(t => t.employee === timeTable.employee);
                    
                    if (existingIndex >= 0) {
                        // Preserve existing data that's not being updated
                        const existingTimeTable = timeTables[existingIndex];
                        const days = ["monday", "tuesday", "wednesday", "thursday", "friday", "saturday"];
                        
                        days.forEach(day => {
                            // If the day is not being updated in the new timetable, keep the existing data
                            if (!timeTable[day] && existingTimeTable[day]) {
                                timeTable[day] = existingTimeTable[day];
                            }
                        });

                        // Update the existing timetable
                        timeTables[existingIndex] = {
                            ...existingTimeTable,
                            ...timeTable,
                            lastModified: new Date().toISOString()
                        };
                    } else {
                        // Add new timetable
                        timeTables.push({
                            ...timeTable,
                            lastModified: new Date().toISOString()
                        });
                    }

                    // Save to Firebase
                    saveToFirebase("timeTables", timeTables)
                        .then(() => {
                            onSuccess();
                        })
                        .catch((error) => {
                            console.error("Error saving time table:", error);
                            onError(error);
                        });
                }
            </script>
        </div>
    </div>
</body>

</html>