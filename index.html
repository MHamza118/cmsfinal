<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FSPro</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="firebase.js"></script>
    <style>
        .missed-checkins-section {
            margin-top: 30px;
            border-top: 1px solid #ccc;
            padding-top: 20px;
        }

        .notification-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }

        .notification-btn:hover {
            background-color: #45a049;
        }

        .status-sent {
            color: #666;
            font-style: italic;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        tr:hover {
            background-color: #f5f5f5;
        }

        .status-pending {
            color: #f39c12;
            font-weight: bold;
        }

        .status-approved {
            color: #27ae60;
            font-weight: bold;
        }

        .status-rejected {
            color: #c0392b;
            font-weight: bold;
        }

        .status-uninformed {
            color: #e74c3c;
            font-weight: bold;
            text-decoration: underline;
        }

        .filter-section {
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-section span {
            font-weight: bold;
            color: #333;
        }

        .filter-section select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
            min-width: 120px;
            cursor: pointer;
        }

        .filter-section select:hover {
            border-color: #aaa;
        }

        .filter-section select:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .approve-btn,
        .reject-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .approve-btn {
            background-color: #27ae60;
            color: white;
        }

        .reject-btn {
            background-color: #e74c3c;
            color: white;
        }

        .approve-btn:hover {
            background-color: #219a52;
        }

        .reject-btn:hover {
            background-color: #c0392b;
        }

        #adminHolidays h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .no-requests {
            text-align: center;
            color: #666;
            padding: 20px;
            font-style: italic;
        }

        .notification-icon {
            font-size: 24px;
            cursor: pointer;
            position: relative;
            margin-left: 20px;
        }

        .notification-icon .badge {
            position: absolute;
            top: -5px;
            right: -10px;
            background-color: red;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 12px;
        }

        #notificationPopup {
            display: none;
            position: absolute;
            background-color: white;
            border: 1px solid #ddd;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 10px;
            z-index: 1000;
            width: 200px;
        }

        .summary-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            gap: 20px;
        }

        .summary-item {
            flex: 1;
            text-align: center;
        }

        .summary-item h4 {
            margin: 0;
            color: #495057;
            font-size: 14px;
        }

        .summary-item p {
            margin: 0;
            font-size: 24px;
            font-weight: bold;
            color: #0d6efd;
        }

        .summary-row.values .summary-item {
            padding: 10px;
            background-color: white;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .download-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .download-btn:hover {
            background-color: #45a049;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            width: 90%;
            max-width: 600px;
        }

        .modal-content .close {
            position: absolute;
            right: 20px;
            font-size: 33px;
            font-weight: bold;
            color: white;
            cursor: pointer;
            line-height: 1;
            background-color: #e74c3c;
            border-radius: 20%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding-top: 2px;
        }

        .modal-content .close:hover {
            background-color: #c0392b;
        }

        .modal-content h2 {
            margin-top: 0;
            color: #2c3e50;
            margin-bottom: 20px;
        }

        .modal-content table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .modal-content th {
            background: linear-gradient(135deg, #2596be 0%, #1c7593 100%);
            color: white !important;
            font-weight: 600 !important;
            padding: 16px !important;
            text-align: left;
        }

        .modal-content td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        .modal-content tr:last-child td {
            border-bottom: none;
        }

        .modal-content input[type="time"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
        }

        .modal-content button {
            background: linear-gradient(135deg, #2596be 0%, #1c7593 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            margin-top: 10px;
        }

        .holiday-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            z-index: 1001;
            width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .holiday-modal .section-header {
            padding-bottom: 15px;
            margin-bottom: 20px;
            background: linear-gradient(135deg, #2596be 0%, #1c7593 100%);
            margin: -20px -20px 20px -20px;
            padding: 20px;
            border-radius: 8px 8px 0 0;
            color: white;
            position: relative;
        }

        .holiday-modal .section-header h2 {
            color: white;
            font-size: 1.5em;
            margin: 0;
            font-weight: 600;
        }

        .holiday-modal .close-btn {
            position: absolute;
            right: 20px;
            top: 20px;
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            opacity: 0.8;
        }

        .holiday-modal .close-btn:hover {
            opacity: 1;
        }

        .main-content {
            overflow-y: auto;
            height: calc(100vh - 100px);
        }

        #timeTableContent {
            overflow-y: auto;
            max-height: 600px;
        }

        .edit-btn {
            background: #2596be;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
        }

        .edit-btn:hover {
            background: #1c7593;
        }

        .weekly-summary-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .weekly-summary-table th,
        .weekly-summary-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }

        .weekly-summary-table th {
            background-color: #1c7593;
            color: white;
        }

        .weekly-summary-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .weekly-summary-table tr:hover {
            background-color: #f5f5f5;
        }

        .weekly-summary-table select.time-select {
            width: 100px;
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
        }

        .weekly-summary-table select.time-select:hover {
            border-color: #1c7593;
        }

        .weekly-summary-table select.time-select:focus {
            outline: none;
            border-color: #1c7593;
            box-shadow: 0 0 3px rgba(28, 117, 147, 0.3);
        }

        @media screen and (max-width: 768px) {
            .weekly-summary-table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }

            .weekly-summary-table select.time-select {
                width: 80px;
                font-size: 12px;
            }
        }
    </style>
</head>

<body>
    <!-- Login Page -->
    <div id="loginPage">
        <div class="login-container">
            <h1>FSPro Login</h1>
            <input type="text" id="userName" placeholder="Username" />
            <div class="password-field">
                <input type="password" id="userPassword" placeholder="Password" />
                <span class="password-toggle" onclick="togglePasswordVisibility()">
                    <i class="fas fa-eye"></i>
                </span>
            </div>
            <button id="loginBtn">Login</button>
        </div>
    </div>
    <!-- Employee Page -->
    <div id="employeePage" style="display: none">
        <div class="header">
            <div class="logo">FSPro</div>
            <div class="select-employee">
                <span id="currentDate"></span>
                <span id="currentTime"></span>
                <div class="notification-icon" onclick="toggleNotificationPopup()">
                    <i class="fas fa-bell"></i>
                    <span class="badge" id="notificationCount">0</span>
                </div>
                <div id="notificationPopup">
                    <h4>Notifications</h4>
                    <div id="notificationList"></div>
                </div>
            </div>
        </div>
        <div class="summary-section">
            <div class="summary-row headings">
                <div class="summary-item">
                    <h4>Total Check-Ins</h4>
                </div>
                <div class="summary-item">
                    <h4>Total Check-Outs</h4>
                </div>
                <div class="summary-item">
                    <h4>Late Check-Ins</h4>
                </div>
                <div class="summary-item">
                    <h4>Total Absences</h4>
                </div>
                <div class="summary-item">
                    <h4>Unapproved Leaves</h4>
                </div>
            </div>
            <div class="summary-row values">
                <div class="summary-item">
                    <p id="totalCheckIns">0</p>
                </div>
                <div class="summary-item">
                    <p id="totalCheckOuts">0</p>
                </div>
                <div class="summary-item">
                    <p id="lateCheckIns">0</p>
                </div>
                <div class="summary-item">
                    <p id="totalAbsences">0</p>
                </div>
                <div class="summary-item">
                    <p id="unapprovedLeaves">0</p>
                </div>
            </div>
        </div>
        <!-- Employee Page Hamburgur menu icon MOBILE RESPONSIVENESS -->
        <div class="container">
            <div class="hamburger-menu" onclick="toggleMobileMenu()">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <div class="sidebar-overlay" onclick="closeMobileMenu()"></div>
            <div class="left-sidebar">
                <button onclick="showSection('attendance'); closeMobileMenu()">Check In/Out</button>
                <button onclick="showSection('progress'); closeMobileMenu()">Daily Progress Report</button>
                <button onclick="openHolidayRequest(); closeMobileMenu()">Request for Holiday</button>
                <button onclick="openTimeTableModal(); closeMobileMenu()">Time Table</button>
                <button onclick="showSection('employeeTasks'); closeMobileMenu()">View Tasks</button>
                <button onclick="openCompensateHoursModal(); closeMobileMenu();">Compensate Hours</button>
                <button onclick="logout()">Logout</button>
            </div>
            <div id="modalOverlay" onclick="closeTimeTableModal()"></div>
            <div class="modal-content" id="timeTableContent">
                <span class="close" onclick="closeTimeTableModal()"><i class="fa-solid fa-xmark"></i></span>
                <h2>Set Your Time Table</h2>
                <div class="timetable-day-container">
                    <div class="day-heading">Monday</div>
                    <div id="mondaySlots" class="time-slots">
                        <div class="time-slot-row">
                            <input type="time" class="time-input" />
                            <input type="time" class="time-input" />
                            <button class="remove-slot" onclick="removeTimeSlot(this)">Ã—</button>
                        </div>
                    </div>
                    <button class="add-slot-btn" onclick="addTimeSlot('monday')">+ Add Time Slot</button>
                    <div class="day-heading">Tuesday</div>
                    <div id="tuesdaySlots" class="time-slots">
                        <div class="time-slot-row">
                            <input type="time" class="time-input" />
                            <input type="time" class="time-input" />
                            <button class="remove-slot" onclick="removeTimeSlot(this)">Ã—</button>
                        </div>
                    </div>
                    <button class="add-slot-btn" onclick="addTimeSlot('tuesday')">+ Add Time Slot</button>
                    <div class="day-heading">Wednesday</div>
                    <div id="wednesdaySlots" class="time-slots">
                        <div class="time-slot-row">
                            <input type="time" class="time-input" />
                            <input type="time" class="time-input" />
                            <button class="remove-slot" onclick="removeTimeSlot(this)">Ã—</button>
                        </div>
                    </div>
                    <button class="add-slot-btn" onclick="addTimeSlot('wednesday')">+ Add Time Slot</button>
                    <div class="day-heading">Thursday</div>
                    <div id="thursdaySlots" class="time-slots">
                        <div class="time-slot-row">
                            <input type="time" class="time-input" />
                            <input type="time" class="time-input" />
                            <button class="remove-slot" onclick="removeTimeSlot(this)">Ã—</button>
                        </div>
                    </div>
                    <button class="add-slot-btn" onclick="addTimeSlot('thursday')">+ Add Time Slot</button>
                    <div class="day-heading">Friday</div>
                    <div id="fridaySlots" class="time-slots">
                        <div class="time-slot-row">
                            <input type="time" class="time-input" />
                            <input type="time" class="time-input" />
                            <button class="remove-slot" onclick="removeTimeSlot(this)">Ã—</button>
                        </div>
                    </div>
                    <button class="add-slot-btn" onclick="addTimeSlot('friday')">+ Add Time Slot</button>
                    <div class="day-heading">Saturday</div>
                    <div id="saturdaySlots" class="time-slots">
                        <div class="time-slot-row">
                            <input type="time" class="time-input" />
                            <input type="time" class="time-input" />
                            <button class="remove-slot" onclick="removeTimeSlot(this)">Ã—</button>
                        </div>
                    </div>
                    <button class="add-slot-btn" onclick="addTimeSlot('saturday')">+ Add Time Slot</button>
                </div>
                <button class="save-timetable-btn" onclick="saveTimeTable()">Save Changes</button>
            </div>
            <div class="main-content">
                <div class="employee-header" id="employeeHeader">
                    <p id="employeeDetails">Hamza | ID: 118</p>
                    <div class="action-buttons">
                        <button onclick="handleCheckIn()">Check In</button>
                        <button onclick="handleCheckOut()">Check Out</button>
                        <button id="lateCheckInBtn" onclick="handleLateCheckIn()">Add Late Check-In</button>
                    </div>
                </div>
                <!-- Compensate Hours Modal -->
                <div id="compensateHoursModal" class="modal-content compensation-popup"
                    style="display: none; max-width: 600px">
                    <span class="close" onclick="closeCompensateHoursModal()"><i class="fa-solid fa-xmark"></i></span>
                    <h2>Compensate Working Hours</h2>
                    <!-- Missed working hours section -->
                    <div class="section-header-small">
                        <h3>Missed Working Hours</h3>
                    </div>
                    <div class="time-table-row">
                        <div id="missedWorkingHoursInfo" class="missed-hours-container">
                            <table class="compensate-table">
                                <tr>
                                    <th>Day</th>
                                    <th>Date</th>
                                    <th>Scheduled Hours</th>
                                </tr>
                                <tr>
                                    <td id="missedDay">-</td>
                                    <td id="missedDate">-</td>
                                    <td>
                                        <select id="missedHoursSelect" style="width: 100%; padding: 8px">
                                            <option value="">No scheduled slots found</option>
                                        </select>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="compensateMissedDay">Select missed working day</label>
                        <select id="compensateMissedDay" required onchange="updateMissedWorkingInfo()">
                            <option value="" disabled selected>
                                Select missed working day
                            </option>
                            <option value="monday">Monday</option>
                            <option value="tuesday">Tuesday</option>
                            <option value="wednesday">Wednesday</option>
                            <option value="thursday">Thursday</option>
                            <option value="friday">Friday</option>
                            <option value="saturday">Saturday</option>
                        </select>
                    </div>
                    <div class="section-header-small">
                        <h3>Select Compensation Date</h3>
                    </div>
                    <div class="form-group">
                        <label for="compensateDate">Date for Compensation</label>
                        <input type="date" id="compensateDate" required placeholder="Compensation Date"
                            onchange="updateCompensateDay()" />
                    </div>
                    <div class="form-group">
                        <label for="compensateDay">Day</label>
                        <input type="text" id="compensateDay" readonly placeholder="Day" />
                    </div>
                    <div class="section-header-small">
                        <h3>Compensation Hours</h3>
                    </div>
                    <div class="time-table-row">
                        <div class="form-group">
                            <label for="compensateCheckIn">Check-in Time</label>
                            <input type="time" id="compensateCheckIn" required placeholder="Check-in Time" />
                        </div>
                        <div class="form-group">
                            <label for="compensateCheckOut">Check-out Time</label>
                            <input type="time" id="compensateCheckOut" required placeholder="Check-out Time" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="compensateReason">Reason for Compensation</label>
                        <textarea id="compensateReason" rows="3" required
                            placeholder="Please provide a reason for compensation"></textarea>
                    </div>
                    <button class="save-timetable" onclick="submitCompensation()">Submit Compensation</button>
                </div>
                <!-- Attendance Section -->
                <div id="attendance-section" class="section" style="display: block">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Day</th>
                                <th>Check-In Time</th>
                                <th>Check-Out Time</th>
                                <th>Late Check-Ins</th>
                                <th>Working Hours</th>
                            </tr>
                        </thead>
                        <tbody id="attendanceTable"></tbody>
                    </table>
                </div>
                <!-- Progress Section -->
                <div id="progress-section" class="section" style="display: none">
                    <h2>Submit Daily Progress</h2>
                    <div class="form-group">
                        <textarea id="progressMessage" rows="4" required
                            placeholder="Enter your progress details here..."></textarea>
                    </div>
                    <div class="file-upload-container">
                        <label for="progressFile" class="file-upload-label">
                            <span class="file-icon">ðŸ“Ž</span>
                            <span>Attach File</span>
                            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24' height='24'%3E%3Cpath fill='%234CAF50' d='M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z'/%3E%3C/svg%3E"
                                id="fileUploadedIcon" style="display: none; margin-left: 5px; vertical-align: middle;"
                                alt="File uploaded" />
                        </label>
                        <input type="file" id="progressFile" hidden onchange="handleFileSelect(this)" />
                        <span id="fileName"></span>
                    </div>
                    <div class="submit-container">
                        <button onclick="submitProgress()" class="submit-progress">Submit Progress</button>
                    </div>
                    <div id="progressList">
                        <h3>Your Previous Reports</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Time</th>
                                    <th>Details</th>
                                    <th>File</th>
                                    <th>Status</th>
                                    <th>Admin Remarks</th>
                                </tr>
                            </thead>
                            <tbody id="employeeProgressTable"></tbody>
                        </table>
                    </div>
                </div>
                <!-- Holiday Requests Section -->
                <div id="holidayRequests" class="section" style="display: none">
                    <h2>Your Holiday Requests</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Start Date</th>
                                <th>End Date</th>
                                <th>Days</th>
                                <th>Reason</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="employeeHolidayRequestsTable"></tbody>
                    </table>
                </div>
                <!-- Employee Tasks Section -->
                <div id="employeeTasks-section" class="section" style="display: none">
                    <h2>My Tasks:</h2>
                    <h4>Complete the Assigned Tasks for the Day.</h4>
                    <div class="task-filters">
                        <select id="taskStatusFilter" onchange="filterEmployeeTasks()" style="padding: 5px; margin-right: 10px;">
                            <option value="all">All Tasks</option>
                            <option value="Pending">Pending</option>
                            <option value="Completed">Completed</option>
                            <option value="Not Achieved">Not Achieved</option>
                        </select>
                        <select id="taskDateFilter" onchange="filterEmployeeTasks()" style="padding: 5px;">
                            <option value="all">All Dates</option>
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                        </select>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Day</th>
                                <th>Description</th>
                                <th>File</th>
                                <th>Status</th>
                                <th>Reason</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="employeeTasksTable"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <!-- Admin Page -->
    <div id="adminPage" style="display: none">
        <div class="header">
            <div class="logo">FSPro Admin</div>
            <div class="admin-controls">
                <select id="adminUserSelect" onchange="handleUserSelect()">
                    <option value="">Select Employee</option>
                    <option value="hamza">Hamza</option>
                    <option value="zain">Zain</option>
                    <option value="hanzallah">Hanzallah</option>
                </select>
                <button id="addEmployeeBtn" onclick="openAddEmployeeModal()" style="background: white">Add
                    Employee</button>
                <button id="uninformedLeaveBtn" onclick="addUninformedLeave()" style="background: white">Uninformed
                    Leave</button>
            </div>
            <!-- Add Employee Modal -->
            <div id="addEmployeeModal" class="modal">
                <div class="modal-content" id="addEmployeeContent" style="display: block; max-width: 500px">
                    <span class="close" onclick="closeAddEmployeeModal()"><i class="fa-solid fa-xmark"></i></span>
                    <h2>Add New Employee</h2>
                    <div class="form-group">
                        <label for="newUsername"></label>
                        <input type="text" id="newUsername" placeholder="Enter username" />
                    </div>
                    <div class="form-group">
                        <label for="newPassword"></label>
                        <input type="password" id="newPassword" placeholder="Enter password" />
                    </div>
                    <div class="form-group">
                        <label for="newEmployeeId"></label>
                        <input type="text" id="newEmployeeId" placeholder="Enter employee ID" />
                    </div>
                    <div class="form-group">
                        <label for="newEmployeePhone"></label>
                        <input type="text" id="newEmployeePhone" placeholder="Phone Number (with country code)" />
                    </div>
                    <div class="form-group">
                        <label for="newEmployeeEmail"></label>
                        <input type="email" id="newEmployeeEmail" placeholder="Enter employee email" />
                    </div>
                    <div style="display: flex; gap: 10px">
                        <button onclick="addNewEmployee()">Add Employee</button>
                        <button onclick="deleteEmployee()">Delete Employee</button>
                    </div>
                    <div class="form-group" style="margin-top: 20px">
                        <label for="deleteEmployeeSelect"></label>
                        <select id="deleteEmployeeSelect"
                            style=" width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="">Select an employee</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        <!--  Admin Page Hamburger Menu FOR MOBILE RESPONSIVENESS-->
        <div class="container">
            <div class="hamburger-menu" onclick="toggleAdminMobileMenu()">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <div class="sidebar-overlay" onclick="closeAdminMobileMenu()"></div>
            <div class="left-sidebar">
                <div class="main-buttons">
                    <button onclick="showAdminSection('adminAttendance'); closeAdminMobileMenu();"
                        class="active">Attendance</button>
                    <button onclick="showAdminSection('weeklyAttendance'); closeAdminMobileMenu();">Weekly Attendance
                        Summary</button>
                    <button onclick="showAdminSection('adminProgress'); closeAdminMobileMenu();">Progress
                        Reports</button>
                    <button onclick="showAdminSection('adminHolidays'); closeAdminMobileMenu();">Holiday
                        Requests</button>
                    <button onclick="showAdminSection('adminTimeTable'); closeAdminMobileMenu();">View Time
                        Table</button>
                    <button onclick="showAdminSection('adminTargets'); closeAdminMobileMenu();">Assign Tasks</button>
                    <button onclick="showAdminSection('adminCompensations'); closeAdminMobileMenu();">Compensation
                        Records</button>
                    <button onclick="logout()">Logout</button>
                </div>
                <div class="bottom-buttons"></div>
            </div>
            <!--Admin Page main content Data-->
            <div class="main-content">
                <div id="adminCompensations" style="display: none">
                    <h2>Employee Compensation Records</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Employee</th>
                                <th>Missed Date</th>
                                <th>Missed Day</th>
                                <th>Compensation Date</th>
                                <th>Reason</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="adminCompensationsTable"></tbody>
                    </table>
                </div>
                <div class="main-content">
                    <div id="adminAttendance" style="display: block">
                        <h2>Employee Attendance</h2>
                        <select id="reportType"
                            style=" padding: 8px; border-radius: 5px; background-color: #2596be; color: white;">
                            <option value="daily">Daily Report</option>
                            <option value="weekly">Weekly Report</option>
                            <option value="monthly">Monthly Report</option>
                        </select>
                        <button onclick="generateReport()"
                            style="color: white; padding: 8px; border: 1px solid black"><i
                                class="fa-solid fa-download"></i></button>
                        <table>
                            <thead>
                                <tr>
                                    <th>Employee</th>
                                    <th>Date</th>
                                    <th>Day</th>
                                    <th>Check-In Time</th>
                                    <th>Check-Out Time</th>
                                    <th>Late Check-Ins</th>
                                    <th>Working Hours</th>
                                </tr>
                            </thead>
                            <tbody id="adminAttendanceTable"></tbody>
                        </table>
                        <div class="missed-checkins-section">
                            <h2>Missed Check Ins</h2>
                            <table id="MissedCheckInsTable">
                                <thead>
                                    <tr>
                                        <th>Employee Name</th>
                                        <th>Notification Sent</th>
                                        <th>Date</th>
                                        <th>Day</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <!-- Summary of Missed Check-Ins -->
                        <div class="summary-section">
                            <h3>Summary of Missed Check-Ins</h3>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Total Missed Check-Ins</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td id="totalMissedCheckIns">0</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <!-- Time Table Section -->
                    <div id="adminTimeTable" style="display: none" class="admin-timetable-section">
                        <div class="section-header">
                            <h2>Employee Time Table</h2>
                            <p class="selected-employee">Viewing schedule for:<span id="selectedEmployeeName">No
                                    employee selected</span></p>
                        </div>
                        <button onclick="openEditTimeTableModal()" class="edit-timetable-btn">Edit Time Table</button>
                        <div class="timetable-container">
                            <table class="admin-timetable">
                                <thead>
                                    <tr>
                                        <th>Day</th>
                                        <th>Check In Time</th>
                                        <th>Check Out Time</th>
                                        <th>Working Hours</th>
                                    </tr>
                                </thead>
                                <tbody id="adminTimeTableBody">
                                    <tr>
                                        <td>Monday</td>
                                        <td id="adminMondayCheckIn">-</td>
                                        <td id="adminMondayCheckOut">-</td>
                                        <td id="adminMondayHours">-</td>
                                    </tr>
                                    <tr>
                                        <td>Tuesday</td>
                                        <td id="adminTuesdayCheckIn">-</td>
                                        <td id="adminTuesdayCheckOut">-</td>
                                        <td id="adminTuesdayHours">-</td>
                                    </tr>
                                    <tr>
                                        <td>Wednesday</td>
                                        <td id="adminWednesdayCheckIn">-</td>
                                        <td id="adminWednesdayCheckOut">-</td>
                                        <td id="adminWednesdayHours">-</td>
                                    </tr>
                                    <tr>
                                        <td>Thursday</td>
                                        <td id="adminThursdayCheckIn">-</td>
                                        <td id="adminThursdayCheckOut">-</td>
                                        <td id="adminThursdayHours">-</td>
                                    </tr>
                                    <tr>
                                        <td>Friday</td>
                                        <td id="adminFridayCheckIn">-</td>
                                        <td id="adminFridayCheckOut">-</td>
                                        <td id="adminFridayHours">-</td>
                                    </tr>
                                    <tr>
                                        <td>Saturday</td>
                                        <td id="adminSaturdayCheckIn">-</td>
                                        <td id="adminSaturdayCheckOut">-</td>
                                        <td id="adminSaturdayHours">-</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <!-- Edit Time Table Modal -->
                        <div id="editTimeTableModal" class="modal">
                            <div class="modal-content" id="editTimeTableContent">
                                <span class="close" onclick="closeEditTimeTableModal()"><i
                                        class="fa-solid fa-xmark"></i></span>
                                <h2>Edit Time Table</h2>
                                <div class="timetable-day-container">
                                    <div class="day-heading">Monday</div>
                                    <div id="editMondaySlots" class="time-slots">
                                        <div class="time-slot-row">
                                            <input type="time" class="time-input" />
                                            <input type="time" class="time-input" />
                                            <button class="remove-slot" onclick="removeTimeSlot(this)">Ã—</button>
                                        </div>
                                    </div>
                                    <button class="add-slot-btn" onclick="addTimeSlot('editMonday')">+ Add Time
                                        Slot</button>
                                    <div class="day-heading">Tuesday</div>
                                    <div id="editTuesdaySlots" class="time-slots">
                                        <div class="time-slot-row">
                                            <input type="time" class="time-input" />
                                            <input type="time" class="time-input" />
                                            <button class="remove-slot" onclick="removeTimeSlot(this)">Ã—</button>
                                        </div>
                                    </div>
                                    <button class="add-slot-btn" onclick="addTimeSlot('editTuesday')">+ Add Time
                                        Slot</button>
                                    <div class="day-heading">Wednesday</div>
                                    <div id="editWednesdaySlots" class="time-slots">
                                        <div class="time-slot-row">
                                            <input type="time" class="time-input" />
                                            <input type="time" class="time-input" />
                                            <button class="remove-slot" onclick="removeTimeSlot(this)" Ã—></button>
                                        </div>
                                    </div>
                                    <button class="add-slot-btn" onclick="addTimeSlot('editWednesday')">+ Add Time
                                        Slot</button>
                                    <div class="day-heading">Thursday</div>
                                    <div id="editThursdaySlots" class="time-slots">
                                        <div class="time-slot-row">
                                            <input type="time" class="time-input" />
                                            <input type="time" class="time-input" />
                                            <button class="remove-slot" onclick="removeTimeSlot(this)">Ã—</button>
                                        </div>
                                    </div>
                                    <button class="add-slot-btn" onclick="addTimeSlot('editThursday')">+ Add Time
                                        Slot</button>
                                    <div class="day-heading">Friday</div>
                                    <div id="editFridaySlots" class="time-slots">
                                        <div class="time-slot-row">
                                            <input type="time" class="time-input" />
                                            <input type="time" class="time-input" />
                                            <button class="remove-slot" onclick="removeTimeSlot(this)">Ã—</button>
                                        </div>
                                    </div>
                                    <button class="add-slot-btn" onclick="addTimeSlot('editFriday')">+ Add Time
                                        Slot</button>
                                    <div class="day-heading">Saturday</div>
                                    <div id="editSaturdaySlots" class="time-slots">
                                        <div class="time-slot-row">
                                            <input type="time" class="time-input" />
                                            <input type="time" class="time-input" />
                                            <button class="remove-slot" onclick="removeTimeSlot(this)">Ã—</button>
                                        </div>
                                    </div>
                                    <button class="add-slot-btn" onclick="addTimeSlot('editSaturday')">+ Add Time
                                        Slot</button>
                                </div>
                                <button class="save-timetable-btn" onclick="saveEditedTimeTable()">Save Changes</button>
                            </div>
                        </div>
                    </div>
                    <!--Admin Progress Report Section-->
                    <div id="adminProgress" style="display: none">
                        <h2>Employee Progress Reports</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th>Employee</th>
                                    <th>Date</th>
                                    <th>Time</th>
                                    <th>Details</th>
                                    <th>File</th>
                                    <th>Download</th>
                                    <th>Status</th>
                                    <th>Remarks</th>
                                </tr>
                            </thead>
                            <tbody id="adminProgressTable"></tbody>
                        </table>
                    </div>
                    <!--Admin Holiday Request Section-->
                    <div id="adminHolidays" style="display: none">
                        <h2>Holiday Requests</h2>
                        <div class="filter-section">
                            <span>Filter by status: </span>
                            <select id="holidayStatusFilter" onchange="loadAdminHolidayRequests()">
                                <option value="all">All</option>
                                <option value="pending">Pending</option>
                                <option value="approved">Approved</option>
                                <option value="rejected">Rejected</option>
                                <option value="uninformed">Uninformed</option>
                            </select>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Employee</th>
                                    <th>Start Date</th>
                                    <th>End Date</th>
                                    <th>Days</th>
                                    <th>Reason</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="adminHolidayRequestsTable"></tbody>
                        </table>
                    </div>
                    <div id="weeklyAttendance" style="display: none">
                        <h1 style=" color: white; background-color: #1c7593; padding: 15px; text-align: center; ">Weekly
                            Attendance Summary</h1>
                        <div style="margin: 15px 0">
                            <button onclick="downloadWeeklySummary()" class="download-btn" style="padding: 8px 15px"><i
                                    class="fas fa-download"></i> Download Summary</button>
                        </div>
                        <table id="weeklyAttendanceTable" class="weekly-summary-table">
                            <thead>
                                <tr>
                                    <th rowspan="2">Employee</th>
                                    <th colspan="3">Sunday</th>
                                    <th colspan="3">Monday</th>
                                    <th colspan="3">Tuesday</th>
                                    <th colspan="3">Wednesday</th>
                                    <th colspan="3">Thursday</th>
                                    <th colspan="3">Friday</th>
                                    <th colspan="3">Saturday</th>
                                </tr>
                                <tr>
                                    <th>IN</th>
                                    <th>OUT</th>
                                    <th>Late</th>
                                    <th>IN</th>
                                    <th>OUT</th>
                                    <th>Late</th>
                                    <th>IN</th>
                                    <th>OUT</th>
                                    <th>Late</th>
                                    <th>IN</th>
                                    <th>OUT</th>
                                    <th>Late</th>
                                    <th>IN</th>
                                    <th>OUT</th>
                                    <th>Late</th>
                                    <th>IN</th>
                                    <th>OUT</th>
                                    <th>Late</th>
                                    <th>IN</th>
                                    <th>OUT</th>
                                    <th>Late</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <!-- Admin Tasks/Targets Section -->
                    <div id="adminTargets" style="display: none">
                        <h1 style=" color: white; background-color: #1c7593; padding: 15px; text-align: center;">Tasks
                            Management</h1>
                        <h4 style="padding: 10px">Assign Tasks To the selected Employee</h4>
                        <div class="task-form">
                            <label for="taskDate">Date:</label>
                            <input type="date" id="taskDate" style="padding: 5px" />
                            <label for="taskDay">Day:</label>
                            <select id="taskDay" style="padding: 5px">
                                <option value="">Select Day</option>
                                <option value="Monday">Monday</option>
                                <option value="Tuesday">Tuesday</option>
                                <option value="Wednesday">Wednesday</option>
                                <option value="Thursday">Thursday</option>
                                <option value="Friday">Friday</option>
                                <option value="Saturday">Saturday</option>
                                <option value="Sunday">Sunday</option>
                            </select>
                            <label for="taskDescription">Description:</label>
                            <textarea id="taskDescription" style="padding: 5px; width: 100%; min-height: 100px; resize: vertical;"></textarea>
                            <label for="taskFile"> Upload File:</label>
                            <input type="file" id="taskFile" />
                            <button onclick="addNewTask()" style="background-color: #1c7593; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer;">Add Task</button>
                        </div>
                        <h2 style="padding: 10px; margin: 10px">Assigned Tasks History</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Day</th>
                                    <th>Description</th>
                                    <th>File</th>
                                    <th>Status</th>
                                    <th>Reason</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="adminTasksTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <script>
                // Add this utility function at the beginning of the script section
                function standardizeDate(date) {
                    // Convert any date format to YYYY-MM-DD
                    const d = new Date(date);
                    const year = d.getFullYear();
                    const month = String(d.getMonth() + 1).padStart(2, '0');
                    const day = String(d.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }

                function toggleMobileMenu() {
                    const sidebar = document.querySelector("#employeePage .left-sidebar");
                    const hamburger = document.querySelector("#employeePage .hamburger-menu");
                    const overlay = document.querySelector("#employeePage .sidebar-overlay");
                    sidebar.classList.toggle("active");
                    hamburger.classList.toggle("active");
                    if (sidebar.classList.contains("active")) {
                        overlay.style.display = "block";
                    } else {
                        overlay.style.display = "none";
                    }
                }
                function closeMobileMenu() {
                    const sidebar = document.querySelector("#employeePage .left-sidebar");
                    const hamburger = document.querySelector("#employeePage .hamburger-menu");
                    const overlay = document.querySelector("#employeePage .sidebar-overlay");
                    sidebar.classList.remove("active");
                    hamburger.classList.remove("active");
                    overlay.style.display = "none";
                }
                function toggleAdminMobileMenu() {
                    const sidebar = document.querySelector("#adminPage .left-sidebar");
                    const hamburger = document.querySelector("#adminPage .hamburger-menu");
                    const overlay = document.querySelector("#adminPage .sidebar-overlay");
                    sidebar.classList.toggle("active");
                    hamburger.classList.toggle("active");
                    if (sidebar.classList.contains("active")) {
                        overlay.style.display = "block";
                    } else {
                        overlay.style.display = "none";
                    }
                }
                function closeAdminMobileMenu() {
                    const sidebar = document.querySelector("#adminPage .left-sidebar");
                    const hamburger = document.querySelector("#adminPage .hamburger-menu");
                    const overlay = document.querySelector("#adminPage .sidebar-overlay");
                    sidebar.classList.remove("active");
                    hamburger.classList.remove("active");
                    overlay.style.display = "none";
                }
                function checkMobileView() {
                    if (window.innerWidth <= 480) {
                        const dateElement = document.getElementById("currentDate");
                        const timeElement = document.getElementById("currentTime");
                        if (dateElement) dateElement.style.display = "none";
                        if (timeElement) timeElement.style.display = "none";
                        if (!document.querySelector("#employeePage .sidebar-overlay")) {
                            const overlay = document.createElement("div");
                            overlay.className = "sidebar-overlay";
                            overlay.onclick = closeMobileMenu;
                            document.querySelector("#employeePage .container").appendChild(overlay);
                        }
                        if (!document.querySelector("#adminPage .sidebar-overlay")) {
                            const overlay = document.createElement("div");
                            overlay.className = "sidebar-overlay";
                            overlay.onclick = closeAdminMobileMenu;
                            document.querySelector("#adminPage .container").appendChild(overlay);
                        }
                    } else {
                        const dateElement = document.getElementById("currentDate");
                        const timeElement = document.getElementById("currentTime");
                        if (dateElement) dateElement.style.display = "inline-block";
                        if (timeElement) timeElement.style.display = "inline-block";
                    }
                }
                window.addEventListener("load", checkMobileView);
                window.addEventListener("resize", checkMobileView);
                function openAddEmployeeModal() {
                    document.getElementById("addEmployeeModal").style.display = "block";
                    document.getElementById("modalOverlay").style.display = "block";
                    const deleteEmployeeSelect = document.getElementById("deleteEmployeeSelect");
                    deleteEmployeeSelect.innerHTML = '<option value="">Select an employee</option>';
                    
                    // First get local users
                    const localUsers = { ...users };
                    
                    // Then fetch all users from Firebase
                    database.ref("users").once('value', (snapshot) => {
                        const firebaseUsers = snapshot.val() || {};
                        
                        // Combine local and Firebase users, excluding admin
                        const allUsers = { ...localUsers, ...firebaseUsers };
                        
                        Object.keys(allUsers).forEach((username) => {
                        if (username !== "admin") {
                            const option = document.createElement("option");
                            option.value = username;
                            option.textContent = username;
                            deleteEmployeeSelect.appendChild(option);
                        }
                        });
                    });
                }
                function closeAddEmployeeModal() {
                    document.getElementById("addEmployeeModal").style.display = "none";
                    document.getElementById("modalOverlay").style.display = "none";
                    document.getElementById("newUsername").value = "";
                    document.getElementById("newPassword").value = "";
                    document.getElementById("newEmployeeId").value = "";
                    document.getElementById("newEmployeePhone").value = "";
                    document.getElementById("newEmployeeEmail").value = "";
                    //Remove send credentials button if it exists
                    const sendCredentialsContainer = document.querySelector('.form-group button[onclick^="sendCredentialsEmail"]');
                    if (sendCredentialsContainer) {
                        sendCredentialsContainer.parentElement.remove();
                    }
                }
                function sendCredentialsEmail(username) {
                    const user = users[username];
                    if (!user || !user.email) {
                        alert("User email not found.");
                        return;
                    }
                    const subject = "Your FSPro System Credentials";
                    const body = `Hello,\n\nYour account has been created in the FSPro system.\n\nUsername: ${username}\nPassword: ${user.password}\nEmployee ID: ${user.id}\n\nPlease login at your earliest convenience and inform your Team Lead if you have any Queries or Login issues.\n\nRegards,\nFSPro Admin Team`;
                    //create a mailto link to open the user's email.
                    const mailtoLink = `mailto:${user.email
                        }?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                    window.open(mailtoLink, "_blank");
                }
                function deleteEmployee() {
                    const username = document.getElementById("deleteEmployeeSelect").value;
                    if (!username) {
                        alert("Please select an employee to delete");
                        return;
                    }
                    if (username === "admin") {
                        alert("Cannot delete the admin account");
                        return;
                    }
                    if (confirm(`Are you sure you want to delete the employee "${username}"? This cannot be undone.`)) {
                        // Remove from local users
                        delete users[username];
                        localStorage.setItem("users", JSON.stringify(users));
                        
                        // Remove from Firebase users
                        database.ref(`users/${username}`).remove()
                            .then(() => {
                                console.log("Employee removed from Firebase users successfully");
                                
                                // Remove all associated data from Firebase
                            const promises = [
                                    // Remove attendance records
                                database.ref('attendanceRecords').once('value').then(snapshot => {
                                        const records = snapshot.val() || [];
                                        const updatedRecords = records.filter(record => record.employee !== username);
                                    return database.ref('attendanceRecords').set(updatedRecords);
                                }),
                                    
                                    // Remove late check-ins
                                database.ref('lateCheckIns').once('value').then(snapshot => {
                                        const records = snapshot.val() || [];
                                        const updatedRecords = records.filter(record => record.employee !== username);
                                    return database.ref('lateCheckIns').set(updatedRecords);
                                }),
                                    
                                    // Remove holiday requests
                                database.ref('holidayRequests').once('value').then(snapshot => {
                                        const records = snapshot.val() || [];
                                        const updatedRecords = records.filter(record => record.employee !== username);
                                    return database.ref('holidayRequests').set(updatedRecords);
                                }),
                                    
                                    // Remove progress reports
                                database.ref('progressReports').once('value').then(snapshot => {
                                        const records = snapshot.val() || [];
                                        const updatedRecords = records.filter(record => record.employee !== username);
                                    return database.ref('progressReports').set(updatedRecords);
                                }),
                                    
                                    // Remove employee tasks
                                database.ref('employeeTasks').once('value').then(snapshot => {
                                        const records = snapshot.val() || [];
                                        const updatedRecords = records.filter(record => record.assignedTo !== username);
                                    return database.ref('employeeTasks').set(updatedRecords);
                                    }),
                                    
                                    // Remove time tables
                                    database.ref('timeTables').once('value').then(snapshot => {
                                        const records = snapshot.val() || [];
                                        const updatedRecords = records.filter(record => record.employee !== username);
                                        return database.ref('timeTables').set(updatedRecords);
                                    })
                                ];
                                
                                Promise.all(promises)
                                    .then(() => {
                                        // Clear local storage
                                localStorage.setItem("attendanceRecords", JSON.stringify([]));
                                localStorage.setItem("lateCheckIns", JSON.stringify([]));
                                localStorage.setItem("holidayRequests", JSON.stringify([]));
                                localStorage.setItem("progressReports", JSON.stringify([]));
                                localStorage.setItem("employeeTasks", JSON.stringify([]));
                                        localStorage.setItem("timeTables", JSON.stringify([]));
                                        
                                        // Update UI
                                const adminUserSelect = document.getElementById("adminUserSelect");
                                const optionToRemove = Array.from(adminUserSelect.options).find((option) => option.value === username);
                                        if (optionToRemove) {
                                            adminUserSelect.removeChild(optionToRemove);
                                        }
                                        
                                const deleteEmployeeSelect = document.getElementById("deleteEmployeeSelect");
                                const deleteOptionToRemove = Array.from(deleteEmployeeSelect.options).find((option) => option.value === username);
                                        if (deleteOptionToRemove) {
                                            deleteEmployeeSelect.removeChild(deleteOptionToRemove);
                                        }
                                deleteEmployeeSelect.value = "";
                                        
                                alert(`Employee "${username}" and all associated data have been deleted successfully.`);
                            })
                                .catch(error => {
                                    console.error("Error deleting employee data:", error);
                                    alert("Employee was deleted but there was an error removing some associated data.");
                                });
                        })
                            .catch((error) => {
                                console.error("Error removing employee from Firebase:", error);
                                alert("Error deleting employee. Please try again.");
                            });
                    }
                }
                function addNewEmployee() {
                    const username = document.getElementById("newUsername").value.toLowerCase();
                    const password = document.getElementById("newPassword").value;
                    const employeeId = document.getElementById("newEmployeeId").value;
                    const phone = document.getElementById("newEmployeePhone").value;
                    const email = document.getElementById("newEmployeeEmail").value;
                    if (!username || !password || !employeeId || !phone) {
                        alert("Please fill in all required fields");
                        return;
                    }
                    if (users[username]) {
                        alert("Username already exists. Please choose a different username.");
                        return;
                    }
                    users[username] = {
                        password: password,
                        id: employeeId,
                        role: "employee",
                        phone: phone,
                        email: email,
                    };
                    saveToFirebase(`users/${username}`, {
                        password: password,
                        id: employeeId,
                        role: "employee",
                        phone: phone,
                        email: email,
                    })
                        .then(() => {
                            console.log("Employee added to Firebase successfully");
                        })
                        .catch((error) => {
                            console.error("Error adding employee to Firebase:", error);
                        });
                    const selectElement = document.getElementById("adminUserSelect");
                    const option = document.createElement("option");
                    option.value = username;
                    option.textContent = username;
                    selectElement.appendChild(option);
                    selectElement.value = username;
                    handleUserSelect();
                    localStorage.setItem("users", JSON.stringify(users));
                    if (email) {
                        const sendCredentialsContainer = document.createElement("div");
                        sendCredentialsContainer.className = "form-group";
                        sendCredentialsContainer.style.marginTop = "20px";
                        sendCredentialsContainer.innerHTML = `
                    <button onclick="sendCredentialsEmail('${username}')" style="background-color: #3498db;">Send Credentials to ${email}</button>`;
                        document.getElementById("addEmployeeContent").appendChild(sendCredentialsContainer);
                    }
                    alert("Employee added successfully!");
                }
                window.addEventListener("load", () => {
                    getFirebaseData("users", (firebaseUsers) => {
                        const savedUsers = firebaseUsers || {};
                        const selectElement = document.getElementById("adminUserSelect");
                        if (selectElement) {
                            // Clear existing options except the first one
                            while (selectElement.options.length > 1) {
                                selectElement.remove(1);
                            }

                            // Add hardcoded employees first
                            Object.keys(users).forEach((username) => {
                                if (username !== "admin") {
                                    const option = document.createElement("option");
                                    option.value = username;
                                    option.textContent = username;
                                    selectElement.appendChild(option);
                                }
                            });

                            // Add users from Firebase (excluding any that are already in the hardcoded list)
                            Object.keys(savedUsers).forEach((username) => {
                                if (username !== "admin" && !users[username]) {
                                    const option = document.createElement("option");
                                    option.value = username;
                                    option.textContent = username;
                                    selectElement.appendChild(option);
                                }
                            });
                        }
                    });

                    getFirebaseData("attendanceRecords", (firebaseRecords) => {
                        const attendanceRecords = firebaseRecords || [];
                        // Removed localStorage fallback
                    });

                    getFirebaseData("lateCheckIns", (firebaseLateCheckIns) => {
                        const lateCheckIns = firebaseLateCheckIns || [];
                        // Removed localStorage fallback
                    });

                    getFirebaseData("holidayRequests", (firebaseHolidayRequests) => {
                        const holidayRequests = firebaseHolidayRequests || [];
                        // Removed localStorage fallback
                    });

                    getFirebaseData("progressReports", (firebaseProgressReports) => {
                        const progressReports = firebaseProgressReports || [];
                        // Removed localStorage fallback
                    });

                    getFirebaseData("employeeTasks", (firebaseTasks) => {
                        const tasks = firebaseTasks || [];
                        // Removed localStorage fallback
                    });

                    getFirebaseData("notifications", (firebaseNotifications) => {
                        const notifications = firebaseNotifications || [];
                        // Removed localStorage fallback
                    });
                });
                const users = {
                    admin: { password: "admin123", role: "admin" },
                    hamza: { password: "hamza123", id: "118", role: "employee", phone: "923480970884", },
                    zain: { password: "zain123", id: "119", role: "employee", phone: "9230251866577", },
                    hanzallah: { password: "hanzallah123", id: "120", role: "employee", phone: "923474224118", },
                };
                window.addEventListener("load", () => {
                    const loggedInUser = JSON.parse(
                        localStorage.getItem("loggedInUser")
                    );
                    if (loggedInUser) {
                        if (loggedInUser.role === "admin") {
                            showPage("adminPage");
                            loadAdminData();
                        } else {
                            document.getElementById("employeeDetails").textContent = `${loggedInUser.username} | ID: ${loggedInUser.id}`;
                            showPage("employeePage");
                            loadAttendanceTable();
                            updateSummaryValues();
                            loadEmployeeHolidayRequests();
                        }
                    }
                });
                document.getElementById("loginBtn").addEventListener("click", () => {
                    const username = document
                        .getElementById("userName")
                        .value.toLowerCase();
                    const password = document.getElementById("userPassword").value;
                    database.ref(`users/${username}`).once(
                        "value",
                        (snapshot) => {
                            const firebaseUser = snapshot.val();
                            const user = firebaseUser || users[username];
                            if (user && user.password === password) {
                                localStorage.setItem(
                                    "loggedInUser",
                                    JSON.stringify({
                                        username,
                                        id: user.id,
                                        role: user.role,
                                    })
                                );
                                if (!firebaseUser && users[username]) {
                                    saveToFirebase(`users/${username}`, users[username]);
                                }
                                if (user.role === "admin") {
                                    showPage("adminPage");
                                    loadAdminData();
                                } else {
                                    document.getElementById("employeeDetails").textContent = `${username} | ID: ${user.id}`;
                                    showPage("employeePage");
                                    loadAttendanceTable();
                                    updateSummaryValues();
                                    loadEmployeeHolidayRequests();
                                    showSection("attendance");
                                }
                            } else {
                                alert("Invalid username or password");
                            }
                        },
                        (error) => {
                            console.error("Error checking Firebase for user:", error);
                            const user = users[username];
                            if (user && user.password === password) {
                                localStorage.setItem(
                                    "loggedInUser",
                                    JSON.stringify({
                                        username,
                                        id: user.id,
                                        role: user.role,
                                    })
                                );
                                if (user.role === "admin") {
                                    showPage("adminPage");
                                    loadAdminData();
                                } else {
                                    document.getElementById("employeeDetails").textContent = `${username} | ID: ${user.id}`;
                                    showPage("employeePage");
                                    loadAttendanceTable();
                                    updateSummaryValues();
                                    loadEmployeeHolidayRequests();
                                    showSection("attendance");
                                }
                            } else {
                                alert("Invalid username or password");
                            }
                        }
                    );
                });
                function showPage(pageId) {
                    ["loginPage", "employeePage", "adminPage"].forEach((id) => {
                        document.getElementById(id).style.display =
                            id === pageId ? "block" : "none";
                    });
                    if (pageId === "employeePage") {
                        updateSummaryValues();
                        loadEmployeeHolidayRequests();
                    }
                }
                function updateTime() {
                    const now = new Date();
                    const timeString = now.toLocaleTimeString();
                    const dateString = now.toLocaleDateString("en-US", {
                        weekday: "long",
                        year: "numeric",
                        month: "long",
                        day: "numeric",
                    });
                    document.getElementById("currentTime").textContent = timeString;
                    document.getElementById("currentDate").textContent = `${dateString} | ${timeString}`;
                    const currentHour = now.getHours();
                    const currentMinutes = now.getMinutes();
                    const currentTime = currentHour * 60 + currentMinutes;
                    const checkInDeadline = 10 * 60 + 30;
                    if (currentTime === checkInDeadline) {
                        const currentUser = document
                            .getElementById("employeeDetails")
                            ?.textContent.split("|")[0]
                            .trim();
                        if (currentUser) {
                            const attendanceRecords =
                                JSON.parse(localStorage.getItem("attendanceRecords")) || [];
                            const todayRecord = attendanceRecords.find(
                                (record) =>
                                    record.employee === currentUser &&
                                    record.date === dateString
                            );
                            if (!todayRecord || !todayRecord.checkIn) {
                                const notifications =
                                    JSON.parse(localStorage.getItem("notifications")) || [];
                                const existingNotification = notifications.find(
                                    (n) =>
                                        n.employee === currentUser &&
                                        n.date === dateString &&
                                        n.type === "missed_checkin"
                                );
                                if (!existingNotification) {
                                    notifications.push({
                                        employee: currentUser,
                                        date: dateString,
                                        time: timeString,
                                        type: "missed_checkin",
                                        message: "You forgot to check in for today.",
                                    });
                                    localStorage.setItem(
                                        "notifications",
                                        JSON.stringify(notifications)
                                    );
                                    const notificationIcon =
                                        document.querySelector(".notification-icon");
                                    if (notificationIcon) {
                                        notificationIcon.style.display = "block";
                                    }
                                }
                            }
                        }
                    }
                }
                setInterval(updateTime, 1000);
                updateTime();
                function handleCheckIn() {
                    const now = new Date();
                    const employee = document.getElementById("employeeDetails").textContent.split("|")[0].trim();
                    
                    // Use standardized date format
                    const date = standardizeDate(now);
                    const localTime = now.toLocaleTimeString();
                    const day = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"][now.getDay()];
                    
                    getFirebaseData("timeTables", (firebaseTimeTables) => {
                        const timeTables = firebaseTimeTables || JSON.parse(localStorage.getItem("timeTables")) || [];
                        const employeeSchedule = timeTables.find((t) => t.employee === employee);

                        if (!employeeSchedule || !employeeSchedule[day.toLowerCase()]?.slots) {
                            alert("Please set up your schedule for today first.");
                            return;
                        }

                        const todaySlots = employeeSchedule[day.toLowerCase()].slots;
                        
                        // Convert local time to Date object for comparison
                        const currentTime = new Date(`1970-01-01T${localTime}`);
                        
                        // Sort slots by check-in time
                        const sortedSlots = [...todaySlots].sort((a, b) => {
                            const timeA = new Date(`1970-01-01T${a.checkIn}`);
                            const timeB = new Date(`1970-01-01T${b.checkIn}`);
                            return timeA - timeB;
                        });

                        // Check if there's any schedule for today
                        if (sortedSlots.length === 0) {
                            alert("No schedule found for today.");
                            return;
                        }

                        // Get the earliest slot for today
                        const earliestSlot = sortedSlots[0];
                        const slotStart = new Date(`1970-01-01T${earliestSlot.checkIn}`);
                        
                        // Determine if this is a late check-in (more than 60 minutes after earliest slot)
                        const isLate = currentTime > new Date(slotStart.getTime() + 60 * 60 * 1000);

                        // Check if already checked in today
                        getFirebaseData("attendanceRecords", (firebaseRecords) => {
                            const attendanceRecords = firebaseRecords || [];
                            const todayRecord = attendanceRecords.find(
                                record => record.employee === employee && record.date === date
                            );
                            
                            if (todayRecord && todayRecord.checkIn) {
                                if (confirm("You have already checked in today. Do you want to add another check-in?")) {
                                    recordCheckIn(employee, date, day, localTime, isLate);
                                        }
                                    } else {
                                recordCheckIn(employee, date, day, localTime, isLate);
                            }
                        });
                    });
                }
                function recordCheckIn(employee, date, day, time, isLate) {
                    getFirebaseData("attendanceRecords", (firebaseRecords) => {
                        const attendanceRecords = firebaseRecords || [];
                        const recordIndex = attendanceRecords.findIndex(
                            (record) => record.employee === employee && record.date === date
                        );
                        
                        if (recordIndex === -1) {
                            const newRecord = {
                                employee: employee,
                                date: date,
                                day: day,
                                checkIn: time,
                                isLate: isLate,
                                timestamp: new Date().toISOString() // Add timestamp for sorting
                            };
                            attendanceRecords.push(newRecord);
                        } else {
                            if (Array.isArray(attendanceRecords[recordIndex].checkIn)) {
                                attendanceRecords[recordIndex].checkIn.push(time);
                            } else if (attendanceRecords[recordIndex].checkIn) {
                                attendanceRecords[recordIndex].checkIn = [
                                    attendanceRecords[recordIndex].checkIn,
                                    time,
                                ];
                            } else {
                                attendanceRecords[recordIndex].checkIn = time;
                            }
                            if (isLate) {
                                attendanceRecords[recordIndex].isLate = true;
                            }
                            attendanceRecords[recordIndex].timestamp = new Date().toISOString(); // Update timestamp
                        }

                        saveToFirebase("attendanceRecords", attendanceRecords)
                            .then(() => {
                                alert("Check-in recorded successfully!");
                                loadAttendanceTable();
                                updateSummaryValues();
                            })
                            .catch((error) => {
                                console.error("Error saving attendance record to Firebase:", error);
                                alert("Error recording check-in. Please try again.");
                            });
                    });
                }
                function handleCheckOut() {
                    const now = new Date();
                    const employee = document.getElementById("employeeDetails").textContent.split("|")[0].trim();
                    
                    // Use standardized date format
                    const date = standardizeDate(now);
                    const day = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"][now.getDay()];
                    const time = now.toLocaleTimeString();
                    
                    getFirebaseData("attendanceRecords", (firebaseRecords) => {
                        let attendanceRecords = firebaseRecords || JSON.parse(localStorage.getItem("attendanceRecords")) || [];
                        const recordIndex = attendanceRecords.findIndex(
                            (record) => record.employee === employee && record.date === date
                        );
                        
                        if (recordIndex === -1) {
                            const newRecord = {
                                employee: employee,
                                date: date,
                                day: day,
                                checkOut: time,
                                timestamp: new Date().toISOString()
                            };
                            attendanceRecords.push(newRecord);
                        } else {
                            if (Array.isArray(attendanceRecords[recordIndex].checkOut)) {
                                attendanceRecords[recordIndex].checkOut.push(time);
                            } else if (attendanceRecords[recordIndex].checkOut) {
                                attendanceRecords[recordIndex].checkOut = [
                                    attendanceRecords[recordIndex].checkOut,
                                    time,
                                ];
                            } else {
                                attendanceRecords[recordIndex].checkOut = time;
                            }
                            attendanceRecords[recordIndex].timestamp = new Date().toISOString();
                        }

                        saveToFirebase("attendanceRecords", attendanceRecords)
                            .then(() => {
                                localStorage.setItem("attendanceRecords", JSON.stringify(attendanceRecords));
                                alert("Check-out successful! Time recorded: " + time);
                                loadAttendanceTable();
                                updateSummaryValues();
                            })
                            .catch((error) => {
                                console.error("Error saving attendance record to Firebase:", error);
                                localStorage.setItem("attendanceRecords", JSON.stringify(attendanceRecords));
                                alert("Check-out successful! Time recorded: " + time);
                                loadAttendanceTable();
                                updateSummaryValues();
                            });
                    });
                }
                function handleLateCheckIn() {
                    const now = new Date();
                    const employee = document.getElementById("employeeDetails").textContent.split("|")[0].trim();
                    
                    // Use standardized date format
                    const date = standardizeDate(now);
                    const day = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"][now.getDay()];
                    const time = now.toLocaleTimeString();
                    
                    // First, get existing late check-ins from Firebase
                    database.ref("lateCheckIns").once('value', (snapshot) => {
                        let lateCheckIns = snapshot.val() || [];
                        
                        const newLateCheckIn = {
                            employee: employee,
                            date: date,
                            day: day,
                            time: time,
                            timestamp: new Date().toISOString()
                        };
                        
                        // Add the new late check-in
                        lateCheckIns.push(newLateCheckIn);
                        
                        // Save to Firebase
                        database.ref("lateCheckIns").set(lateCheckIns)
                            .then(() => {
                                // Update attendance records to include late check-in
                                database.ref("attendanceRecords").once('value', (snapshot) => {
                                    let attendanceRecords = snapshot.val() || [];
                                    const recordIndex = attendanceRecords.findIndex(
                                        record => record.employee === employee && standardizeDate(record.date) === date
                                    );
                                    
                                    if (recordIndex === -1) {
                                        const newRecord = {
                                            employee: employee,
                                            date: date,
                                            day: day,
                                            isLate: true,
                                            timestamp: new Date().toISOString()
                                        };
                                        attendanceRecords.push(newRecord);
                                    } else {
                                        attendanceRecords[recordIndex].isLate = true;
                                        attendanceRecords[recordIndex].timestamp = new Date().toISOString();
                                    }
                                    
                                    // Save updated attendance records to Firebase
                                    database.ref("attendanceRecords").set(attendanceRecords)
                                        .then(() => {
                                            alert("Late check-in recorded successfully!");
                                            // Add smooth refresh animation
                                            const tableBody = document.getElementById("attendanceTable");
                                            if (tableBody) {
                                                tableBody.style.opacity = "0";
                                                setTimeout(() => {
                                                    loadAttendanceTable();
                                                    tableBody.style.opacity = "1";
                                                }, 300);
                                            } else {
                                                loadAttendanceTable();
                                            }
                                            updateSummaryValues();
                                        })
                                        .catch(error => {
                                            console.error("Error saving attendance records:", error);
                                            alert("Error saving attendance records. Please try again.");
                                        });
                                });
                            })
                            .catch((error) => {
                                console.error("Error saving late check-in to Firebase:", error);
                                alert("Error saving late check-in. Please try again.");
                            });
                    });
                }
                function sendNotification(employee) {
                    const notificationCount =
                        document.getElementById("notificationCount");
                    let count = parseInt(notificationCount.textContent) || 0;
                    count++;
                    notificationCount.textContent = count;
                    const notificationList =
                        document.getElementById("notificationList");
                    const notificationItem = document.createElement("div");
                    notificationItem.textContent = `Missed check-in notification sent to ${employee}.`;
                    notificationList.appendChild(notificationItem);
                }
                function clearNotifications() {
                    const notificationCount =
                        document.getElementById("notificationCount");
                    notificationCount.textContent = "0";
                    document.getElementById("notificationList").innerHTML = "";
                }
                function toggleNotificationPopup() {
                    const popup = document.getElementById("notificationPopup");
                    popup.style.display =
                        popup.style.display === "block" ? "none" : "block";
                }
                function showSection(sectionName) {
                    document.querySelectorAll(".section").forEach((section) => {
                        section.style.display = "none";
                    });
                    const selectedSection = document.getElementById(
                        sectionName + "-section"
                    );
                    if (selectedSection) {
                        selectedSection.style.display = "block";
                    }
                    const employeeHeader = document.getElementById("employeeHeader");
                    if (employeeHeader) {
                        employeeHeader.style.display =
                            sectionName === "attendance" ? "flex" : "none";
                    }
                    if (sectionName === "progress") {
                        loadEmployeeProgress();
                    } else if (sectionName === "employeeTasks") {
                        loadEmployeeTasks();
                    }
                }
                function handleUserSelect() {
                    const selectedUser =
                        document.getElementById("adminUserSelect").value;
                    document.getElementById("selectedEmployeeName").textContent =
                        selectedUser || "No employee selected";
                    loadAdminData(selectedUser);
                    loadMissedCheckIns(selectedUser);
                    loadAdminProgressReports(selectedUser);
                    loadAdminTimeTable(selectedUser);
                    loadAdminHolidayRequests(selectedUser);
                    loadAdminTasks(selectedUser);
                }
                function updateWorkingHours(selectElement, date, employee) {
                    const row = selectElement.closest("tr");
                    const checkInSelect = row.querySelector("td:nth-child(4) select");
                    const checkOutSelect = row.querySelector("td:nth-child(5) select");
                    const isLate =
                        row.querySelector("td:nth-child(6)").textContent === "Yes";
                    const checkInTime = checkInSelect.value;
                    const checkOutTime = checkOutSelect.value;
                    const checkIn24 = convertTo24Hour(checkInTime);
                    const checkOut24 = convertTo24Hour(checkOutTime);
                    const workingHours = calculateWorkingHours(
                        [checkIn24],
                        [checkOut24],
                        isLate ? [checkIn24] : []
                    );
                    row.querySelector("td:last-child").textContent = workingHours;
                    getFirebaseData(
                        "attendanceRecords",
                        (firebaseAttendanceRecords) => {
                            let attendanceRecords =
                                firebaseAttendanceRecords ||
                                JSON.parse(localStorage.getItem("attendanceRecords")) ||
                                [];
                            const recordIndex = attendanceRecords.findIndex(
                                (r) => r.employee === employee && r.date === date
                            );
                            if (recordIndex !== -1) {
                                const record = attendanceRecords[recordIndex];
                                const checkInIndex = Array.from(
                                    checkInSelect.options
                                ).indexOf(checkInSelect.selectedOptions[0]);
                                const checkOutIndex = Array.from(
                                    checkOutSelect.options
                                ).indexOf(checkOutSelect.selectedOptions[0]);
                                if (checkInIndex !== -1 && record.checkIn) {
                                    if (Array.isArray(record.checkIn)) {
                                        record.checkIn[checkInIndex] = checkInTime;
                                    } else {
                                        record.checkIn = [checkInTime];
                                    }
                                }
                                if (checkOutIndex !== -1 && record.checkOut) {
                                    if (Array.isArray(record.checkOut)) {
                                        record.checkOut[checkOutIndex] = checkOutTime;
                                    } else {
                                        record.checkOut = [checkOutTime];
                                    }
                                }
                                saveToFirebase("attendanceRecords", attendanceRecords)
                                    .then(() => {
                                        localStorage.setItem(
                                            "attendanceRecords",
                                            JSON.stringify(attendanceRecords)
                                        );
                                    })
                                    .catch((error) => {
                                        console.error(
                                            "Error saving attendance record to Firebase:",
                                            error
                                        );
                                        localStorage.setItem(
                                            "attendanceRecords",
                                            JSON.stringify(attendanceRecords)
                                        );
                                    });
                            }
                        }
                    );
                }
                function loadAdminData(selectedUser = "") {
                    // First get attendance records from Firebase
                    database.ref("attendanceRecords").once('value', (snapshot) => {
                        const attendanceRecords = snapshot.val() || [];
                        const tableBody = document.getElementById("adminAttendanceTable");
                        if (!tableBody) return;
                        tableBody.innerHTML = "";
                        
                        const filteredRecords = attendanceRecords.filter(
                            (record) => !selectedUser || record.employee === selectedUser
                        );
                        
                        // Sort records by date in descending order (newest first)
                        filteredRecords.sort((a, b) => {
                            return new Date(b.date) - new Date(a.date);
                        });
                        
                        if (selectedUser && filteredRecords.length === 0) {
                            const row = document.createElement("tr");
                            row.innerHTML = '<td colspan="7" style="text-align: center;">No attendance records found for this employee</td>';
                            tableBody.appendChild(row);
                            return;
                        }

                        // Then get late check-ins from Firebase
                        database.ref("lateCheckIns").once('value', (snapshot) => {
                            const lateCheckIns = snapshot.val() || [];

                        filteredRecords.forEach((record) => {
                            const checkOutTimes = Array.isArray(record.checkOut)
                                ? record.checkOut
                                : record.checkOut
                                    ? [record.checkOut]
                                    : [];

                                // Filter late check-ins for this employee and date
                            const lateCheckInTimes = lateCheckIns
                                .filter(
                                    (late) =>
                                        late.employee === record.employee &&
                                            standardizeDate(late.date) === standardizeDate(record.date)
                                )
                                .map((late) => late.time)
                                .sort((a, b) => {
                                    const timeA = new Date(`1970-01-01T${a}`);
                                    const timeB = new Date(`1970-01-01T${b}`);
                                    return timeB - timeA;
                                });

                            const workingHours = calculateWorkingHours(
                                record.checkIn,
                                checkOutTimes,
                                lateCheckInTimes
                            );

                            const row = document.createElement("tr");
                            row.innerHTML = `
                            <td>${record.employee}</td>
                           <td>${record.date}</td>
                           <td>${record.day}</td>
                           <td>${record.checkIn || "-"}</td>
                                <td>
                                    <select onchange="updateWorkingHours(this, '${record.date}', '${record.employee}')">
                                        ${checkOutTimes.length > 0
                                    ? checkOutTimes.map(time =>
                                        `<option ${checkOutTimes[0] === time ? "selected" : ""}>${time}</option>`
                                    ).join("")
                                    : '<option value="-">-</option>'
                                }
                </select>
            </td>
            <td>
                                    <select onchange="updateWorkingHours(this, '${record.date}', '${record.employee}')">
                                        ${lateCheckInTimes.length > 0
                                    ? lateCheckInTimes.map(time =>
                                        `<option ${lateCheckInTimes[0] === time ? "selected" : ""}>${time}</option>`
                                    ).join("")
                                    : '<option value="-">-</option>'
                                }
                </select>
            </td>
                                <td id="workingHours_${record.date}_${record.employee}">${workingHours}</td>`;
                            tableBody.appendChild(row);
                        });
                            
                        loadMissedCheckIns(selectedUser);
                        updateMissedCheckInsSummary();
                        });
                    });
                }
                function loadMissedCheckIns(selectedUser = "") {
                    const missedCheckIns =
                        JSON.parse(localStorage.getItem("missedCheckIns")) || [];
                    const tableBody = document
                        .getElementById("MissedCheckInsTable")
                        .getElementsByTagName("tbody")[0];
                    if (!tableBody) return;
                    tableBody.innerHTML = "";
                    missedCheckIns
                        .filter(
                            (record) => !selectedUser || record.employee === selectedUser
                        )
                        .sort((a, b) => new Date(b.date) - new Date(a.date))
                        .forEach((record) => {
                            const employee = users[record.employee];
                            const row = document.createElement("tr");
                            row.innerHTML = `
                        <td>${record.employee}</td>
                        <td>${record.notificationSent ? "Yes" : "No"}</td>
                        <td>${record.date}</td>
                        <td>${record.day}</td>
                        <td>
                            ${!record.notificationSent
                                    ? `<button onclick="sendWhatsAppMessage('${employee.phone}')">Send WhatsApp Notification</button>`
                                    : '<span class="status-sent">Notification Sent</span>'
                                }
                        </td>`;
                            tableBody.appendChild(row);
                        });
                }
                function updateMissedCheckInsSummary() {
                    const missedCheckIns =
                        JSON.parse(localStorage.getItem("missedCheckIns")) || [];
                    const totalMissedCheckIns = missedCheckIns.length;
                    document.getElementById("totalMissedCheckIns").textContent =
                        totalMissedCheckIns;
                }
                function sendWhatsAppMessage(phone) {
                    const message =
                        "Hello! This is a reminder that you missed your check-in today.";
                    const encodedMessage = encodeURIComponent(message);
                    const url = `https://api.whatsapp.com/send?phone=${phone}&text=${encodedMessage}`;
                    console.log("WhatsApp URL:", url);
                    window.open(url, "_blank");
                }
                function openHolidayRequest() {
                    const employeeName = document
                        .getElementById("employeeDetails")
                        .textContent.split("|")[0]
                        .trim();
                    let modal = document.getElementById("holidayModal");
                    if (!modal) {
                        modal = document.createElement("div");
                        modal.id = "holidayModal";
                        modal.className = "holiday-modal";
                        modal.innerHTML = `
                            <div class="section-header">
                                <h2>Holiday Request</h2>
                                <button onclick="closeHolidayModal()" class="close-btn"><i class="fa-solid fa-xmark" style="background-color: red;"></i></button>
                            </div>
                            <iframe id="holidayFrame" style="width:100%; height:700px; border:none; scroll-behavior: smooth;" src=""></iframe>`;
                        document.body.appendChild(modal);
                        let overlay = document.getElementById("modalOverlay");
                        if (!overlay) {
                            overlay = document.createElement("div");
                            overlay.id = "modalOverlay";
                            overlay.className = "modal-overlay";
                            document.body.appendChild(overlay);
                        }
                    }
                    const frame = document.getElementById("holidayFrame");
                    frame.src = `holiday_request.html?employee=${encodeURIComponent(
                        employeeName
                    )}`;
                    modal.style.display = "block";
                    document.getElementById("modalOverlay").style.display = "block";
                }
                function submitProgress() {
                    const progressMessage = document
                        .getElementById("progressMessage")
                        .value.trim();
                    const fileInput = document.getElementById("progressFile");
                    const employee = document
                        .getElementById("employeeDetails")
                        .textContent.split("|")[0]
                        .trim();
                    const now = new Date();
                    if (!progressMessage) {
                        alert("Please enter progress details");
                        return;
                    }
                    const file = fileInput.files[0];
                    let fileData = null;
                    let fileName = "";
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            fileData = e.target.result;
                            fileName = file.name;
                            saveProgressWithFile(progressMessage, fileData, fileName);
                        };
                        reader.readAsDataURL(file);
                    }
                    else {
                        saveProgressWithFile(progressMessage, null, "");
                    }
                }
                function saveProgressWithFile(progressMessage, fileData, fileName) {
                    const employee = document.getElementById("employeeDetails").textContent.split("|")[0].trim();
                    const now = new Date();
                    const progressReport = {
                        employee: employee,
                        date: now.toLocaleDateString(),
                        time: now.toLocaleTimeString(),
                        details: progressMessage,
                        fileName: fileName,
                        fileData: fileData,
                        status: "Pending",
                        timestamp: now.getTime()
                    };
                    getFirebaseData("progressReports", (firebaseProgressReports) => {
                        let progressReports = firebaseProgressReports || JSON.parse(localStorage.getItem("progressReports")) || [];
                        progressReports.push(progressReport);
                        saveToFirebase("progressReports", progressReports)
                            .then(() => {
                                localStorage.setItem("progressReports", JSON.stringify(progressReports));
                                document.getElementById("progressMessage").value = "";
                                document.getElementById("progressFile").value = "";
                                document.getElementById("fileName").textContent = "";
                                document.getElementById("fileUploadedIcon").style.display = "none";
                                alert("Progress report submitted successfully!");
                                loadEmployeeProgress();
                            })
                            .catch((error) => {
                                console.error("Error saving progress report to Firebase:", error);
                                localStorage.setItem("progressReports", JSON.stringify(progressReports));
                                document.getElementById("progressMessage").value = "";
                                document.getElementById("progressFile").value = "";
                                document.getElementById("fileName").textContent = "";
                                document.getElementById("fileUploadedIcon").style.display = "none";
                                alert("Progress report submitted successfully (saved locally)!");
                                loadEmployeeProgress();
                            });
                    });
                }
                function loadEmployeeProgress() {
                    const employee = document
                        .getElementById("employeeDetails")
                        .textContent.split("|")[0]
                        .trim();
                    const tableBody = document.getElementById("employeeProgressTable");
                    if (!tableBody) return;
                    tableBody.innerHTML = "";
                    const progressRef = firebase.database().ref('progressReports');
                    progressRef.once('value')
                        .then((snapshot) => {
                            const progressReports = snapshot.val() || {};
                            const reports = Object.values(progressReports)
                                .filter(report => report.employee === employee)
                                .sort((a, b) => {
                                    const dateA = new Date(a.date + " " + a.time);
                                    const dateB = new Date(b.date + " " + b.time);
                                    return dateB - dateA;
                                });
                            if (reports.length === 0) {
                                const row = document.createElement("tr");
                                row.innerHTML = '<td colspan="6" style="text-align: center;">No progress reports found</td>';
                                tableBody.appendChild(row);
                                return;
                            }
                            reports.forEach((report) => {
                                const statusClass = report.status.toLowerCase();
                                const row = document.createElement("tr");
                                row.innerHTML = `
                                <td>${report.date}</td>
                                <td>${report.time}</td>
                                <td>${report.details}</td>
                                <td>${report.fileName || "No file"}</td>
                                    <td class="status-${statusClass}">${report.status}</td>
                                    <td class="remarks-cell">${report.remarks || 'No remarks yet'}</td>`;
                                tableBody.appendChild(row);
                            });
                            localStorage.setItem("progressReports", JSON.stringify(reports));
                        })
                        .catch((error) => {
                            console.error("Error fetching progress reports:", error);
                            const progressReports = JSON.parse(localStorage.getItem("progressReports")) || [];
                            const reports = progressReports
                                .filter(report => report.employee === employee)
                                .sort((a, b) => {
                                    const dateA = new Date(a.date + " " + a.time);
                                    const dateB = new Date(b.date + " " + b.time);
                                    return dateB - dateA;
                                });
                            if (reports.length === 0) {
                                const row = document.createElement("tr");
                                row.innerHTML = '<td colspan="6" style="text-align: center;">No progress reports found</td>';
                                tableBody.appendChild(row);
                                return;
                            }
                            reports.forEach((report) => {
                                const statusClass = report.status.toLowerCase();
                                const row = document.createElement("tr");
                                row.innerHTML = `
                                    <td>${report.date}</td>
                                    <td>${report.time}</td>
                                    <td>${report.details}</td>
                                    <td>${report.fileName || "No file"}</td>
                                    <td class="status-${statusClass}">${report.status}</td>
                                    <td class="remarks-cell">${report.remarks || 'No remarks yet'}</td>
                                `;
                                tableBody.appendChild(row);
                            });
                        });
                }
                function loadAdminProgressReports(selectedUser = "") {
                    const tableBody = document.getElementById("adminProgressTable");
                    if (!tableBody) return;
                    tableBody.innerHTML = "";
                    const progressRef = firebase.database().ref('progressReports');
                    progressRef.once('value')
                        .then((snapshot) => {
                            const progressReports = snapshot.val() || {};
                            const reports = Object.values(progressReports)
                                .filter(report => !selectedUser || report.employee === selectedUser)
                                .sort((a, b) => {
                                    const dateA = new Date(a.date + " " + a.time);
                                    const dateB = new Date(b.date + " " + b.time);
                                    return dateB - dateA;
                                });
                            if (selectedUser && reports.length === 0) {
                                const row = document.createElement("tr");
                                row.innerHTML = '<td colspan="8" style="text-align: center;">No progress reports found for this employee</td>';
                                tableBody.appendChild(row);
                                return;
                            }
                            reports.forEach((report) => {
                                const statusClass = report.status.toLowerCase();
                                const row = document.createElement("tr");
                                row.innerHTML = `
                                    <td>${report.employee}</td>
                                    <td>${report.date}</td>
                                    <td>${report.time}</td>
                                    <td>${report.details}</td>
                                    <td>${report.fileName || "No file"}</td>
                                    <td>
                                        ${report.fileData
                                        ? `<a href="${report.fileData}" download="${report.fileName}" class="download-link">
                                                    <i class="fas fa-download"></i> Download</a>`: "No file"
                                    }
                                    </td>
                                    <td>
                                        <select onchange="updateProgressStatus(this.value, '${report.date}', '${report.time}', '${report.employee}')" class="status-${statusClass}">
                                            <option value="Pending" ${report.status === "Pending" ? "selected" : ""}>Pending Review</option>
                                            <option value="Approved" ${report.status === "Approved" ? "selected" : ""}>Approved</option>
                                            <option value="Needs Revision" ${report.status === "Needs Revision" ? "selected" : ""}>Needs Revision</option>
                                </select>
                            </td>
                                    <td>
                                        <div class="remarks-container">
                                            <textarea class="admin-remarks" placeholder="Add remarks..."
                                                onchange="updateProgressRemarks(this.value, '${report.date}', '${report.time}', '${report.employee}')"
                                            >${report.remarks || ''}</textarea>
                                        </div>
                            </td>`;
                                tableBody.appendChild(row);
                            });
                            localStorage.setItem("progressReports", JSON.stringify(reports));
                        })
                        .catch((error) => {
                            console.error("Error fetching progress reports:", error);
                            const progressReports = JSON.parse(localStorage.getItem("progressReports")) || [];
                            const reports = progressReports
                                .filter(report => !selectedUser || report.employee === selectedUser)
                                .sort((a, b) => {
                                    const dateA = new Date(a.date + " " + a.time);
                                    const dateB = new Date(b.date + " " + b.time);
                                    return dateB - dateA;
                                });
                            if (selectedUser && reports.length === 0) {
                                const row = document.createElement("tr");
                                row.innerHTML = '<td colspan="8" style="text-align: center;">No progress reports found for this employee</td>';
                                tableBody.appendChild(row);
                                return;
                            }
                            reports.forEach((report) => {
                                const statusClass = report.status.toLowerCase();
                                const row = document.createElement("tr");
                                row.innerHTML = `
                            <td>${report.employee}</td>
                            <td>${report.date}</td>
                            <td>${report.time}</td>
                            <td>${report.details}</td>
                                    <td>${report.fileName || "No file"}</td>
                                    <td>
                                        ${report.fileData
                                        ? `<a href="${report.fileData}" download="${report.fileName}" class="download-link">
                                                    <i class="fas fa-download"></i> Download
                                                </a>`
                                        : "No file"
                                    }
                                    </td>
                                    <td>
                                        <select onchange="updateProgressStatus(this.value, '${report.date}', '${report.time}', '${report.employee}')" class="status-${statusClass}">
                                            <option value="Pending" ${report.status === "Pending" ? "selected" : ""}>Pending Review</option>
                                            <option value="Approved" ${report.status === "Approved" ? "selected" : ""}>Approved</option>
                                            <option value="Needs Revision" ${report.status === "Needs Revision" ? "selected" : ""}>Needs Revision</option>
                                </select>
                            </td>
                                    <td>
                                        <div class="remarks-container">
                                            <textarea class="admin-remarks" placeholder="Add remarks..."
                                                onchange="updateProgressRemarks(this.value, '${report.date}', '${report.time}', '${report.employee}')"
                                            >${report.remarks || ''}</textarea>
                                        </div>
                            </td>`;
                                tableBody.appendChild(row);
                            });
                        });
                }
                function updateProgressStatus(status, date, time, employee) {
                    getFirebaseData("progressReports", (firebaseProgressReports) => {
                        let progressReports =
                            firebaseProgressReports ||
                            JSON.parse(localStorage.getItem("progressReports")) ||
                            [];
                        const reportIndex = progressReports.findIndex(
                            (report) =>
                                report.date === date &&
                                report.time === time &&
                                report.employee === employee
                        );
                        if (reportIndex !== -1) {
                            progressReports[reportIndex].status = status;
                            saveToFirebase("progressReports", progressReports)
                                .then(() => {
                                    localStorage.setItem(
                                        "progressReports",
                                        JSON.stringify(progressReports)
                                    );
                                    loadAdminProgressReports(
                                        document.getElementById("adminUserSelect").value
                                    );
                                    loadEmployeeProgress();
                                })
                                .catch((error) => {
                                    console.error(
                                        "Error updating progress status in Firebase:",
                                        error
                                    );
                                    localStorage.setItem(
                                        "progressReports",
                                        JSON.stringify(progressReports)
                                    );
                                    loadAdminProgressReports(
                                        document.getElementById("adminUserSelect").value
                                    );
                                    loadEmployeeProgress();
                                });
                        }
                    });
                }
                function updateProgressRemarks(remarks, date, time, employee) {
                    getFirebaseData("progressReports", (firebaseProgressReports) => {
                        let progressReports =
                            firebaseProgressReports ||
                            JSON.parse(localStorage.getItem("progressReports")) ||
                            [];
                        const reportIndex = progressReports.findIndex(
                            (report) =>
                                report.date === date &&
                                report.time === time &&
                                report.employee === employee
                        );
                        if (reportIndex !== -1) {
                            progressReports[reportIndex].remarks = remarks;
                            saveToFirebase("progressReports", progressReports)
                                .then(() => {
                                    localStorage.setItem(
                                        "progressReports",
                                        JSON.stringify(progressReports)
                                    );
                                    loadAdminProgressReports(
                                        document.getElementById("adminUserSelect").value
                                    );
                                    loadEmployeeProgress();
                                })
                                .catch((error) => {
                                    console.error(
                                        "Error updating progress remarks in Firebase:",
                                        error
                                    );
                                    localStorage.setItem(
                                        "progressReports",
                                        JSON.stringify(progressReports)
                                    );
                                    loadAdminProgressReports(
                                        document.getElementById("adminUserSelect").value
                                    );
                                    loadEmployeeProgress();
                                });
                        }
                    });
                }
                function showAdminSection(sectionName) {
                    const sections = [
                        "adminAttendance",
                        "adminProgress",
                        "adminHolidays",
                        "adminTimeTable",
                        "adminTargets",
                        "weeklyAttendance",
                        "adminCompensations"
                    ];
                    sections.forEach((section) => {
                        const element = document.getElementById(section);
                        if (element) element.style.display = "none";
                    });
                    const selectedSection = document.getElementById(sectionName);
                    if (selectedSection) {
                        selectedSection.style.display = "block";
                        const selectedUser =
                            document.getElementById("adminUserSelect")?.value || "";
                        switch (sectionName) {
                            case "adminAttendance":
                                loadAdminData(selectedUser);
                                break;
                            case "adminProgress":
                                loadAdminProgressReports(selectedUser);
                                break;
                            case "adminHolidays":
                                loadAdminHolidayRequests(selectedUser);
                                break;
                            case "adminTimeTable":
                                loadAdminTimeTable(selectedUser);
                                break;
                            case "adminTargets":
                                loadAdminTasks(selectedUser);
                                break;
                            case "weeklyAttendance":
                                loadWeeklyAttendanceSummary();
                                break;
                            case "adminCompensations":
                                loadAdminCompensations(selectedUser);
                                break;
                        }
                    }
                }
                function addUninformedLeave() {
                    const selectedUser =
                        document.getElementById("adminUserSelect").value;
                    if (!selectedUser) {
                        alert("Please select an employee first");
                        return;
                    }
                    const today = new Date();
                    const dateString = today.toLocaleDateString();
                    const dayNames = [
                        "Sunday",
                        "Monday",
                        "Tuesday",
                        "Wednesday",
                        "Thursday",
                        "Friday",
                        "Saturday",
                    ];
                    const dayName = dayNames[today.getDay()];
                    let holidayRequests =
                        JSON.parse(localStorage.getItem("holidayRequests")) || [];
                    const uninformedLeave = {
                        id: Date.now(),
                        employee: selectedUser,
                        employeeName: selectedUser,
                        startDate: dateString,
                        endDate: dateString,
                        days: 1,
                        reason: "Uninformed Leave",
                        status: "uninformed",
                        requestDate: new Date().toISOString(),
                    };
                    holidayRequests.push(uninformedLeave);
                    localStorage.setItem(
                        "holidayRequests",
                        JSON.stringify(holidayRequests)
                    );
                    alert(
                        `Uninformed leave has been recorded for ${selectedUser} on ${dateString}`
                    );
                    loadAdminHolidayRequests(selectedUser);
                }
                function loadAdminHolidayRequests(selectedUser = "") {
                    const requests =
                        JSON.parse(localStorage.getItem("holidayRequests")) || [];
                    const tableBody = document.getElementById(
                        "adminHolidayRequestsTable"
                    );
                    const statusFilter = document.getElementById(
                        "holidayStatusFilter"
                    ).value;
                    if (!tableBody) {
                        console.error("Admin holiday requests table not found");
                        return;
                    }
                    tableBody.innerHTML = "";
                    let filteredRequests = requests;
                    if (selectedUser) {
                        filteredRequests = filteredRequests.filter(
                            (request) =>
                                request.employeeName === selectedUser ||
                                request.employee === selectedUser
                        );
                    }
                    if (statusFilter !== "all") {
                        filteredRequests = filteredRequests.filter(
                            (request) => request.status === statusFilter
                        );
                    }
                    if (filteredRequests.length === 0) {
                        const row = document.createElement("tr");
                        row.innerHTML =
                            '<td colspan="7" style="text-align: center;">No holiday requests found</td>';
                        tableBody.appendChild(row);
                        return;
                    }
                    filteredRequests.forEach((request, index) => {
                        const row = document.createElement("tr");
                        row.innerHTML = `
            <td>${request.employeeName || request.employee}</td>
            <td>${request.startDate}</td>
            <td>${request.endDate}</td>
            <td>${request.days}</td>
            <td>${request.reason}</td>
            <td><span class="status-${request.status.toLowerCase()}">${(request.status || "Pending").charAt(0).toUpperCase() +
                            (request.status || "pending").slice(1)
                            }</span></td>
            <td class="action-buttons">
                ${request.status === "pending"
                                ? `
                    <button class="approve-btn" data-id="${request.id}">Approve</button>
                    <button class="reject-btn" data-id="${request.id}">Reject</button> `
                                : ""
                            }
            </td>`;
                        tableBody.appendChild(row);
                    });
                    function updateHolidayStatus(requestId, newStatus) {
                        let requests =
                            JSON.parse(localStorage.getItem("holidayRequests")) || [];

                        let requestIndex = requests.findIndex(
                            (req) => req.id == requestId
                        );
                        if (requestIndex === -1) {
                            alert("Request not found!");
                            return;
                        }
                        requests[requestIndex].status = newStatus;
                        localStorage.setItem("holidayRequests", JSON.stringify(requests));
                        loadAdminHolidayRequests();
                        alert(`Holiday request has been ${newStatus}`);
                    }
                    document.querySelectorAll(".approve-btn").forEach((button) => {
                        button.addEventListener("click", () => {
                            updateHolidayStatus(button.dataset.id, "approved");
                        });
                    });
                    document.querySelectorAll(".reject-btn").forEach((button) => {
                        button.addEventListener("click", () => {
                            updateHolidayStatus(button.dataset.id, "rejected");
                        });
                    });
                }
                function saveHolidayRequest() {
                    const employee = document.getElementById("employeeDetails").textContent.split("|")[0].trim();
                    const startDate = document.getElementById("startDate").value;
                    const endDate = document.getElementById("endDate").value;
                    const reason = document.getElementById("reason").value;
                    if (!startDate || !endDate || !reason) {
                        alert("Please fill all fields");
                        return;
                    }
                    let holidayRequests = JSON.parse(localStorage.getItem("holidayRequests")) || [];
                    const requestId = new Date().getTime();
                    holidayRequests.push({
                        id: requestId,
                        employee,
                        startDate,
                        endDate,
                        reason,
                        status: "pending",
                        requestDate: new Date().toISOString(),
                    });
                    localStorage.setItem(
                        "holidayRequests",
                        JSON.stringify(holidayRequests)
                    );
                    alert("Holiday request submitted successfully!");
                }
                function openTimeTableModal() {
                    const employee = document.getElementById("employeeDetails").textContent.split("|")[0].trim();
                    const currentDate = new Date();
                    const weekStart = getWeekStart(currentDate);
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekStart.getDate() + 6);
                    document.getElementById("modalOverlay").style.display = "block";
                    document.getElementById("timeTableContent").style.display = "block";
                    getFirebaseData("timeTables", (firebaseTimeTables) => {
                        const timeTables = firebaseTimeTables || [];
                        const timeTable = timeTables.find(t => t.employee === employee) || {};
                        const isLocked = timeTable.lastSaved && new Date(timeTable.lastSaved) >= weekStart;
                        const isAdminEdited = timeTable.adminEdited && new Date(timeTable.adminEdited) >= weekStart;
                        const noticeDiv = document.createElement("div");
                        noticeDiv.className = "notice-div";
                        noticeDiv.style.backgroundColor = "#fff3cd";
                        noticeDiv.style.padding = "15px";
                        noticeDiv.style.marginBottom = "20px";
                        noticeDiv.style.borderRadius = "4px";
                        noticeDiv.style.border = "1px solid #ffeeba";
                        if (isLocked) {
                            if (isAdminEdited) {
                                noticeDiv.innerHTML = `<strong>Notice:</strong> Your timetable for the current week (${weekStart.toLocaleDateString()} - ${weekEnd.toLocaleDateString()}) has been modified by an administrator. You cannot modify it further.`;
                            } else {
                                noticeDiv.innerHTML = `<strong>Notice:</strong> Time table for the current week (${weekStart.toLocaleDateString()} - ${weekEnd.toLocaleDateString()}) has already been set. You cannot modify it. Please contact your administrator for any changes.`;
                            }
                            document.querySelectorAll('#timeTableContent input, #timeTableContent button.add-slot-btn, #timeTableContent button.remove-slot').forEach(el => {
                                el.disabled = true;
                            });
                            document.querySelector('#timeTableContent button.save-timetable-btn').style.display = 'none';
                        } else {
                            noticeDiv.innerHTML = `<strong>Notice:</strong> Please set your time table for the current week (${weekStart.toLocaleDateString()} - ${weekEnd.toLocaleDateString()}). Once saved, it cannot be modified until next week.`;
                            document.querySelectorAll('#timeTableContent input, #timeTableContent button').forEach(el => {
                                el.disabled = false;
                            });
                            document.querySelector('#timeTableContent button.save-timetable-btn').style.display = 'block';
                        }
                        const contentDiv = document.getElementById("timeTableContent");
                        const existingNotice = contentDiv.querySelector(".notice-div");
                        if (existingNotice) {
                            existingNotice.remove();
                        }
                        contentDiv.insertBefore(noticeDiv, contentDiv.firstChild);
                        populateTimeTableSlots(timeTable);
                    });
                }
                function saveTimeTable() {
                    const employee = document.getElementById("employeeDetails").textContent.split("|")[0].trim();
                    const currentDate = new Date();
                    const weekStart = getWeekStart(currentDate);
                    
                    // Get all time slots
                        const timeTable = {
                        employee: employee,
                        weekStart: weekStart.toISOString(),
                        lastSaved: new Date().toISOString()
                    };

                    const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
                    let hasValidSlots = false;

                    for (const day of days) {
                        const daySlots = document.getElementById(`${day}Slots`);
                        const slots = [];
                        daySlots.querySelectorAll('.time-slot-row').forEach(row => {
                            const inputs = row.querySelectorAll('input[type="time"]');
                            const checkIn = inputs[0].value;
                            const checkOut = inputs[1].value;
                            if (checkIn && checkOut) {
                                const checkInTime = new Date(`1970-01-01T${checkIn}`);
                                const checkOutTime = new Date(`1970-01-01T${checkOut}`);
                                if (checkInTime >= checkOutTime) {
                                    alert(`Check-out time must be after check-in time for ${day}`);
                                    return;
                                }
                                slots.push({ checkIn, checkOut });
                                hasValidSlots = true;
                            }
                        });
                        if (slots.length > 0) {
                            timeTable[day] = { slots };
                        }
                    }

                    if (!hasValidSlots) {
                        alert("Please add at least one valid time slot");
                        return;
                    }

                    // Save to Firebase
                    database.ref("timeTables").once('value', (snapshot) => {
                        let timeTables = snapshot.val() || [];
                        const existingIndex = timeTables.findIndex(t => t.employee === employee);
                        
                        if (existingIndex !== -1) {
                            timeTables[existingIndex] = timeTable;
                        } else {
                            timeTables.push(timeTable);
                        }

                        database.ref("timeTables").set(timeTables)
                            .then(() => {
                                localStorage.setItem("timeTables", JSON.stringify(timeTables));
                                alert("Schedule saved successfully!");
                                closeTimeTableModal();
                            })
                            .catch(error => {
                                console.error("Error saving timetable to Firebase:", error);
                                alert("Error saving schedule. Please try again.");
                            });
                    });
                }
                function openEditTimeTableModal() {
                    const selectedUser = document.getElementById("adminUserSelect").value;
                    if (!selectedUser) {
                        alert("Please select an employee first");
                        return;
                    }
                    document.getElementById("modalOverlay").style.display = "block";
                    document.getElementById("editTimeTableModal").style.display = "block";
                    document.getElementById("editTimeTableContent").style.display = "block";
                    getFirebaseData("timeTables", (firebaseTimeTables) => {
                        const timeTables = firebaseTimeTables || [];
                        const timeTable = timeTables.find(t => t.employee === selectedUser) || {};
                        populateEditTimeTableSlots(timeTable);
                    });
                }
                function saveEditedTimeTable() {
                    const selectedUser = document.getElementById("adminUserSelect").value;
                    const days = ["monday", "tuesday", "wednesday", "thursday", "friday", "saturday"];
                    const currentDate = new Date();
                    const weekStart = getWeekStart(currentDate);
                    const timeTable = {
                        employee: selectedUser,
                        lastSaved: new Date().toISOString(),
                        weekStart: weekStart.toISOString(),
                        adminEdited: new Date().toISOString()
                    };
                    let hasValidSlots = false;
                    for (const day of days) {
                        const daySlots = document.getElementById(`edit${day.charAt(0).toUpperCase() + day.slice(1)}Slots`);
                        const slots = [];
                        daySlots.querySelectorAll('.time-slot-row').forEach(row => {
                            const inputs = row.querySelectorAll('input[type="time"]');
                            const checkIn = inputs[0].value;
                            const checkOut = inputs[1].value;
                            if (checkIn && checkOut) {
                                const checkInTime = new Date(`1970-01-01T${checkIn}`);
                                const checkOutTime = new Date(`1970-01-01T${checkOut}`);
                                if (checkInTime >= checkOutTime) {
                                    alert(`Check-out time must be after check-in time for ${day}`);
                                    return;
                                }
                                slots.push({ checkIn, checkOut });
                                hasValidSlots = true;
                            }
                        });
                        if (slots.length > 0) {
                            timeTable[day] = { slots };
                        }
                    }
                    if (!hasValidSlots) {
                        alert("Please add at least one valid time slot");
                        return;
                    }
                    getFirebaseData("timeTables", (firebaseTimeTables) => {
                        handleTimeTableSave(firebaseTimeTables, timeTable,
                            () => {
                                closeEditTimeTableModal();
                                loadAdminTimeTable(selectedUser);
                                alert("Time table updated successfully!");
                            },
                            (error) => {
                                console.error("Error saving time table:", error);
                                alert("Error saving time table. Please try again.");
                            }
                        );
                    });
                }
                function getWeekStart(date) {
                    const weekStart = new Date(date);
                    weekStart.setDate(date.getDate() - (date.getDay() === 0 ? 6 : date.getDay() - 1));
                    weekStart.setHours(0, 0, 0, 0);
                    return weekStart;
                }
                function populateTimeTableSlots(timeTable) {
                    const days = ["monday", "tuesday", "wednesday", "thursday", "friday", "saturday"];
                    days.forEach(day => {
                        const daySlots = document.getElementById(`${day}Slots`);
                        daySlots.innerHTML = '';
                        const slots = timeTable[day]?.slots || [];
                        if (slots.length === 0) {
                            addTimeSlot(day);
                        } else {
                            slots.forEach(slot => {
                                addTimeSlot(day, slot.checkIn, slot.checkOut);
                            });
                        }
                    });
                }
                function populateEditTimeTableSlots(timeTable) {
                    const days = ["monday", "tuesday", "wednesday", "thursday", "friday", "saturday"];
                    days.forEach(day => {
                        const daySlots = document.getElementById(`edit${day.charAt(0).toUpperCase() + day.slice(1)}Slots`);
                        daySlots.innerHTML = '';
                        const slots = timeTable[day]?.slots || [];
                        if (slots.length === 0) {
                            addTimeSlot(`edit${day.charAt(0).toUpperCase() + day.slice(1)}`);
                        } else {
                            slots.forEach(slot => {
                                addTimeSlot(`edit${day.charAt(0).toUpperCase() + day.slice(1)}`, slot.checkIn, slot.checkOut);
                            });
                        }
                    });
                }
                function resetWeeklyTimetables() {
                    const currentDate = new Date();
                    const weekStart = getWeekStart(currentDate);
                    getFirebaseData("timeTables", (firebaseTimeTables) => {
                        if (!firebaseTimeTables) return;
                        const updatedTimeTables = firebaseTimeTables.map(timeTable => {
                            const tableWeekStart = timeTable.weekStart ? new Date(timeTable.weekStart) : null;
                            if (!tableWeekStart || tableWeekStart < weekStart) {
                                const { lastSaved, adminEdited, ...rest } = timeTable;
                                return rest;
                            }
                            return timeTable;
                        });
                        saveToFirebase("timeTables", updatedTimeTables)
                            .catch(error => console.error("Error resetting weekly timetables:", error));
                    });
                }
                setInterval(() => {
                    const now = new Date();
                    if (now.getDay() === 1 && now.getHours() === 0 && now.getMinutes() === 0) {
                        resetWeeklyTimetables();
                    }
                }, 60000);
                function addTimeSlot(day, checkIn, checkOut) {
                    const slotsContainer = document.getElementById(`${day}Slots`);
                    const slotCount = slotsContainer.children.length;
                    const newSlot = document.createElement("div");
                    newSlot.className = "time-slot-row";
                    newSlot.innerHTML = `
                        <input type="time" class="time-input" value="${checkIn}" />
                        <input type="time" class="time-input" value="${checkOut}" />
                        <button class="remove-slot" onclick="removeTimeSlot(this)">Ã—</button>
                        `;
                    slotsContainer.appendChild(newSlot);
                }
                function removeTimeSlot(button) {
                    const slotRow = button.parentElement;
                    slotRow.remove();
                }
                function closeTimeTableModal() {
                    document.getElementById("timeTableContent").style.display = "none";
                    document.getElementById("modalOverlay").style.display = "none";
                }
                function showAdminSection(sectionName) {
                    const sections = [
                        "adminAttendance",
                        "adminProgress",
                        "adminHolidays",
                        "adminTimeTable",
                        "adminTargets",
                        "weeklyAttendance",
                        "adminCompensations"
                    ];
                    sections.forEach((section) => {
                        const element = document.getElementById(section);
                        if (element) element.style.display = "none";
                    });
                    const selectedSection = document.getElementById(sectionName);
                    if (selectedSection) {
                        selectedSection.style.display = "block";
                        const selectedUser =
                            document.getElementById("adminUserSelect")?.value || "";
                        switch (sectionName) {
                            case "adminAttendance":
                                loadAdminData(selectedUser);
                                break;
                            case "adminProgress":
                                loadAdminProgressReports(selectedUser);
                                break;
                            case "adminHolidays":
                                loadAdminHolidayRequests(selectedUser);
                                break;
                            case "adminTimeTable":
                                loadAdminTimeTable(selectedUser);
                                break;
                            case "adminTargets":
                                loadAdminTasks(selectedUser);
                                break;
                            case "weeklyAttendance":
                                loadWeeklyAttendanceSummary();
                                break;
                            case "adminCompensations":
                                loadAdminCompensations(selectedUser);
                                break;
                        }
                    }
                }
                function logout() {
                    localStorage.removeItem("loggedInUser");
                    showPage("loginPage");
                    document.getElementById("userName").value = "";
                    document.getElementById("userPassword").value = "";
                }
                function loadAttendanceTable() {
                    const employee = document.getElementById("employeeDetails").textContent.split("|")[0].trim();
                    getFirebaseData("attendanceRecords", (firebaseAttendanceRecords) => {
                        let attendanceRecords = firebaseAttendanceRecords || [];
                        
                        // Filter records for current employee
                        const employeeRecords = attendanceRecords.filter(record => record.employee === employee);
                        
                        // Sort records by date in descending order (newest first)
                        employeeRecords.sort((a, b) => new Date(b.date) - new Date(a.date));

                        // Group records by date
                        const groupedRecords = employeeRecords.reduce((acc, record) => {
                            if (!acc[record.date]) {
                                acc[record.date] = {
                                    employee: record.employee,
                                    date: record.date,
                                    day: record.day,
                                    checkIns: [],
                                    checkOuts: [],
                                    lateCheckIns: []
                                };
                            }
                            if (record.checkIn) {
                                if (Array.isArray(record.checkIn)) {
                                    acc[record.date].checkIns.push(...record.checkIn);
                                } else {
                                    acc[record.date].checkIns.push(record.checkIn);
                                }
                            }
                            if (record.checkOut) {
                                if (Array.isArray(record.checkOut)) {
                                    acc[record.date].checkOuts.push(...record.checkOut);
                                } else {
                                    acc[record.date].checkOuts.push(record.checkOut);
                                }
                            }
                            return acc;
                        }, {});

                        // Get late check-ins
                        getFirebaseData("lateCheckIns", (firebaseLateCheckIns) => {
                            const lateCheckIns = firebaseLateCheckIns || [];
                            lateCheckIns.forEach(late => {
                                if (late.employee === employee && groupedRecords[late.date]) {
                                    groupedRecords[late.date].lateCheckIns.push(late.time);
                                }
                            });

                        const tableBody = document.getElementById("attendanceTable");
                            if (!tableBody) return;
                            tableBody.innerHTML = "";

                            // Sort dates in descending order
                            const sortedDates = Object.keys(groupedRecords).sort((a, b) => new Date(b) - new Date(a));

                            sortedDates.forEach(date => {
                                const record = groupedRecords[date];
                                const checkInTimes = record.checkIns.sort((a, b) => new Date(`1970-01-01T${a}`) - new Date(`1970-01-01T${b}`));
                                const checkOutTimes = record.checkOuts.sort((a, b) => new Date(`1970-01-01T${b}`) - new Date(`1970-01-01T${a}`));
                                const lateCheckInTimes = record.lateCheckIns.sort((a, b) => new Date(`1970-01-01T${b}`) - new Date(`1970-01-01T${a}`));

                                const workingHours = calculateWorkingHours(
                                    checkInTimes,
                                    checkOutTimes,
                                    lateCheckInTimes
                                );

                                const row = document.createElement("tr");
                                    row.innerHTML = `
                                        <td>${record.date}</td>
                                        <td>${record.day}</td>
                                    <td>
                                        <select class="check-in-select" onchange="updateWorkingHours(this)">
                                            ${checkInTimes.map(time => `<option value="${time}">${time}</option>`).join('')}
                                        </select>
                                    </td>
                                    <td>
                                        <select class="check-out-select" onchange="updateWorkingHours(this)">
                                            ${checkOutTimes.map(time => `<option value="${time}">${time}</option>`).join('')}
                                        </select>
                                    </td>
                                    <td>${lateCheckInTimes[0] || "-"}</td>
                                    <td>${workingHours}</td>
                                    `;
                                    tableBody.appendChild(row);
                                });
                        });
                    });
                }
                function calculateWorkingHours(checkIn, checkOut, lateCheckIns = []) {
                    if (!checkIn && !checkOut && !lateCheckIns.length) {
                        return "Incomplete";
                    }
                    const checkIns = Array.isArray(checkIn) ? checkIn : checkIn ? [checkIn] : [];
                    const checkOuts = Array.isArray(checkOut) ? checkOut : checkOut ? [checkOut] : [];
                    const lateChecks = Array.isArray(lateCheckIns) ? lateCheckIns : lateCheckIns ? [lateCheckIns] : [];
                    let regularHours = 0;
                    let lateHours = 0;
                    const allCheckIns = [...checkIns].sort((a, b) => timeToMinutes(a) - timeToMinutes(b));
                    const allCheckOuts = [...checkOuts].sort((a, b) => timeToMinutes(a) - timeToMinutes(b));
                    const allLateChecks = [...lateChecks].sort((a, b) => timeToMinutes(a) - timeToMinutes(b));
                    for (let i = 0; i < allCheckOuts.length; i++) {
                        const checkOut = allCheckOuts[i];
                        let foundValidCheckIn = false;
                        const validCheckIn = [...allCheckIns, ...allLateChecks].find(checkIn => {
                            const checkInTime = timeToMinutes(checkIn);
                            const checkOutTime = timeToMinutes(checkOut);
                            return checkInTime < checkOutTime;
                        });
                        if (!validCheckIn) {
                            return "Invalid: Check-out time is earlier than check-in time";
                        }
                    }
                    let remainingCheckOuts = [...allCheckOuts];
                    let processedCheckIns = new Set();
                    for (let i = 0; i < allCheckIns.length; i++) {
                        const currentCheckIn = allCheckIns[i];
                        if (allLateChecks.some(late => Math.abs(timeToMinutes(late) - timeToMinutes(currentCheckIn)) < 5)) {
                            continue;
                        }
                        const matchingCheckOutIndex = remainingCheckOuts.findIndex(
                            out => timeToMinutes(out) > timeToMinutes(currentCheckIn)
                        );
                        if (matchingCheckOutIndex !== -1) {
                            const matchingCheckOut = remainingCheckOuts[matchingCheckOutIndex];
                            let minutesWorked = timeToMinutes(matchingCheckOut) - timeToMinutes(currentCheckIn);
                            regularHours += minutesWorked / 60;
                            processedCheckIns.add(currentCheckIn);
                            remainingCheckOuts.splice(matchingCheckOutIndex, 1);
                        }
                    }
                    for (let i = 0; i < allLateChecks.length; i++) {
                        const lateCheckIn = allLateChecks[i];
                        if (processedCheckIns.has(lateCheckIn)) continue;
                        const matchingCheckOutIndex = remainingCheckOuts.findIndex(
                            out => timeToMinutes(out) > timeToMinutes(lateCheckIn)
                        );
                        if (matchingCheckOutIndex !== -1) {
                            const matchingCheckOut = remainingCheckOuts[matchingCheckOutIndex];
                            let minutesWorked = timeToMinutes(matchingCheckOut) - timeToMinutes(lateCheckIn);
                            lateHours += minutesWorked / 60;
                            remainingCheckOuts.splice(matchingCheckOutIndex, 1);
                        }
                    }
                    const totalHours = regularHours + lateHours;
                    if (totalHours === 0) {
                        return "0h 0m";
                    } else if (regularHours > 0 && lateHours > 0) {
                        return `${formatHours(regularHours)} + ${formatHours(lateHours)} (late) = ${formatHours(totalHours)}`;
                    } else if (regularHours > 0) {
                        return formatHours(regularHours);
                    } else {
                        return `${formatHours(lateHours)} (late)`;
                    }
                }
                function timeToMinutes(timeStr) {
                    if (!timeStr) return 0;
                    const [hours, minutes] = timeStr.split(":").map(Number);
                    return hours * 60 + minutes;
                }
                function formatHours(hours) {
                    const wholeHours = Math.floor(hours);
                    const minutes = Math.round((hours - wholeHours) * 60);
                    return `${wholeHours}h ${minutes}m`;
                }
                function addAttendanceRecord(type) {
                    const now = new Date();
                    const employee = document.getElementById("employeeDetails").textContent.split("|")[0].trim();
                    
                    // Use standardized date format
                    const date = standardizeDate(now);
                    const day = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"][now.getDay()];
                    const time = now.toLocaleTimeString();
                    
                    getFirebaseData("attendanceRecords", (firebaseRecords) => {
                        let attendanceRecords = firebaseRecords || JSON.parse(localStorage.getItem("attendanceRecords")) || [];
                        const recordIndex = attendanceRecords.findIndex(
                            (record) => record.employee === employee && record.date === date
                        );
                        
                        if (recordIndex === -1) {
                            const newRecord = {
                                employee: employee,
                                date: date,
                                day: day,
                            };
                            if (type === "checkIn") {
                                newRecord.checkIn = time;
                            } else if (type === "checkOut") {
                                newRecord.checkOut = time;
                            }
                            attendanceRecords.push(newRecord);
                        } else {
                            if (type === "checkIn") {
                                attendanceRecords[recordIndex].checkIn = time;
                            } else if (type === "checkOut") {
                                if (Array.isArray(attendanceRecords[recordIndex].checkOut)) {
                                    attendanceRecords[recordIndex].checkOut.push(time);
                                } else if (attendanceRecords[recordIndex].checkOut) {
                                    attendanceRecords[recordIndex].checkOut = [
                                        attendanceRecords[recordIndex].checkOut,
                                        time,
                                    ];
                                } else {
                                    attendanceRecords[recordIndex].checkOut = time;
                                }
                            }
                        }
                        saveToFirebase("attendanceRecords", attendanceRecords)
                            .then(() => {
                                localStorage.setItem(
                                    "attendanceRecords",
                                    JSON.stringify(attendanceRecords)
                                );
                                updateSummaryValues();
                            })
                            .catch((error) => {
                                console.error("Error saving attendance record to Firebase:", error);
                                localStorage.setItem("attendanceRecords", JSON.stringify(attendanceRecords));
                                updateSummaryValues();
                            });
                    });
                }
                function formatTimeToAMPM(time) {
                    if (!time) return "-";
                    const [hours, minutes] = time.split(":");
                    const hour = parseInt(hours);
                    const ampm = hour >= 12 ? "PM" : "AM";
                    const formattedHour = hour % 12 || 12;
                    return `${formattedHour}:${minutes} ${ampm}`;
                }
                function updateAdminTimeTable(timeTable) {
                    if (!timeTable) return;
                    const days = [
                        "monday",
                        "tuesday",
                        "wednesday",
                        "thursday",
                        "friday",
                        "saturday",
                    ];
                    days.forEach((day) => {
                        if (timeTable[day]) {
                            const checkIn = timeTable[day].checkIn;
                            const checkOut = timeTable[day].checkOut;
                            document.getElementById(`admin${day.charAt(0).toUpperCase() + day.slice(1)}CheckIn`).textContent = formatTimeToAMPM(checkIn);
                            document.getElementById(`admin${day.charAt(0).toUpperCase() + day.slice(1)}CheckOut`).textContent = formatTimeToAMPM(checkOut);
                            document.getElementById(`admin${day.charAt(0).toUpperCase() + day.slice(1)}Hours`).textContent = calculateWorkingHours(checkIn, checkOut);
                        }
                    });
                }
                function updateSummaryValues() {
                    const employee = document.getElementById("employeeDetails").textContent.split("|")[0].trim();
                    
                    // Fetch attendance records from Firebase
                    database.ref("attendanceRecords").once('value', (snapshot) => {
                        const attendanceRecords = snapshot.val() || [];
                        
                        // Convert all dates to standardized format
                        const standardizedRecords = attendanceRecords.map(record => ({
                            ...record,
                            date: standardizeDate(record.date)
                        }));
                        
                        const employeeRecords = standardizedRecords.filter(
                        (record) => record.employee === employee
                    );
                        
                        // Fetch late check-ins from Firebase
                        database.ref("lateCheckIns").once('value', (snapshot) => {
                            const lateCheckIns = snapshot.val() || [];
                            const employeeLateCheckIns = lateCheckIns.filter(
                                checkIn => checkIn.employee === employee
                            );
                            
                            // Fetch holiday requests from Firebase
                            database.ref("holidayRequests").once('value', (snapshot) => {
                                const holidayRequests = snapshot.val() || [];
                                const employeeHolidayRequests = holidayRequests.filter(
                                    request => request.employee === employee
                                );
                                
                                // Calculate summary values
                    const totalCheckIns = employeeRecords.filter(
                        (record) => record.checkIn
                    ).length;
                                
                    const totalCheckOuts = employeeRecords.reduce((total, record) => {
                        if (Array.isArray(record.checkOut)) {
                            return total + record.checkOut.length;
                                    } else if (record.checkOut) {
                            return total + 1;
                        }
                        return total;
                    }, 0);
                                
                                const totalLateCheckIns = employeeLateCheckIns.length;
                                
                    const today = new Date();
                                const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                                const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
                                
                    let totalAbsences = 0;
                                let unapprovedLeaves = 0;
                                
                    for (let day = 1; day <= daysInMonth; day++) {
                        const date = new Date(today.getFullYear(), today.getMonth(), day);
                        if (date > today) break;
                        if (date.getDay() === 0 || date.getDay() === 6) continue;
                                    
                                    const dateString = standardizeDate(date);
                        const hasAttendance = employeeRecords.some(
                            (record) => record.date === dateString
                        );
                                    
                                    const hasApprovedLeave = employeeHolidayRequests.some((leave) => {
                            const startDate = new Date(leave.startDate);
                            const endDate = new Date(leave.endDate);
                            return (
                                startDate <= date &&
                                endDate >= date &&
                                            leave.status === "approved"
                                        );
                                    });
                                    
                                    const hasUnapprovedLeave = employeeHolidayRequests.some((leave) => {
                                        const startDate = new Date(leave.startDate);
                                        const endDate = new Date(leave.endDate);
                                        return (
                                            startDate <= date &&
                                            endDate >= date &&
                                            leave.status === "pending"
                                        );
                                    });
                                    
                        if (!hasAttendance && !hasApprovedLeave) {
                            totalAbsences++;
                        }
                                    
                                    if (hasUnapprovedLeave) {
                                        unapprovedLeaves++;
                    }
                                }
                                
                                // Update the UI
                    document.getElementById("totalCheckIns").textContent = totalCheckIns;
                    document.getElementById("totalCheckOuts").textContent = totalCheckOuts;
                    document.getElementById("lateCheckIns").textContent = totalLateCheckIns;
                    document.getElementById("totalAbsences").textContent = totalAbsences;
                    document.getElementById("unapprovedLeaves").textContent = unapprovedLeaves;
                            });
                        });
                    });
                }
                function handleFileSelect(input) {
                    const file = input.files[0];
                    const fileName = document.getElementById("fileName");
                    const fileUploadedIcon = document.getElementById("fileUploadedIcon");
                    if (file) {
                        fileName.textContent = file.name;
                        fileUploadedIcon.style.display = "inline-block";
                    } else {
                        fileName.textContent = "";
                        fileUploadedIcon.style.display = "none";
                    }
                }
                function closeHolidayModal() {
                    const modal = document.getElementById("holidayModal");
                    const overlay = document.getElementById("modalOverlay");
                    const frame = document.getElementById("holidayFrame");
                    if (modal) modal.style.display = "none";
                    if (overlay) overlay.style.display = "none";
                    if (frame) frame.src = "";
                }
                document.getElementById("holidayRequestForm").addEventListener("submit", function (e) {
                    e.preventDefault();
                    const employee = document.getElementById("employeeDetails").textContent.split("|")[0].trim();
                    const startDate = document.getElementById("startDate").value;
                    const endDate = document.getElementById("endDate").value;
                    const reason = document.getElementById("reason").value;
                    const requests = JSON.parse(localStorage.getItem("holidayRequests")) || [];
                    requests.push({
                        employee,
                        startDate,
                        endDate,
                        reason,
                        status: "pending",
                        requestDate: new Date().toISOString(),
                    });
                    localStorage.setItem("holidayRequests", JSON.stringify(requests));
                    alert("Holiday request submitted successfully!");
                    closeHolidayModal();
                });
                function generateReport() {
                    const employee = document.getElementById("adminUserSelect").value;
                    const reportType = document.getElementById("reportType").value;
                    if (!employee) {
                        alert("Please select an employee.");
                        return;
                    }
                    const attendanceRecords =
                        JSON.parse(localStorage.getItem("attendanceRecords")) || [];
                    const employeeRecords = attendanceRecords.filter(
                        (record) => record.employee === employee
                    );
                    let filteredRecords = [];
                    const today = new Date();
                    if (reportType === "daily") {
                        const todayStr = today.toLocaleDateString();
                        filteredRecords = employeeRecords.filter(
                            (record) => record.date === todayStr
                        );
                    } else if (reportType === "weekly") {
                        const weekStart = new Date(today);
                        weekStart.setDate(today.getDate() - today.getDay()); //Start of the week (Sunday)
                        filteredRecords = employeeRecords.filter((record) => {
                            const recordDate = new Date(record.date);
                            return recordDate >= weekStart && recordDate <= today;
                        });
                    } else if (reportType === "monthly") {
                        const monthStart = new Date(
                            today.getFullYear(),
                            today.getMonth(),
                            1
                        );
                        filteredRecords = employeeRecords.filter((record) => {
                            const recordDate = new Date(record.date);
                            return recordDate >= monthStart && recordDate <= today;
                        });
                    }
                    if (filteredRecords.length === 0) {
                        alert("No records found for the selected criteria.");
                        return;
                    }
                    downloadCSV(
                        filteredRecords,
                        `${employee}_${reportType}_report.csv`
                    );
                }
                function downloadCSV(data, filename) {
                    let csv = "Date,Day,Check-In Time,Check-Out Time,Late Check-Ins\n";
                    data.forEach((record) => {
                        csv += `${record.date},${record.day},${record.checkIn || "-"},${Array.isArray(record.checkOut)
                            ? record.checkOut.join(" | ")
                            : record.checkOut || "-"
                            },${record.lateCheckIns || "-"}\n`;
                    });
                    const blob = new Blob([csv], { type: "text/csv" });
                    const link = document.createElement("a");
                    link.href = URL.createObjectURL(blob);
                    link.download = filename;
                    link.click();
                }
                function loadAdminTasks(selectedUser = "") {
                    getFirebaseData("employeeTasks", (firebaseTasks) => {
                        const tasks = firebaseTasks || [];
                        const tableBody = document.getElementById("adminTasksTable");
                        if (!tableBody) return;
                        tableBody.innerHTML = "";
                        
                        if (!selectedUser) {
                            tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Please select an employee first</td></tr>';
                            return;
                        }

                        const filteredTasks = tasks.filter(task => task.employee === selectedUser)
                            .sort((a, b) => new Date(b.date) - new Date(a.date));

                        if (filteredTasks.length === 0) {
                            tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No tasks assigned yet</td></tr>';
                            return;
                        }

                        filteredTasks.forEach(task => {
                            const row = document.createElement("tr");
                            row.innerHTML = `
                <td>${task.date}</td>
                <td>${task.day}</td>
                <td>${task.description}</td>
                                <td>${task.fileName ? `<span class="file-icon">ðŸ“Ž</span> ${task.fileName}` : "No file"}</td>
                <td>${task.status}</td>
                                <td>${task.comment || ""}</td>
                <td>
                                    <button onclick="deleteTask(${task.id})" style="background-color: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">Delete</button>
                </td>
            `;
                            tableBody.appendChild(row);
                        });
                    });
                }
                function addNewTask() {
                    const selectedUser = document.getElementById("adminUserSelect").value;
                    if (!selectedUser) {
                        alert("Please select an employee first");
                        return;
                    }
                    const taskDate = document.getElementById("taskDate").value;
                    const taskDay = document.getElementById("taskDay").value;
                    const taskDescription = document.getElementById("taskDescription").value;
                    const taskFileInput = document.getElementById("taskFile");
                    const taskFile = taskFileInput.files[0];

                    if (!taskDate || !taskDescription) {
                        alert("Please fill in all required fields");
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = function (e) {
                        getFirebaseData("employeeTasks", (firebaseTasks) => {
                            let tasks = firebaseTasks || [];
                            const newTask = {
                                id: Date.now(),
                                employee: selectedUser,
                                date: taskDate,
                                day: taskDay,
                                description: taskDescription,
                                fileName: taskFile ? taskFile.name : "",
                                fileData: taskFile ? e.target.result : "",
                                status: "Pending",
                                comment: "",
                                saved: true,
                                lastModified: new Date().toISOString()
                            };
                            tasks.push(newTask);
                            saveToFirebase("employeeTasks", tasks)
                                .then(() => {
                                    loadAdminTasks(selectedUser);
                                    document.getElementById("taskDate").value = "";
                                    document.getElementById("taskDay").value = "";
                                    document.getElementById("taskDescription").value = "";
                                    taskFileInput.value = "";
                                    alert("Task assigned successfully!");
                                })
                                .catch((error) => {
                                    console.error("Error saving task to Firebase:", error);
                                    alert("Failed to assign task. Please try again.");
                                });
                        });
                    };

                    if (taskFile) {
                        reader.readAsDataURL(taskFile);
                    } else {
                        reader.onload();
                    }
                }
                function updateTaskField(taskId, field, value) {
                    getFirebaseData("employeeTasks", (firebaseTasks) => {
                        let tasks = firebaseTasks || JSON.parse(localStorage.getItem("employeeTasks")) || [];
                        const taskIndex = tasks.findIndex((t) => t.id === taskId);
                        if (taskIndex !== -1) {
                            tasks[taskIndex][field] = value;
                            saveToFirebase("employeeTasks", tasks)
                                .then(() => {
                                    localStorage.setItem(
                                        "employeeTasks",
                                        JSON.stringify(tasks)
                                    );
                                })
                                .catch((error) => {
                                    console.error(
                                        "Error updating task field in Firebase:",
                                        error
                                    );
                                    localStorage.setItem(
                                        "employeeTasks",
                                        JSON.stringify(tasks)
                                    );
                                });
                        }
                    });
                }
                function handleTaskFile(taskId, input) {
                    if (input.files && input.files[0]) {
                        const file = input.files[0];
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            getFirebaseData("employeeTasks", (firebaseTasks) => {
                                let tasks = firebaseTasks || JSON.parse(localStorage.getItem("employeeTasks")) || [];
                                const taskIndex = tasks.findIndex((t) => t.id === taskId);
                                if (taskIndex !== -1) {
                                    tasks[taskIndex].fileName = file.name;
                                    tasks[taskIndex].fileData = e.target.result;
                                    saveToFirebase("employeeTasks", tasks)
                                        .then(() => {
                                            localStorage.setItem("employeeTasks", JSON.stringify(tasks));
                                            const selectedUser =
                                                document.getElementById("adminUserSelect").value;
                                            loadAdminTasks(selectedUser);
                                        })
                                        .catch((error) => {
                                            console.error(
                                                "Error saving task file to Firebase:",
                                                error
                                            );
                                            localStorage.setItem(
                                                "employeeTasks",
                                                JSON.stringify(tasks)
                                            );
                                            const selectedUser =
                                                document.getElementById("adminUserSelect").value;
                                            loadAdminTasks(selectedUser);
                                        });
                                }
                            });
                        };
                        reader.readAsDataURL(file);
                    }
                }
                function deleteTask(taskId) {
                    if (confirm("Are you sure you want to delete this task?")) {
                        getFirebaseData("employeeTasks", (firebaseTasks) => {
                            let tasks = firebaseTasks || JSON.parse(localStorage.getItem("employeeTasks")) || [];
                            tasks = tasks.filter((t) => t.id !== taskId);
                            saveToFirebase("employeeTasks", tasks)
                                .then(() => {
                                    localStorage.setItem(
                                        "employeeTasks",
                                        JSON.stringify(tasks)
                                    );
                                    const selectedUser =
                                        document.getElementById("adminUserSelect").value;
                                    loadAdminTasks(selectedUser);
                                })
                                .catch((error) => {
                                    console.error("Error deleting task from Firebase:", error);
                                    // Still save to localStorage as backup
                                    localStorage.setItem(
                                        "employeeTasks",
                                        JSON.stringify(tasks)
                                    );
                                    const selectedUser =
                                        document.getElementById("adminUserSelect").value;
                                    loadAdminTasks(selectedUser);
                                    alert(
                                        "Task deleted locally. There was an issue syncing with the cloud."
                                    );
                                });
                        });
                    }
                }
                function saveTask(taskId) {
                    let tasks = JSON.parse(localStorage.getItem("employeeTasks")) || [];
                    const taskIndex = tasks.findIndex((t) => t.id === taskId);
                    if (taskIndex !== -1) {
                        const row = document.querySelector(`tr:has(button[onclick="saveTask(${taskId})"])`);
                        const description = row.querySelector('input[type="text"]').value;
                        const status = row.querySelector("select").value;
                        const comment =
                            row.querySelectorAll('input[type="text"]')[1].value;
                        tasks[taskIndex].description = description;
                        tasks[taskIndex].status = status;
                        tasks[taskIndex].comment = comment;
                        tasks[taskIndex].saved = true;
                        tasks[taskIndex].lastModified = new Date().toISOString();
                        localStorage.setItem("employeeTasks", JSON.stringify(tasks));
                        alert("Task saved successfully!");
                        const selectedUser = document.getElementById("adminUserSelect").value;
                        loadAdminTasks(selectedUser);
                    }
                }
                document.getElementById("taskDate").addEventListener("change", function () {
                    const date = new Date(this.value);
                    const day = date.toLocaleString("en-US", { weekday: "long" });
                    document.getElementById("taskDay").value = day;
                });
                document.addEventListener("DOMContentLoaded", function () {
                    const handleUserSelect = () => {
                        const selectedUser =
                            document.getElementById("adminUserSelect").value;
                        document.getElementById("selectedEmployeeName").textContent =
                            selectedUser || "No employee selected";
                        loadAdminData(selectedUser);
                        loadMissedCheckIns(selectedUser);
                        loadAdminProgressReports(selectedUser);
                        loadAdminTimeTable(selectedUser);
                        loadAdminHolidayRequests(selectedUser);
                        loadAdminTasks(selectedUser);
                    };
                    const adminUserSelect = document.getElementById("adminUserSelect");
                    if (adminUserSelect) {
                        adminUserSelect.addEventListener("change", handleUserSelect);
                    }
                });
                function loadEmployeeTasks() {
                    const employee = document.getElementById("employeeDetails").textContent.split("|")[0].trim();
                    getFirebaseData("employeeTasks", (firebaseTasks) => {
                        const tasks = firebaseTasks || [];
                        const tableBody = document.getElementById("employeeTasksTable");
                        if (!tableBody) return;
                        tableBody.innerHTML = "";

                        const employeeTasks = tasks
                            .filter(task => task.employee.trim() === employee.trim())
                            .sort((a, b) => new Date(b.date) - new Date(a.date));

                        if (employeeTasks.length === 0) {
                            tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No tasks assigned</td></tr>';
                            return;
                        }

                        employeeTasks.forEach(task => {
                            const row = document.createElement("tr");
                            row.innerHTML = `
                <td>${task.date}</td>
                <td>${task.day}</td>
                <td>${task.description}</td>
                <td>${task.fileName ? `<button onclick="downloadTaskFile('${task.fileName}', '${task.fileData}')" style="background-color: #1c7593; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">Download</button>` : "No file"}</td>
                <td>
                    <select onchange="updateEmployeeTaskStatus(${task.id}, this.value)" style="padding: 5px; border-radius: 4px; border: 1px solid #ddd;">
                        <option value="Pending" ${task.status === "Pending" ? "selected" : ""}>Pending</option>
                        <option value="Completed" ${task.status === "Completed" ? "selected" : ""}>Completed</option>
                        <option value="Not Achieved" ${task.status === "Not Achieved" ? "selected" : ""}>Not Achieved</option>
                    </select>
                </td>
                <td>
                    <input type="text" value="${task.comment || ""}" 
                        onchange="updateEmployeeTaskComment(${task.id}, this.value)" 
                        placeholder="Add comment here"
                        style="padding: 5px; border-radius: 4px; border: 1px solid #ddd; width: 100%;">
                </td>
                <td></td>
            `;
                            tableBody.appendChild(row);
                        });
                    });
                }
                function updateEmployeeTaskStatus(taskId, status) {
                    getFirebaseData("employeeTasks", (firebaseTasks) => {
                        let tasks = firebaseTasks || JSON.parse(localStorage.getItem("employeeTasks")) || [];
                        const taskIndex = tasks.findIndex((t) => t.id === taskId);
                        if (taskIndex !== -1) {
                            tasks[taskIndex].status = status;
                            tasks[taskIndex].lastModified = new Date().toISOString();
                            if (status === "Not Achieved" && !tasks[taskIndex].comment) {
                                alert(
                                    "Please add Reason explaining why the task was not achieved."
                                );
                            }
                            saveToFirebase("employeeTasks", tasks)
                                .then(() => {
                                    localStorage.setItem(
                                        "employeeTasks",
                                        JSON.stringify(tasks)
                                    );
                                })
                                .catch((error) => {
                                    console.error(
                                        "Error saving task status to Firebase:",
                                        error
                                    );
                                    localStorage.setItem(
                                        "employeeTasks",
                                        JSON.stringify(tasks)
                                    );
                                });
                        }
                    });
                }
                function updateEmployeeTaskComment(taskId, comment) {
                    getFirebaseData("employeeTasks", (firebaseTasks) => {
                        let tasks = firebaseTasks || JSON.parse(localStorage.getItem("employeeTasks")) || [];
                        const taskIndex = tasks.findIndex((t) => t.id === taskId);
                        if (taskIndex !== -1) {
                            tasks[taskIndex].comment = comment;
                            tasks[taskIndex].lastModified = new Date().toISOString();
                            saveToFirebase("employeeTasks", tasks)
                                .then(() => {
                                    localStorage.setItem(
                                        "employeeTasks",
                                        JSON.stringify(tasks)
                                    );
                                })
                                .catch((error) => {
                                    console.error(
                                        "Error saving task comment to Firebase:",
                                        error
                                    );
                                    localStorage.setItem(
                                        "employeeTasks",
                                        JSON.stringify(tasks)
                                    );
                                });
                        }
                    });
                }
                function saveEmployeeTaskChanges(taskId) {
                    getFirebaseData("employeeTasks", (firebaseTasks) => {
                        let tasks =
                            firebaseTasks || JSON.parse(localStorage.getItem("employeeTasks")) || [];
                        const taskIndex = tasks.findIndex((t) => t.id === taskId);
                        if (taskIndex !== -1) {
                            tasks[taskIndex].lastModified = new Date().toISOString();
                            saveToFirebase("employeeTasks", tasks)
                                .then(() => {
                                    localStorage.setItem(
                                        "employeeTasks",
                                        JSON.stringify(tasks)
                                    );
                                    alert("Changes saved successfully!");
                                    loadEmployeeTasks();
                                    if (
                                        document.getElementById("adminPage").style.display !==
                                        "none"
                                    ) {
                                        const selectedUser =
                                            document.getElementById("adminUserSelect").value;
                                        loadAdminTasks(selectedUser);
                                    }
                                })
                                .catch((error) => {
                                    console.error(
                                        "Error saving task changes to Firebase:",
                                        error
                                    );
                                    localStorage.setItem("employeeTasks", JSON.stringify(tasks));
                                    alert("Changes saved locally. There was an issue syncing with the cloud.");
                                    loadEmployeeTasks();
                                    if (
                                        document.getElementById("adminPage").style.display !==
                                        "none"
                                    ) {
                                        const selectedUser =
                                            document.getElementById("adminUserSelect").value;
                                        loadAdminTasks(selectedUser);
                                    }
                                });
                        }
                    });
                }
                function downloadTaskFile(fileName, fileData) {
                    const link = document.createElement("a");
                    link.href = fileData;
                    link.download = fileName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
                
                function loadAttendanceTable() {
                    const employee = document.getElementById("employeeDetails").textContent.split("|")[0].trim();
                    getFirebaseData("attendanceRecords", (firebaseAttendanceRecords) => {
                        let attendanceRecords = firebaseAttendanceRecords || [];
                        
                        // Filter records for current employee
                        const employeeRecords = attendanceRecords.filter(record => record.employee === employee);
                        
                        // Sort records by date in descending order (newest first)
                        employeeRecords.sort((a, b) => new Date(b.date) - new Date(a.date));

                        // Group records by date
                        const groupedRecords = employeeRecords.reduce((acc, record) => {
                            if (!acc[record.date]) {
                                acc[record.date] = {
                                    employee: record.employee,
                                    date: record.date,
                                    day: record.day,
                                    checkIns: [],
                                    checkOuts: [],
                                    lateCheckIns: []
                                };
                            }
                            if (record.checkIn) {
                                if (Array.isArray(record.checkIn)) {
                                    acc[record.date].checkIns.push(...record.checkIn);
                        } else {
                                    acc[record.date].checkIns.push(record.checkIn);
                                }
                            }
                            if (record.checkOut) {
                                if (Array.isArray(record.checkOut)) {
                                    acc[record.date].checkOuts.push(...record.checkOut);
                            } else {
                                    acc[record.date].checkOuts.push(record.checkOut);
                                }
                            }
                            return acc;
                        }, {});

                        // Get late check-ins
                        getFirebaseData("lateCheckIns", (firebaseLateCheckIns) => {
                            const lateCheckIns = firebaseLateCheckIns || [];
                            lateCheckIns.forEach(late => {
                                if (late.employee === employee && groupedRecords[late.date]) {
                                    groupedRecords[late.date].lateCheckIns.push(late.time);
                                }
                            });

                        const tableBody = document.getElementById("attendanceTable");
                            if (!tableBody) return;
                            tableBody.innerHTML = "";

                            // Sort dates in descending order
                            const sortedDates = Object.keys(groupedRecords).sort((a, b) => new Date(b) - new Date(a));

                            sortedDates.forEach(date => {
                                const record = groupedRecords[date];
                                const checkInTimes = record.checkIns.sort((a, b) => new Date(`1970-01-01T${a}`) - new Date(`1970-01-01T${b}`));
                                const checkOutTimes = record.checkOuts.sort((a, b) => new Date(`1970-01-01T${b}`) - new Date(`1970-01-01T${a}`));
                                const lateCheckInTimes = record.lateCheckIns.sort((a, b) => new Date(`1970-01-01T${b}`) - new Date(`1970-01-01T${a}`));

                                const workingHours = calculateWorkingHours(
                                    checkInTimes,
                                    checkOutTimes,
                                    lateCheckInTimes
                                );

                                const row = document.createElement("tr");
                                row.innerHTML = `
                                        <td>${record.date}</td>
                                        <td>${record.day}</td>
                                        <td>
                                        <select class="check-in-select" onchange="updateWorkingHours(this)">
                                            ${checkInTimes.map(time => `<option value="${time}">${time}</option>`).join('')}
                                            </select>
                                        </td>
                                        <td>
                                        <select class="check-out-select" onchange="updateWorkingHours(this)">
                                            ${checkOutTimes.map(time => `<option value="${time}">${time}</option>`).join('')}
                                            </select>
                                        </td>
                                    <td>${lateCheckInTimes[0] || "-"}</td>
                                    <td>${workingHours}</td>
                                `;
                                tableBody.appendChild(row);
                            });
                        });
                    });
                }
                function calculateWorkingHours(checkIn, checkOut, lateCheckIns = []) {
                    if (!checkIn && !checkOut && !lateCheckIns.length) {
                        return "Incomplete";
                    }
                    const checkIns = Array.isArray(checkIn) ? checkIn : checkIn ? [checkIn] : [];
                    const checkOuts = Array.isArray(checkOut) ? checkOut : checkOut ? [checkOut] : [];
                    const lateChecks = Array.isArray(lateCheckIns) ? lateCheckIns : lateCheckIns ? [lateCheckIns] : [];
                    let regularHours = 0;
                    let lateHours = 0;
                    const allCheckIns = [...checkIns].sort((a, b) => timeToMinutes(a) - timeToMinutes(b));
                    const allCheckOuts = [...checkOuts].sort((a, b) => timeToMinutes(a) - timeToMinutes(b));
                    const allLateChecks = [...lateChecks].sort((a, b) => timeToMinutes(a) - timeToMinutes(b));
                    for (let i = 0; i < allCheckOuts.length; i++) {
                        const checkOut = allCheckOuts[i];
                        let foundValidCheckIn = false;
                        const validCheckIn = [...allCheckIns, ...allLateChecks].find(checkIn => {
                            const checkInTime = timeToMinutes(checkIn);
                            const checkOutTime = timeToMinutes(checkOut);
                            return checkInTime < checkOutTime;
                        });

                        if (!validCheckIn) {
                            return "Invalid: Check-out time is earlier than check-in time";
                        }
                    }
                    let remainingCheckOuts = [...allCheckOuts];
                    let processedCheckIns = new Set();
                    for (let i = 0; i < allCheckIns.length; i++) {
                        const currentCheckIn = allCheckIns[i];
                        if (allLateChecks.some(late => Math.abs(timeToMinutes(late) - timeToMinutes(currentCheckIn)) < 5)) {
                            continue;
                        }
                        const matchingCheckOutIndex = remainingCheckOuts.findIndex(
                            out => timeToMinutes(out) > timeToMinutes(currentCheckIn)
                        );
                        if (matchingCheckOutIndex !== -1) {
                            const matchingCheckOut = remainingCheckOuts[matchingCheckOutIndex];
                            let minutesWorked = timeToMinutes(matchingCheckOut) - timeToMinutes(currentCheckIn);
                            regularHours += minutesWorked / 60;
                            processedCheckIns.add(currentCheckIn);
                            remainingCheckOuts.splice(matchingCheckOutIndex, 1);
                        }
                    }
                    for (let i = 0; i < allLateChecks.length; i++) {
                        const lateCheckIn = allLateChecks[i];
                        if (processedCheckIns.has(lateCheckIn)) continue;
                        const matchingCheckOutIndex = remainingCheckOuts.findIndex(
                            out => timeToMinutes(out) > timeToMinutes(lateCheckIn)
                        );
                        if (matchingCheckOutIndex !== -1) {
                            const matchingCheckOut = remainingCheckOuts[matchingCheckOutIndex];
                            let minutesWorked = timeToMinutes(matchingCheckOut) - timeToMinutes(lateCheckIn);
                            lateHours += minutesWorked / 60;
                            remainingCheckOuts.splice(matchingCheckOutIndex, 1);
                        }
                    }
                    const totalHours = regularHours + lateHours;
                    if (totalHours === 0) {
                        return "0h 0m";
                    } else if (regularHours > 0 && lateHours > 0) {
                        return `${formatHours(regularHours)} + ${formatHours(lateHours)} (late) = ${formatHours(totalHours)}`;
                    } else if (regularHours > 0) {
                        return formatHours(regularHours);
                    } else {
                        return `${formatHours(lateHours)} (late)`;
                    }
                }
                function timeToMinutes(timeStr) {
                    if (!timeStr) return 0;
                    const [hours, minutes] = timeStr.split(":").map(Number);
                    return hours * 60 + minutes;
                }
                function formatHours(hours) {
                    const wholeHours = Math.floor(hours);
                    const minutes = Math.round((hours - wholeHours) * 60);
                    return `${wholeHours}h ${minutes}m`;
                }
                function addAttendanceRecord(type) {
                    const now = new Date();
                    const employee = document
                        .getElementById("employeeDetails")
                        .textContent.split("|")[0]
                        .trim();
                    const date = now.toLocaleDateString();
                    const day = [
                        "Sunday",
                        "Monday",
                        "Tuesday",
                        "Wednesday",
                        "Thursday",
                        "Friday",
                        "Saturday",
                    ][now.getDay()];
                    const time = now.toLocaleTimeString();
                    let attendanceRecords =
                        JSON.parse(localStorage.getItem("attendanceRecords")) || [];
                    const recordIndex = attendanceRecords.findIndex(
                        (record) => record.employee === employee && record.date === date
                    );
                    if (recordIndex === -1) {
                        const newRecord = {
                            employee: employee,
                            date: date,
                            day: day,
                        };
                        if (type === "checkIn") {
                            newRecord.checkIn = time;
                        } else if (type === "checkOut") {
                            newRecord.checkOut = time;
                        }
                        attendanceRecords.push(newRecord);
                    } else {
                        if (type === "checkIn") {
                            attendanceRecords[recordIndex].checkIn = time;
                        } else if (type === "checkOut") {
                            if (Array.isArray(attendanceRecords[recordIndex].checkOut)) {
                                attendanceRecords[recordIndex].checkOut.push(time);
                            } else if (attendanceRecords[recordIndex].checkOut) {
                                attendanceRecords[recordIndex].checkOut = [
                                    attendanceRecords[recordIndex].checkOut,
                                    time,
                                ];
                            } else {
                                attendanceRecords[recordIndex].checkOut = time;
                            }
                        }
                    }
                    localStorage.setItem(
                        "attendanceRecords",
                        JSON.stringify(attendanceRecords)
                    );
                    updateSummaryValues();
                }
                function recordMissedCheckIn() {
                    const now = new Date();
                    const employee = document
                        .getElementById("employeeDetails")
                        .textContent.split("|")[0]
                        .trim();
                    const date = now.toLocaleDateString();
                    const day = [
                        "Sunday",
                        "Monday",
                        "Tuesday",
                        "Wednesday",
                        "Thursday",
                        "Friday",
                        "Saturday",
                    ][now.getDay()];
                    let missedCheckIns =
                        JSON.parse(localStorage.getItem("missedCheckIns")) || [];
                    const existingRecord = missedCheckIns.find(
                        (record) => record.employee === employee && record.date === date
                    );
                    if (!existingRecord) {
                        missedCheckIns.push({
                            employee: employee,
                            date: date,
                            day: day,
                            notificationSent: false,
                        });
                        localStorage.setItem(
                            "missedCheckIns",
                            JSON.stringify(missedCheckIns)
                        );
                    }
                }
                function loadEmployeeHolidayRequests() {
                    const employee = document
                        .getElementById("employeeDetails")
                        .textContent.split("|")[0]
                        .trim();
                    const holidayRequests =
                        JSON.parse(localStorage.getItem("holidayRequests")) || [];
                    const tableBody = document.getElementById(
                        "employeeHolidayRequestsTable"
                    );
                    if (!tableBody) return;
                    tableBody.innerHTML = "";
                    const employeeRequests = holidayRequests.filter(
                        (request) =>
                            request.employeeName === employee ||
                            request.employee === employee
                    );
                    if (employeeRequests.length === 0) {
                        const row = document.createElement("tr");
                        row.innerHTML =
                            '<td colspan="5" style="text-align: center;">No holiday requests found</td>';
                        tableBody.appendChild(row);
                        return;
                    }
                    employeeRequests.sort(
                        (a, b) => new Date(b.startDate) - new Date(a.startDate)
                    );
                    employeeRequests.forEach((request) => {
                        const row = document.createElement("tr");
                        row.innerHTML = `
            <td>${request.startDate}</td>
            <td>${request.endDate}</td>
            <td>${request.days || calculateDays(request.startDate, request.endDate)
                            }</td>
            <td>${request.reason}</td>
            <td><span class="status-${request.status}">${(request.status || "Pending").charAt(0).toUpperCase() +
                            (request.status || "pending").slice(1)
                            }</span></td>
        `;
                        tableBody.appendChild(row);
                    });
                }
                function calculateDays(startDate, endDate) {
                    const start = new Date(startDate);
                    const end = new Date(endDate);
                    const diffTime = Math.abs(end - start);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; // +1 to include both start and end days
                    return diffDays;
                }
                function setupDataListeners() {
                    const dataKeys = [
                        "users",
                        "attendanceRecords",
                        "lateCheckIns",
                        "missedCheckIns",
                        "holidayRequests",
                        "progressReports",
                        "timeTables",
                        "employeeTasks",
                        "notifications",
                    ];
                    dataKeys.forEach((key) => {
                        getFirebaseData(key, (data) => {
                            if (data) {
                                localStorage.setItem(key, JSON.stringify(data));
                            }
                        });
                    });
                    listenForChanges("users", (users) => {
                        if (users) {
                            localStorage.setItem("users", JSON.stringify(users));
                            const selectElement =
                                document.getElementById("adminUserSelect");
                            if (selectElement) {
                                while (selectElement.options.length > 1) {
                                    selectElement.remove(1);
                                }
                                Object.keys(users).forEach((username) => {
                                    if (username !== "admin") {
                                        const option = document.createElement("option");
                                        option.value = username;
                                        option.textContent = username;
                                        selectElement.appendChild(option);
                                    }
                                });
                            }
                        }
                    });
                    listenForChanges("attendanceRecords", (attendanceRecords) => {
                        if (attendanceRecords) {
                            localStorage.setItem(
                                "attendanceRecords",
                                JSON.stringify(attendanceRecords)
                            );
                            loadAttendanceTable();
                            updateSummaryValues();
                        }
                    });
                    listenForChanges("lateCheckIns", (lateCheckIns) => {
                        if (lateCheckIns) {
                            localStorage.setItem(
                                "lateCheckIns",
                                JSON.stringify(lateCheckIns)
                            );
                            loadAttendanceTable();
                            updateSummaryValues();
                        }
                    });
                    listenForChanges("missedCheckIns", (missedCheckIns) => {
                        if (missedCheckIns)
                            localStorage.setItem(
                                "missedCheckIns",
                                JSON.stringify(missedCheckIns)
                            );
                    });
                    listenForChanges("holidayRequests", (holidayRequests) => {
                        if (holidayRequests) {
                            localStorage.setItem(
                                "holidayRequests",
                                JSON.stringify(holidayRequests)
                            );
                            loadEmployeeHolidayRequests();
                            loadAdminHolidayRequests();
                        }
                    });
                    listenForChanges("progressReports", (progressReports) => {
                        if (progressReports) {
                            localStorage.setItem(
                                "progressReports",
                                JSON.stringify(progressReports)
                            );
                            loadEmployeeProgress();
                            loadAdminProgressReports();
                        }
                    });
                    listenForChanges("timeTables", (timeTables) => {
                        if (timeTables)
                            localStorage.setItem("timeTables", JSON.stringify(timeTables));
                    });
                    listenForChanges("notifications", (notifications) => {
                        if (notifications)
                            localStorage.setItem(
                                "notifications",
                                JSON.stringify(notifications)
                            );
                    });
                    listenForChanges("employeeTasks", (tasks) => {
                        if (tasks) {
                            localStorage.setItem("employeeTasks", JSON.stringify(tasks));
                            if (
                                document.getElementById("employeePage").style.display !==
                                "none" &&
                                document.getElementById("employeeTasks-section").style
                                    .display === "block"
                            ) {
                                loadEmployeeTasks();
                            }
                            if (
                                document.getElementById("adminPage").style.display !==
                                "none" &&
                                document.getElementById("adminTargets").style.display ===
                                "block"
                            ) {
                                const selectedUser =
                                    document.getElementById("adminUserSelect").value;
                                if (selectedUser) loadAdminTasks(selectedUser);
                            }
                        }
                    });
                }
                window.addEventListener("load", setupDataListeners);
                function closeEditTimeTableModal() {
                    document.getElementById("editTimeTableModal").style.display = "none";
                    document.getElementById("editTimeTableContent").style.display = "none";
                    document.getElementById("modalOverlay").style.display = "none";
                }
                function convertTo24Hour(timeStr) {
                    if (!timeStr) return null;
                    if (
                        !timeStr.toLowerCase().includes("am") &&
                        !timeStr.toLowerCase().includes("pm")
                    ) {
                        return timeStr;
                    }
                    let [time, modifier] = timeStr.split(" ");
                    let [hours, minutes, seconds] = time.split(":");
                    hours = parseInt(hours);
                    minutes = parseInt(minutes);
                    seconds = seconds ? parseInt(seconds) : 0;
                    if (modifier && modifier.toLowerCase() === "pm" && hours < 12) {
                        hours = hours + 12;
                    }
                    if (modifier && modifier.toLowerCase() === "am" && hours === 12) {
                        hours = 0;
                    }
                    return `${hours.toString().padStart(2, "0")}:${minutes
                        .toString()
                        .padStart(2, "0")}${seconds ? ":" + seconds.toString().padStart(2, "0") : ""
                        }`;
                }
                function timeToMinutes(timeStr) {
                    if (!timeStr) return 0;
                    const time24 = convertTo24Hour(timeStr);
                    if (!time24) return 0;
                    const [hours, minutes] = time24.split(":").map(Number);
                    return hours * 60 + minutes;
                }
                function openCompensateHoursModal() {
                    document.getElementById('compensateHoursModal').style.display = 'block';
                }
                function closeCompensateHoursModal() {
                    document.getElementById('compensateHoursModal').style.display = 'none';
                }
                function updateMissedWorkingInfo() {
                    const missedDay = document.getElementById('compensateMissedDay').value;
                    document.getElementById('missedDay').textContent = missedDay.charAt(0).toUpperCase() + missedDay.slice(1);
                }
                function updateCompensateDay() {
                    const compensateDate = document.getElementById('compensateDate').value;
                    if (compensateDate) {
                        const date = new Date(compensateDate);
                        const day = date.toLocaleDateString('en-US', { weekday: 'long' });
                        document.getElementById('compensateDay').value = day;
                    }
                }
                function submitCompensation() {
                    const missedDay = document.getElementById('compensateMissedDay').value;
                    const compensateDate = document.getElementById('compensateDate').value;
                    const checkInTime = document.getElementById('compensateCheckIn').value;
                    const checkOutTime = document.getElementById('compensateCheckOut').value;
                    const reason = document.getElementById('compensateReason').value;
                    if (!missedDay || !compensateDate || !checkInTime || !checkOutTime || !reason) {
                        alert('Please fill in all required fields.');
                        return;
                    }
                    const compensationData = {
                        missedDay,
                        compensateDate,
                        checkInTime,
                        checkOutTime,
                        reason,
                        status: 'Pending',
                        timestamp: new Date().toISOString(),
                    };
                    const compensations = JSON.parse(localStorage.getItem('compensations')) || [];
                    compensations.push(compensationData);
                    localStorage.setItem('compensations', JSON.stringify(compensations));
                    alert('Compensation submitted successfully!');
                    closeCompensateHoursModal();
                }
                function loadWeeklyAttendanceSummary() {
                    getFirebaseData("attendanceRecords", (firebaseAttendanceRecords) => {
                        const attendanceRecords = firebaseAttendanceRecords || JSON.parse(localStorage.getItem("attendanceRecords")) || [];
                        const tableBody = document.getElementById("weeklyAttendanceTable");
                        if (!tableBody) return;
                        while (tableBody.rows.length > 1) { tableBody.deleteRow(1); }
                        const employees = [...new Set(attendanceRecords.map(record => record.employee))];
                        const today = new Date();
                        const weekStart = new Date(today);
                        weekStart.setDate(today.getDate() - today.getDay());
                        employees.forEach(employee => {
                            const row = document.createElement("tr");
                            row.innerHTML = `<td>${employee}</td>`;
                            for (let i = 0; i < 7; i++) {
                                const currentDate = new Date(weekStart);
                                currentDate.setDate(weekStart.getDate() + i);
                                const dateStr = currentDate.toLocaleDateString();
                                const dayStr = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"][i];
                                const record = attendanceRecords.find(r =>
                                    r.employee === employee &&
                                    r.date === dateStr
                                );
                                if (record) {
                                    const checkIn = record.checkIn ?
                                        (Array.isArray(record.checkIn) ? record.checkIn[0] : record.checkIn) :
                                        "-";
                                    const checkOut = record.checkOut ?
                                        (Array.isArray(record.checkOut) ? record.checkOut[0] : record.checkOut) :
                                        "-";
                                    let workingHours = "-";
                                    if (checkIn !== "-" && checkOut !== "-") {
                                        const checkInMinutes = timeToMinutes(checkIn);
                                        const checkOutMinutes = timeToMinutes(checkOut);
                                        const hours = (checkOutMinutes - checkInMinutes) / 60;
                                        workingHours = formatHours(hours);
                                    }

                                    row.innerHTML += `
                                        <td>${checkIn}</td>
                                        <td>${checkOut}</td>
                                        <td>${workingHours}</td>
                                    `;
                                } else {
                                    row.innerHTML += `
                                        <td>-</td>
                                        <td>-</td>
                                        <td>-</td>
                                    `;
                                }
                            }

                            tableBody.appendChild(row);
                        });
                    });
                }
                function downloadWeeklySummary() {
                    const table = document.getElementById("weeklyAttendanceTable");
                    let csv = [];
                    const headers = [];
                    const headerRow = table.rows[0];
                    for (let i = 0; i < headerRow.cells.length; i++) {
                        headers.push(headerRow.cells[i].textContent);
                    }
                    csv.push(headers.join(","));
                    for (let i = 1; i < table.rows.length; i++) {
                        const row = table.rows[i];
                        const rowData = [];
                        for (let j = 0; j < row.cells.length; j++) {
                            rowData.push(row.cells[j].textContent);
                        }
                        csv.push(rowData.join(","));
                    }
                    const csvContent = csv.join("\n");
                    const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
                    const link = document.createElement("a");
                    const url = URL.createObjectURL(blob);
                    link.setAttribute("href", url);
                    link.setAttribute("download", "weekly_attendance_summary.csv");
                    link.style.visibility = "hidden";
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
                function checkAndClearOldTimeTables() {
                    const currentDate = new Date();
                    const weekStart = new Date(currentDate);
                    weekStart.setDate(currentDate.getDate() - (currentDate.getDay() === 0 ? 6 : currentDate.getDay() - 1));
                    weekStart.setHours(0, 0, 0, 0);
                    getFirebaseData("timeTables", (firebaseTimeTables) => {
                        const timeTables = firebaseTimeTables || JSON.parse(localStorage.getItem("timeTables")) || [];
                        let needsUpdate = false;
                        timeTables.forEach((timeTable, index) => {
                            if (timeTable.weekStart) {
                                const savedWeekStart = new Date(timeTable.weekStart);
                                if (savedWeekStart < weekStart) {
                                    timeTables.splice(index, 1);
                                    needsUpdate = true;
                                }
                            }
                        });
                        if (needsUpdate) {
                            saveToFirebase("timeTables", timeTables)
                                .then(() => {
                                    localStorage.setItem("timeTables", JSON.stringify(timeTables));
                                })
                                .catch((error) => {
                                    console.error("Error clearing old time tables:", error);
                                });
                        }
                    });
                }
                window.addEventListener("load", () => {
                    setupDataListeners();
                    checkAndClearOldTimeTables();
                });
                function togglePasswordVisibility() {
                    const passwordInput = document.getElementById('userPassword');
                    const toggleIcon = document.querySelector('.password-toggle i');
                    if (passwordInput.type === 'password') {
                        passwordInput.type = 'text';
                        toggleIcon.classList.remove('fa-eye');
                        toggleIcon.classList.add('fa-eye-slash');
                    } else {
                        passwordInput.type = 'password';
                        toggleIcon.classList.remove('fa-eye-slash');
                        toggleIcon.classList.add('fa-eye');
                    }
                }
                
                function checkTimetable(employee, date, day, time) {
                    // Convert input date to standardized format
                    const standardizedDate = standardizeDate(date);
                    const currentTime = time;
                    
                    getFirebaseData("timeTables", (firebaseTimeTables) => {
                        const timeTables = firebaseTimeTables || JSON.parse(localStorage.getItem("timeTables")) || [];
                        const employeeSchedule = timeTables.find(t => t.employee === employee);
                        
                        if (!employeeSchedule || !employeeSchedule[day.toLowerCase()]?.slots) {
                            return false;
                        }

                        const daySlots = employeeSchedule[day.toLowerCase()].slots;
                        const currentTimeDate = new Date(`1970-01-01T${currentTime}`);
                        
                        // Check all slots for the day
                        for (const slot of daySlots) {
                            const slotStart = new Date(`1970-01-01T${slot.checkIn}`);
                            const slotEnd = new Date(`1970-01-01T${slot.checkOut}`);
                            
                            // More flexible time windows
                            const earlyCheckIn = new Date(slotStart.getTime() - 45 * 60 * 1000);
                            const lateCheckIn = new Date(slotStart.getTime() + 90 * 60 * 1000);
                            
                        if (currentTimeDate >= earlyCheckIn && currentTimeDate <= lateCheckIn) {
                                return true;
                            }
                        }
                        return false;
                    });
                }
                function loadAdminTimeTable(selectedUser = "") {
                    const tableBody = document.getElementById("adminTimeTableBody");
                    if (!tableBody) return;
                    tableBody.innerHTML = "";
                    if (!selectedUser) {
                        const row = document.createElement("tr");
                        row.innerHTML = '<td colspan="4" style="text-align: center;">Please select a user to view their time table</td>';
                        tableBody.appendChild(row);
                        return;
                    }
                    const loadingRow = document.createElement("tr");
                    loadingRow.innerHTML = '<td colspan="4" style="text-align: center;">Loading timetable data...</td>';
                    tableBody.appendChild(loadingRow);
                    getFirebaseData("timeTables", (firebaseTimeTables) => {
                        tableBody.innerHTML = "";
                        if (!firebaseTimeTables || !Array.isArray(firebaseTimeTables)) {
                            const errorRow = document.createElement("tr");
                            errorRow.innerHTML = '<td colspan="4" style="text-align: center;">Error loading timetable data. Please try again.</td>';
                            tableBody.appendChild(errorRow);
                            console.error("Invalid timetable data:", firebaseTimeTables);
                            return;
                        }
                        const timeTable = firebaseTimeTables.find(t => t.employee === selectedUser);
                        if (!timeTable) {
                            const row = document.createElement("tr");
                            row.innerHTML = '<td colspan="4" style="text-align: center;">No time table found for this employee</td>';
                            tableBody.appendChild(row);
                            return;
                        }
                        const days = ["monday", "tuesday", "wednesday", "thursday", "friday", "saturday"];
                        let hasData = false;
                        days.forEach(day => {
                            const slots = timeTable[day]?.slots || [];
                            if (slots.length === 0) {
                                const row = document.createElement("tr");
                                row.innerHTML = `
                                    <td>${day.charAt(0).toUpperCase() + day.slice(1)}</td>
                                    <td>-</td>
                                    <td>-</td>
                                    <td>-</td>
                                `;
                                tableBody.appendChild(row);
                            } else {
                                hasData = true;
                                slots.forEach((slot, index) => {
                                    const row = document.createElement("tr");
                                    const workingHours = calculateWorkingHours([slot.checkIn], [slot.checkOut]);
                                    row.innerHTML = `
                                        <td>${index === 0 ? day.charAt(0).toUpperCase() + day.slice(1) : ""}</td>
                                        <td>${formatTimeToAMPM(slot.checkIn)}</td>
                                        <td>${formatTimeToAMPM(slot.checkOut)}</td>
                                        <td>${workingHours}</td>
                                    `;
                                    tableBody.appendChild(row);
                                });
                            }
                        });
                        const selectedEmployeeName = document.getElementById("selectedEmployeeName");
                        if (selectedEmployeeName) {
                            selectedEmployeeName.textContent = selectedUser;
                        }
                        const editButton = document.querySelector('.edit-timetable-btn');
                        if (editButton) {
                            editButton.style.display = hasData ? 'block' : 'none';
                        }
                    });
                }
                function setupDataListeners() {
                    listenForChanges("timeTables", (timeTables) => {
                        if (timeTables) {
                            localStorage.setItem("timeTables", JSON.stringify(timeTables));
                            const adminTimeTableBody = document.getElementById("adminTimeTableBody");
                            const adminUserSelect = document.getElementById("adminUserSelect");
                            if (adminTimeTableBody && adminUserSelect) {
                                const selectedUser = adminUserSelect.value;
                                if (selectedUser) {
                                    loadAdminTimeTable(selectedUser);
                                }
                            }
                            const timeTableContent = document.getElementById("timeTableContent");
                            if (timeTableContent && timeTableContent.style.display !== "none") {
                                const employee = document.getElementById("employeeDetails").textContent.split("|")[0].trim();
                                if (employee) {
                                    openTimeTableModal();
                                }
                            }
                        }
                    });
                }
                function validateTimeTableData(timeTable) {
                    if (!timeTable || typeof timeTable !== 'object') return false;
                    const requiredFields = ['employee'];
                    for (const field of requiredFields) {
                        if (!(field in timeTable)) return false;
                    }
                    const days = ["monday", "tuesday", "wednesday", "thursday", "friday", "saturday"];
                    let hasValidDay = false;
                    for (const day of days) {
                        if (day in timeTable) {
                            if (!Array.isArray(timeTable[day]?.slots)) return false;
                            for (const slot of timeTable[day].slots) {
                                if (!slot.checkIn || !slot.checkOut) return false;
                            }
                            if (timeTable[day].slots.length > 0) hasValidDay = true;
                        }
                    }
                    return hasValidDay;
                }
                function handleTimeTableSave(timeTables, timeTable, onSuccess, onError) {
                    if (!Array.isArray(timeTables)) {
                        timeTables = [];
                    }
                    if (!validateTimeTableData(timeTable)) {
                        onError(new Error("Invalid timetable data format"));
                        return;
                    }
                    const existingIndex = timeTables.findIndex(t => t.employee === timeTable.employee);
                    if (existingIndex >= 0) {
                        const existingTimeTable = timeTables[existingIndex];
                        const days = ["monday", "tuesday", "wednesday", "thursday", "friday", "saturday"];
                        days.forEach(day => {
                            if (!timeTable[day] && existingTimeTable[day]) {
                                timeTable[day] = existingTimeTable[day];
                            }
                        });
                        timeTables[existingIndex] = {
                            ...existingTimeTable,
                            ...timeTable,
                            lastModified: new Date().toISOString()
                        };
                    } else {
                        timeTables.push({
                            ...timeTable,
                            lastModified: new Date().toISOString()
                        });
                    }
                    saveToFirebase("timeTables", timeTables)
                        .then(() => {
                            onSuccess();
                        })
                        .catch((error) => {
                            console.error("Error saving time table:", error);
                            onError(error);
                        });
                }
                getFirebaseData("users", (firebaseUsers) => {
                    const savedUsers = firebaseUsers || {};
                    const selectElement = document.getElementById("adminUserSelect");
                    if (selectElement) {
                        while (selectElement.options.length > 1) {
                            selectElement.remove(1);
                        }
                        Object.keys(savedUsers).forEach((username) => {
                            if (username !== "admin") {
                                const option = document.createElement("option");
                                option.value = username;
                                option.textContent = username;
                                selectElement.appendChild(option);
                            }
                        });
                    }
                });
                function getTimeSlots(day) {
                    const daySlots = document.getElementById(`${day}Slots`);
                    const slots = [];
                    
                    daySlots.querySelectorAll('.time-slot-row').forEach(row => {
                        const inputs = row.querySelectorAll('input[type="time"]');
                        const checkIn = inputs[0].value;
                        const checkOut = inputs[1].value;
                        
                        if (checkIn && checkOut) {
                            slots.push({ checkIn, checkOut });
                        }
                    });
                    
                    return slots;
                }
                function displayLocalTime(utcTime) {
                    const date = new Date(`1970-01-01T${utcTime}`);
                    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                }
                function loadTimeTable() {
                    const employee = document.getElementById("employeeDetails").textContent.split("|")[0].trim();
                    
                    getFirebaseData("timeTables", (firebaseTimeTables) => {
                        const timeTables = firebaseTimeTables || JSON.parse(localStorage.getItem("timeTables")) || [];
                        const employeeSchedule = timeTables.find(t => t.employee === employee);
                        
                        if (employeeSchedule) {
                            const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
                            days.forEach(day => {
                                const slots = employeeSchedule[day]?.slots || [];
                                const daySlots = document.getElementById(`${day}Slots`);
                                daySlots.innerHTML = '';
                                
                                slots.forEach(slot => {
                                    const row = document.createElement('div');
                                    row.className = 'time-slot-row';
                                    
                                    // Convert UTC times to local time for display
                                    const localCheckIn = displayLocalTime(slot.checkIn);
                                    const localCheckOut = displayLocalTime(slot.checkOut);
                                    
                                    row.innerHTML = `
                                        <input type="time" class="time-input" value="${localCheckIn}" />
                                        <input type="time" class="time-input" value="${localCheckOut}" />
                                        <button class="remove-slot" onclick="removeTimeSlot(this)">Ã—</button>
                                    `;
                                    daySlots.appendChild(row);
                                });
                            });
                        }
                    });
                }
                function filterEmployeeTasks() {
                    const statusFilter = document.getElementById("taskStatusFilter").value;
                    const dateFilter = document.getElementById("taskDateFilter").value;
                    const employee = document.getElementById("employeeDetails").textContent.split("|")[0].trim();
                    
                    getFirebaseData("employeeTasks", (firebaseTasks) => {
                        const tasks = firebaseTasks || [];
                        const tableBody = document.getElementById("employeeTasksTable");
                        if (!tableBody) return;
                        tableBody.innerHTML = "";

                        let filteredTasks = tasks.filter(task => task.employee.trim() === employee.trim());

                        // Apply status filter
                        if (statusFilter !== "all") {
                            filteredTasks = filteredTasks.filter(task => task.status === statusFilter);
                        }

                        // Apply date filter
                        if (dateFilter !== "all") {
                            const today = new Date();
                            today.setHours(0, 0, 0, 0);
                            
                            filteredTasks = filteredTasks.filter(task => {
                                const taskDate = new Date(task.date);
                                taskDate.setHours(0, 0, 0, 0);
                                
                                switch (dateFilter) {
                                    case "today":
                                        return taskDate.getTime() === today.getTime();
                                    case "week":
                                        const weekStart = new Date(today);
                                        weekStart.setDate(today.getDate() - today.getDay());
                                        return taskDate >= weekStart && taskDate <= today;
                                    case "month":
                                        return taskDate.getMonth() === today.getMonth() && 
                                               taskDate.getFullYear() === today.getFullYear();
                                    default:
                                        return true;
                                }
                            });
                        }

                        filteredTasks.sort((a, b) => new Date(b.date) - new Date(a.date));

                        if (filteredTasks.length === 0) {
                            tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No tasks found</td></tr>';
                            return;
                        }

                        filteredTasks.forEach(task => {
                            const row = document.createElement("tr");
                            row.innerHTML = `
                                <td>${task.date}</td>
                                <td>${task.day}</td>
                                <td>${task.description}</td>
                                <td>${task.fileName ? `<button onclick="downloadTaskFile('${task.fileName}', '${task.fileData}')" style="background-color: #1c7593; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">Download</button>` : "No file"}</td>
                                <td>
                                    <select onchange="updateEmployeeTaskStatus(${task.id}, this.value)" style="padding: 5px; border-radius: 4px; border: 1px solid #ddd;">
                                        <option value="Pending" ${task.status === "Pending" ? "selected" : ""}>Pending</option>
                                        <option value="Completed" ${task.status === "Completed" ? "selected" : ""}>Completed</option>
                                        <option value="Not Achieved" ${task.status === "Not Achieved" ? "selected" : ""}>Not Achieved</option>
                                    </select>
                                </td>
                                <td>
                                    <input type="text" value="${task.comment || ""}" 
                                        onchange="updateEmployeeTaskComment(${task.id}, this.value)" 
                                        placeholder="Add comment here"
                                        style="padding: 5px; border-radius: 4px; border: 1px solid #ddd; width: 100%;">
                                </td>
                                <td></td>
                            `;
                            tableBody.appendChild(row);
                        });
                    });
                }
            </script>
        </div>
    </div>
</body>
</html>
